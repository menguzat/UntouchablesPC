import { EventHandler } from './event-handler.js';

/**
 * Set of tag names. Tags are automatically available on {@link Entity} and {@link Asset} as `tags`
 * field.
 *
 * @augments EventHandler
 */
class Tags extends EventHandler {
  /**
   * Create an instance of a Tags.
   *
   * @param {object} [parent] - Parent object who tags belong to.
   */
  constructor(parent) {
    super();
    /** @private */
    this._index = {};
    /** @private */
    this._list = [];
    this._parent = parent;
  }

  /**
   * @event Tags#add
   * @param {string} tag - Name of a tag added to a set.
   * @param {object} parent - Parent object who tags belong to.
   */

  /**
   * @event Tags#remove
   * @param {string} tag - Name of a tag removed from a set.
   * @param {object} parent - Parent object who tags belong to.
   */

  /**
   * Fires when tags have been added or removed. It will fire once on bulk changes, while
   * `add`/`remove` will fire on each tag operation.
   *
   * @event Tags#change
   * @param {object} [parent] - Parent object who tags belong to.
   */

  /**
   * Add a tag, duplicates are ignored. Can be array or comma separated arguments for multiple tags.
   *
   * @param {...*} name - Name of a tag, or array of tags.
   * @returns {boolean} True if any tag were added.
   * @example
   * tags.add('level-1');
   * @example
   * tags.add('ui', 'settings');
   * @example
   * tags.add(['level-2', 'mob']);
   */
  add() {
    let changed = false;
    const tags = this._processArguments(arguments, true);
    if (!tags.length) return changed;
    for (let i = 0; i < tags.length; i++) {
      if (this._index[tags[i]]) continue;
      changed = true;
      this._index[tags[i]] = true;
      this._list.push(tags[i]);
      this.fire('add', tags[i], this._parent);
    }
    if (changed) this.fire('change', this._parent);
    return changed;
  }

  /**
   * Remove tag.
   *
   * @param {...*} name - Name of a tag or array of tags.
   * @returns {boolean} True if any tag were removed.
   * @example
   * tags.remove('level-1');
   * @example
   * tags.remove('ui', 'settings');
   * @example
   * tags.remove(['level-2', 'mob']);
   */
  remove() {
    let changed = false;
    if (!this._list.length) return changed;
    const tags = this._processArguments(arguments, true);
    if (!tags.length) return changed;
    for (let i = 0; i < tags.length; i++) {
      if (!this._index[tags[i]]) continue;
      changed = true;
      delete this._index[tags[i]];
      this._list.splice(this._list.indexOf(tags[i]), 1);
      this.fire('remove', tags[i], this._parent);
    }
    if (changed) this.fire('change', this._parent);
    return changed;
  }

  /**
   * Remove all tags.
   *
   * @example
   * tags.clear();
   */
  clear() {
    if (!this._list.length) return;
    const tags = this._list.slice(0);
    this._list = [];
    this._index = {};
    for (let i = 0; i < tags.length; i++) this.fire('remove', tags[i], this._parent);
    this.fire('change', this._parent);
  }

  /**
   * Check if tags satisfy filters. Filters can be provided by simple name of tag, as well as by
   * array of tags. When an array is provided it will check if tags contain each tag within the
   * array. If any of comma separated argument is satisfied, then it will return true. Any number
   * of combinations are valid, and order is irrelevant.
   *
   * @param {...*} query - Name of a tag or array of tags.
   * @returns {boolean} True if filters are satisfied.
   * @example
   * tags.has('player'); // player
   * @example
   * tags.has('mob', 'player'); // player OR mob
   * @example
   * tags.has(['level-1', 'mob']); // monster AND level-1
   * @example
   * tags.has(['ui', 'settings'], ['ui', 'levels']); // (ui AND settings) OR (ui AND levels)
   */
  has() {
    if (!this._list.length) return false;
    return this._has(this._processArguments(arguments));
  }

  /**
   * @param {string[]|string[][]} tags - Array of tags.
   * @returns {boolean} True if the supplied tags are present.
   * @private
   */
  _has(tags) {
    if (!this._list.length || !tags.length) return false;
    for (let i = 0; i < tags.length; i++) {
      if (tags[i].length === 1) {
        // single occurrence
        if (this._index[tags[i][0]]) return true;
      } else {
        // combined occurrence
        let multiple = true;
        for (let t = 0; t < tags[i].length; t++) {
          if (this._index[tags[i][t]]) continue;
          multiple = false;
          break;
        }
        if (multiple) return true;
      }
    }
    return false;
  }

  /**
   * Returns immutable array of tags.
   *
   * @returns {string[]} Copy of tags array.
   */
  list() {
    return this._list.slice(0);
  }

  /**
   * @param {IArguments} args - Arguments to process.
   * @param {boolean} [flat] - If true, will flatten array of tags. Defaults to false.
   * @returns {string[]|string[][]} Array of tags.
   * @private
   */
  _processArguments(args, flat) {
    const tags = [];
    let tmp = [];
    if (!args || !args.length) return tags;
    for (let i = 0; i < args.length; i++) {
      if (args[i] instanceof Array) {
        if (!flat) tmp = [];
        for (let t = 0; t < args[i].length; t++) {
          if (typeof args[i][t] !== 'string') continue;
          if (flat) {
            tags.push(args[i][t]);
          } else {
            tmp.push(args[i][t]);
          }
        }
        if (!flat && tmp.length) tags.push(tmp);
      } else if (typeof args[i] === 'string') {
        if (flat) {
          tags.push(args[i]);
        } else {
          tags.push([args[i]]);
        }
      }
    }
    return tags;
  }

  /**
   * Number of tags in set.
   *
   * @type {number}
   */
  get size() {
    return this._list.length;
  }
}

export { Tags };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFncy5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvcmUvdGFncy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEhhbmRsZXIgfSBmcm9tICcuL2V2ZW50LWhhbmRsZXIuanMnO1xuXG4vKipcbiAqIFNldCBvZiB0YWcgbmFtZXMuIFRhZ3MgYXJlIGF1dG9tYXRpY2FsbHkgYXZhaWxhYmxlIG9uIHtAbGluayBFbnRpdHl9IGFuZCB7QGxpbmsgQXNzZXR9IGFzIGB0YWdzYFxuICogZmllbGQuXG4gKlxuICogQGF1Z21lbnRzIEV2ZW50SGFuZGxlclxuICovXG5jbGFzcyBUYWdzIGV4dGVuZHMgRXZlbnRIYW5kbGVyIHtcbiAgICAvKiogQHByaXZhdGUgKi9cbiAgICBfaW5kZXggPSB7fTtcblxuICAgIC8qKiBAcHJpdmF0ZSAqL1xuICAgIF9saXN0ID0gW107XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYW4gaW5zdGFuY2Ugb2YgYSBUYWdzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtwYXJlbnRdIC0gUGFyZW50IG9iamVjdCB3aG8gdGFncyBiZWxvbmcgdG8uXG4gICAgICovXG4gICAgY29uc3RydWN0b3IocGFyZW50KSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5fcGFyZW50ID0gcGFyZW50O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBldmVudCBUYWdzI2FkZFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0YWcgLSBOYW1lIG9mIGEgdGFnIGFkZGVkIHRvIGEgc2V0LlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJlbnQgLSBQYXJlbnQgb2JqZWN0IHdobyB0YWdzIGJlbG9uZyB0by5cbiAgICAgKi9cblxuICAgIC8qKlxuICAgICAqIEBldmVudCBUYWdzI3JlbW92ZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0YWcgLSBOYW1lIG9mIGEgdGFnIHJlbW92ZWQgZnJvbSBhIHNldC5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcGFyZW50IC0gUGFyZW50IG9iamVjdCB3aG8gdGFncyBiZWxvbmcgdG8uXG4gICAgICovXG5cbiAgICAvKipcbiAgICAgKiBGaXJlcyB3aGVuIHRhZ3MgaGF2ZSBiZWVuIGFkZGVkIG9yIHJlbW92ZWQuIEl0IHdpbGwgZmlyZSBvbmNlIG9uIGJ1bGsgY2hhbmdlcywgd2hpbGVcbiAgICAgKiBgYWRkYC9gcmVtb3ZlYCB3aWxsIGZpcmUgb24gZWFjaCB0YWcgb3BlcmF0aW9uLlxuICAgICAqXG4gICAgICogQGV2ZW50IFRhZ3MjY2hhbmdlXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtwYXJlbnRdIC0gUGFyZW50IG9iamVjdCB3aG8gdGFncyBiZWxvbmcgdG8uXG4gICAgICovXG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSB0YWcsIGR1cGxpY2F0ZXMgYXJlIGlnbm9yZWQuIENhbiBiZSBhcnJheSBvciBjb21tYSBzZXBhcmF0ZWQgYXJndW1lbnRzIGZvciBtdWx0aXBsZSB0YWdzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHsuLi4qfSBuYW1lIC0gTmFtZSBvZiBhIHRhZywgb3IgYXJyYXkgb2YgdGFncy5cbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBhbnkgdGFnIHdlcmUgYWRkZWQuXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiB0YWdzLmFkZCgnbGV2ZWwtMScpO1xuICAgICAqIEBleGFtcGxlXG4gICAgICogdGFncy5hZGQoJ3VpJywgJ3NldHRpbmdzJyk7XG4gICAgICogQGV4YW1wbGVcbiAgICAgKiB0YWdzLmFkZChbJ2xldmVsLTInLCAnbW9iJ10pO1xuICAgICAqL1xuICAgIGFkZCgpIHtcbiAgICAgICAgbGV0IGNoYW5nZWQgPSBmYWxzZTtcbiAgICAgICAgY29uc3QgdGFncyA9IHRoaXMuX3Byb2Nlc3NBcmd1bWVudHMoYXJndW1lbnRzLCB0cnVlKTtcblxuICAgICAgICBpZiAoIXRhZ3MubGVuZ3RoKVxuICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQ7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YWdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5faW5kZXhbdGFnc1tpXV0pXG4gICAgICAgICAgICAgICAgY29udGludWU7XG5cbiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuXG4gICAgICAgICAgICB0aGlzLl9pbmRleFt0YWdzW2ldXSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLl9saXN0LnB1c2godGFnc1tpXSk7XG5cbiAgICAgICAgICAgIHRoaXMuZmlyZSgnYWRkJywgdGFnc1tpXSwgdGhpcy5fcGFyZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjaGFuZ2VkKVxuICAgICAgICAgICAgdGhpcy5maXJlKCdjaGFuZ2UnLCB0aGlzLl9wYXJlbnQpO1xuXG4gICAgICAgIHJldHVybiBjaGFuZ2VkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSB0YWcuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gey4uLip9IG5hbWUgLSBOYW1lIG9mIGEgdGFnIG9yIGFycmF5IG9mIHRhZ3MuXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYW55IHRhZyB3ZXJlIHJlbW92ZWQuXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiB0YWdzLnJlbW92ZSgnbGV2ZWwtMScpO1xuICAgICAqIEBleGFtcGxlXG4gICAgICogdGFncy5yZW1vdmUoJ3VpJywgJ3NldHRpbmdzJyk7XG4gICAgICogQGV4YW1wbGVcbiAgICAgKiB0YWdzLnJlbW92ZShbJ2xldmVsLTInLCAnbW9iJ10pO1xuICAgICAqL1xuICAgIHJlbW92ZSgpIHtcbiAgICAgICAgbGV0IGNoYW5nZWQgPSBmYWxzZTtcblxuICAgICAgICBpZiAoIXRoaXMuX2xpc3QubGVuZ3RoKVxuICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQ7XG5cbiAgICAgICAgY29uc3QgdGFncyA9IHRoaXMuX3Byb2Nlc3NBcmd1bWVudHMoYXJndW1lbnRzLCB0cnVlKTtcblxuICAgICAgICBpZiAoIXRhZ3MubGVuZ3RoKVxuICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQ7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YWdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuX2luZGV4W3RhZ3NbaV1dKVxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcblxuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2luZGV4W3RhZ3NbaV1dO1xuICAgICAgICAgICAgdGhpcy5fbGlzdC5zcGxpY2UodGhpcy5fbGlzdC5pbmRleE9mKHRhZ3NbaV0pLCAxKTtcblxuICAgICAgICAgICAgdGhpcy5maXJlKCdyZW1vdmUnLCB0YWdzW2ldLCB0aGlzLl9wYXJlbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNoYW5nZWQpXG4gICAgICAgICAgICB0aGlzLmZpcmUoJ2NoYW5nZScsIHRoaXMuX3BhcmVudCk7XG5cbiAgICAgICAgcmV0dXJuIGNoYW5nZWQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFsbCB0YWdzLlxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiB0YWdzLmNsZWFyKCk7XG4gICAgICovXG4gICAgY2xlYXIoKSB7XG4gICAgICAgIGlmICghdGhpcy5fbGlzdC5sZW5ndGgpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY29uc3QgdGFncyA9IHRoaXMuX2xpc3Quc2xpY2UoMCk7XG4gICAgICAgIHRoaXMuX2xpc3QgPSBbXTtcbiAgICAgICAgdGhpcy5faW5kZXggPSB7IH07XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YWdzLmxlbmd0aDsgaSsrKVxuICAgICAgICAgICAgdGhpcy5maXJlKCdyZW1vdmUnLCB0YWdzW2ldLCB0aGlzLl9wYXJlbnQpO1xuXG4gICAgICAgIHRoaXMuZmlyZSgnY2hhbmdlJywgdGhpcy5fcGFyZW50KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiB0YWdzIHNhdGlzZnkgZmlsdGVycy4gRmlsdGVycyBjYW4gYmUgcHJvdmlkZWQgYnkgc2ltcGxlIG5hbWUgb2YgdGFnLCBhcyB3ZWxsIGFzIGJ5XG4gICAgICogYXJyYXkgb2YgdGFncy4gV2hlbiBhbiBhcnJheSBpcyBwcm92aWRlZCBpdCB3aWxsIGNoZWNrIGlmIHRhZ3MgY29udGFpbiBlYWNoIHRhZyB3aXRoaW4gdGhlXG4gICAgICogYXJyYXkuIElmIGFueSBvZiBjb21tYSBzZXBhcmF0ZWQgYXJndW1lbnQgaXMgc2F0aXNmaWVkLCB0aGVuIGl0IHdpbGwgcmV0dXJuIHRydWUuIEFueSBudW1iZXJcbiAgICAgKiBvZiBjb21iaW5hdGlvbnMgYXJlIHZhbGlkLCBhbmQgb3JkZXIgaXMgaXJyZWxldmFudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7Li4uKn0gcXVlcnkgLSBOYW1lIG9mIGEgdGFnIG9yIGFycmF5IG9mIHRhZ3MuXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgZmlsdGVycyBhcmUgc2F0aXNmaWVkLlxuICAgICAqIEBleGFtcGxlXG4gICAgICogdGFncy5oYXMoJ3BsYXllcicpOyAvLyBwbGF5ZXJcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIHRhZ3MuaGFzKCdtb2InLCAncGxheWVyJyk7IC8vIHBsYXllciBPUiBtb2JcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIHRhZ3MuaGFzKFsnbGV2ZWwtMScsICdtb2InXSk7IC8vIG1vbnN0ZXIgQU5EIGxldmVsLTFcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIHRhZ3MuaGFzKFsndWknLCAnc2V0dGluZ3MnXSwgWyd1aScsICdsZXZlbHMnXSk7IC8vICh1aSBBTkQgc2V0dGluZ3MpIE9SICh1aSBBTkQgbGV2ZWxzKVxuICAgICAqL1xuICAgIGhhcygpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9saXN0Lmxlbmd0aClcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICByZXR1cm4gdGhpcy5faGFzKHRoaXMuX3Byb2Nlc3NBcmd1bWVudHMoYXJndW1lbnRzKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtzdHJpbmdbXXxzdHJpbmdbXVtdfSB0YWdzIC0gQXJyYXkgb2YgdGFncy5cbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgc3VwcGxpZWQgdGFncyBhcmUgcHJlc2VudC5cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF9oYXModGFncykge1xuICAgICAgICBpZiAoIXRoaXMuX2xpc3QubGVuZ3RoIHx8ICF0YWdzLmxlbmd0aClcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGlmICh0YWdzW2ldLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIC8vIHNpbmdsZSBvY2N1cnJlbmNlXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2luZGV4W3RhZ3NbaV1bMF1dKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gY29tYmluZWQgb2NjdXJyZW5jZVxuICAgICAgICAgICAgICAgIGxldCBtdWx0aXBsZSA9IHRydWU7XG5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCB0ID0gMDsgdCA8IHRhZ3NbaV0ubGVuZ3RoOyB0KyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2luZGV4W3RhZ3NbaV1bdF1dKVxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICAgICAgbXVsdGlwbGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKG11bHRpcGxlKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGltbXV0YWJsZSBhcnJheSBvZiB0YWdzLlxuICAgICAqXG4gICAgICogQHJldHVybnMge3N0cmluZ1tdfSBDb3B5IG9mIHRhZ3MgYXJyYXkuXG4gICAgICovXG4gICAgbGlzdCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2xpc3Quc2xpY2UoMCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtJQXJndW1lbnRzfSBhcmdzIC0gQXJndW1lbnRzIHRvIHByb2Nlc3MuXG4gICAgICogQHBhcmFtIHtib29sZWFufSBbZmxhdF0gLSBJZiB0cnVlLCB3aWxsIGZsYXR0ZW4gYXJyYXkgb2YgdGFncy4gRGVmYXVsdHMgdG8gZmFsc2UuXG4gICAgICogQHJldHVybnMge3N0cmluZ1tdfHN0cmluZ1tdW119IEFycmF5IG9mIHRhZ3MuXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBfcHJvY2Vzc0FyZ3VtZW50cyhhcmdzLCBmbGF0KSB7XG4gICAgICAgIGNvbnN0IHRhZ3MgPSBbXTtcbiAgICAgICAgbGV0IHRtcCA9IFtdO1xuXG4gICAgICAgIGlmICghYXJncyB8fCAhYXJncy5sZW5ndGgpXG4gICAgICAgICAgICByZXR1cm4gdGFncztcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGlmIChhcmdzW2ldIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWZsYXQpXG4gICAgICAgICAgICAgICAgICAgIHRtcCA9IFtdO1xuXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgdCA9IDA7IHQgPCBhcmdzW2ldLmxlbmd0aDsgdCsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYXJnc1tpXVt0XSAhPT0gJ3N0cmluZycpXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZmxhdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGFncy5wdXNoKGFyZ3NbaV1bdF0pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdG1wLnB1c2goYXJnc1tpXVt0XSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoIWZsYXQgJiYgdG1wLmxlbmd0aClcbiAgICAgICAgICAgICAgICAgICAgdGFncy5wdXNoKHRtcCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmdzW2ldID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIGlmIChmbGF0KSB7XG4gICAgICAgICAgICAgICAgICAgIHRhZ3MucHVzaChhcmdzW2ldKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0YWdzLnB1c2goW2FyZ3NbaV1dKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGFncztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBOdW1iZXIgb2YgdGFncyBpbiBzZXQuXG4gICAgICpcbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIGdldCBzaXplKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fbGlzdC5sZW5ndGg7XG4gICAgfVxufVxuXG5leHBvcnQgeyBUYWdzIH07XG4iXSwibmFtZXMiOlsiVGFncyIsIkV2ZW50SGFuZGxlciIsImNvbnN0cnVjdG9yIiwicGFyZW50IiwiX2luZGV4IiwiX2xpc3QiLCJfcGFyZW50IiwiYWRkIiwiY2hhbmdlZCIsInRhZ3MiLCJfcHJvY2Vzc0FyZ3VtZW50cyIsImFyZ3VtZW50cyIsImxlbmd0aCIsImkiLCJwdXNoIiwiZmlyZSIsInJlbW92ZSIsInNwbGljZSIsImluZGV4T2YiLCJjbGVhciIsInNsaWNlIiwiaGFzIiwiX2hhcyIsIm11bHRpcGxlIiwidCIsImxpc3QiLCJhcmdzIiwiZmxhdCIsInRtcCIsIkFycmF5Iiwic2l6ZSJdLCJtYXBwaW5ncyI6Ijs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNQSxJQUFJLFNBQVNDLFlBQVksQ0FBQztBQU81QjtBQUNKO0FBQ0E7QUFDQTtBQUNBO0VBQ0lDLFdBQVdBLENBQUNDLE1BQU0sRUFBRTtBQUNoQixJQUFBLEtBQUssRUFBRSxDQUFBO0FBWlg7SUFBQSxJQUNBQyxDQUFBQSxNQUFNLEdBQUcsRUFBRSxDQUFBO0FBRVg7SUFBQSxJQUNBQyxDQUFBQSxLQUFLLEdBQUcsRUFBRSxDQUFBO0lBVU4sSUFBSSxDQUFDQyxPQUFPLEdBQUdILE1BQU0sQ0FBQTtBQUN6QixHQUFBOztBQUVBO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7O0FBRUk7QUFDSjtBQUNBO0FBQ0E7QUFDQTs7QUFFSTtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFSTtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDSUksRUFBQUEsR0FBR0EsR0FBRztJQUNGLElBQUlDLE9BQU8sR0FBRyxLQUFLLENBQUE7SUFDbkIsTUFBTUMsSUFBSSxHQUFHLElBQUksQ0FBQ0MsaUJBQWlCLENBQUNDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQTtBQUVwRCxJQUFBLElBQUksQ0FBQ0YsSUFBSSxDQUFDRyxNQUFNLEVBQ1osT0FBT0osT0FBTyxDQUFBO0FBRWxCLElBQUEsS0FBSyxJQUFJSyxDQUFDLEdBQUcsQ0FBQyxFQUFFQSxDQUFDLEdBQUdKLElBQUksQ0FBQ0csTUFBTSxFQUFFQyxD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
