import { Curve } from '../../../core/math/curve.js';
import { CurveSet } from '../../../core/math/curve-set.js';
import { Vec3 } from '../../../core/math/vec3.js';
import { LIGHTTYPE_DIRECTIONAL } from '../../../scene/constants.js';
import { Asset } from '../../asset/asset.js';
import { Component } from '../component.js';
import { ComponentSystem } from '../system.js';
import { ParticleSystemComponent } from './component.js';
import { ParticleSystemComponentData } from './data.js';

const _schema = ['enabled', 'autoPlay', 'numParticles', 'lifetime', 'rate', 'rate2', 'startAngle', 'startAngle2', 'loop', 'preWarm', 'lighting', 'halfLambert', 'intensity', 'depthWrite', 'noFog', 'depthSoftening', 'sort', 'blendType', 'stretch', 'alignToMotion', 'emitterShape', 'emitterExtents', 'emitterExtentsInner', 'emitterRadius', 'emitterRadiusInner', 'initialVelocity', 'wrap', 'wrapBounds', 'localSpace', 'screenSpace', 'colorMapAsset', 'normalMapAsset', 'mesh', 'meshAsset', 'renderAsset', 'orientation', 'particleNormal', 'localVelocityGraph', 'localVelocityGraph2', 'velocityGraph', 'velocityGraph2', 'rotationSpeedGraph', 'rotationSpeedGraph2', 'radialSpeedGraph', 'radialSpeedGraph2', 'scaleGraph', 'scaleGraph2', 'colorGraph', 'colorGraph2', 'alphaGraph', 'alphaGraph2', 'colorMap', 'normalMap', 'animTilesX', 'animTilesY', 'animStartFrame', 'animNumFrames', 'animNumAnimations', 'animIndex', 'randomizeAnimIndex', 'animSpeed', 'animLoop', 'layers'];

/**
 * Allows an Entity to render a particle system.
 *
 * @augments ComponentSystem
 */
class ParticleSystemComponentSystem extends ComponentSystem {
  /**
   * Create a new ParticleSystemComponentSystem.
   *
   * @param {import('../../app-base.js').AppBase} app - The Application.
   * @hideconstructor
   */
  constructor(app) {
    super(app);
    this.id = 'particlesystem';
    this.ComponentType = ParticleSystemComponent;
    this.DataType = ParticleSystemComponentData;
    this.schema = _schema;
    this.propertyTypes = {
      emitterExtents: 'vec3',
      emitterExtentsInner: 'vec3',
      particleNormal: 'vec3',
      wrapBounds: 'vec3',
      localVelocityGraph: 'curveset',
      localVelocityGraph2: 'curveset',
      velocityGraph: 'curveset',
      velocityGraph2: 'curveset',
      colorGraph: 'curveset',
      colorGraph2: 'curveset',
      alphaGraph: 'curve',
      alphaGraph2: 'curve',
      rotationSpeedGraph: 'curve',
      rotationSpeedGraph2: 'curve',
      radialSpeedGraph: 'curve',
      radialSpeedGraph2: 'curve',
      scaleGraph: 'curve',
      scaleGraph2: 'curve'
    };
    this.on('beforeremove', this.onBeforeRemove, this);
    this.app.systems.on('update', this.onUpdate, this);
  }
  initializeComponentData(component, _data, properties) {
    const data = {};
    properties = [];
    const types = this.propertyTypes;

    // we store the mesh asset id as "mesh" (it should be "meshAsset")
    // this re-maps "mesh" into "meshAsset" if it is an asset or an asset id
    if (_data.mesh instanceof Asset || typeof _data.mesh === 'number') {
      // migrate into meshAsset property
      _data.meshAsset = _data.mesh;
      delete _data.mesh;
    }
    for (const prop in _data) {
      if (_data.hasOwnProperty(prop)) {
        properties.push(prop);
        // duplicate input data as we are modifying it
        data[prop] = _data[prop];
      }
      if (types[prop] === 'vec3') {
        if (Array.isArray(data[prop])) {
          data[prop] = new Vec3(data[prop][0], data[prop][1], data[prop][2]);
        }
      } else if (types[prop] === 'curve') {
        if (!(data[prop] instanceof Curve)) {
          const t = data[prop].type;
          data[prop] = new Curve(data[prop].keys);
          data[prop].type = t;
        }
      } else if (types[prop] === 'curveset') {
        if (!(data[prop] instanceof CurveSet)) {
          const t = data[prop].type;
          data[prop] = new CurveSet(data[prop].keys);
          data[prop].type = t;
        }
      }

      // duplicate layer list
      if (data.layers && Array.isArray(data.layers)) {
        data.layers = data.layers.slice(0);
      }
    }
    super.initializeComponentData(component, data, properties);
  }
  cloneComponent(entity, clone) {
    const source = entity.particlesystem.data;
    const schema = this.schema;
    const data = {};
    for (let i = 0, len = schema.length; i < len; i++) {
      const prop = schema[i];
      let sourceProp = source[prop];
      if (sourceProp instanceof Vec3 || sourceProp instanceof Curve || sourceProp instanceof CurveSet) {
        sourceProp = sourceProp.clone();
        data[prop] = sourceProp;
      } else if (prop === 'layers') {
        data.layers = source.layers.slice(0);
      } else {
        if (sourceProp !== null && sourceProp !== undefined) {
          data[prop] = sourceProp;
        }
      }
    }
    return this.addComponent(clone, data);
  }
  onUpdate(dt) {
    const components = this.store;
    let numSteps;
    const stats = this.app.stats.particles;
    for (const id in components) {
      if (components.hasOwnProperty(id)) {
        const component = components[id];
        const entity = component.entity;
        const data = component.data;
        if (data.enabled && entity.enabled) {
          const emitter = entity.particlesystem.emitter;
          if (!(emitter != null && emitter.meshInstance.visible)) continue;

          // Bake ambient and directional lighting into one ambient cube
          // TODO: only do if lighting changed
          // TODO: don't do for every emitter
          if (emitter.lighting) {
            const layers = data.layers;
            let lightCube;
            for (let i = 0; i < layers.length; i++) {
              const layer = this.app.scene.layers.getLayerById(layers[i]);
              if (!layer) continue;
              if (!layer._lightCube) {
                layer._lightCube = new Float32Array(6 * 3);
              }
              lightCube = layer._lightCube;
              for (let j = 0; j < 6; j++) {
                lightCube[j * 3] = this.app.scene.ambientLight.r;
                lightCube[j * 3 + 1] = this.app.scene.ambientLight.g;
                lightCube[j * 3 + 2] = this.app.scene.ambientLight.b;
              }
              const dirs = layer._splitLights[LIGHTTYPE_DIRECTIONAL];
              for (let j = 0; j < dirs.length; j++) {
                for (let c = 0; c < 6; c++) {
                  const weight = Math.max(emitter.lightCubeDir[c].dot(dirs[j]._direction), 0) * dirs[j]._intensity;
                  lightCube[c * 3] += dirs[j]._color.r * weight;
                  lightCube[c * 3 + 1] += dirs[j]._color.g * weight;
                  lightCube[c * 3 + 2] += dirs[j]._color.b * weight;
                }
              }
            }
            emitter.constantLightCube.setValue(lightCube); // ?
          }

          if (!data.paused) {
            emitter.simTime += dt;
            if (emitter.simTime > emitter.fixedTimeStep) {
              numSteps = Math.floor(emitter.simTime / emitter.fixedTimeStep);
              emitter.simTime -= numSteps * emitter.fixedTimeStep;
            }
            if (numSteps) {
              numSteps = Math.min(numSteps, emitter.maxSubSteps);
              for (let i = 0; i < numSteps; i++) {
                emitter.addTime(emitter.fixedTimeStep, false);
              }
              stats._updatesPerFrame += numSteps;
              stats._frameTime += emitter._addTimeTime;
              emitter._addTimeTime = 0;
            }
            emitter.finishFrame();
          }
        }
      }
    }
  }
  onBeforeRemove(entity, component) {
    component.onBeforeRemove();
  }
  destroy() {
    super.destroy();
    this.app.systems.off('update', this.onUpdate, this);
  }
}
Component._buildAccessors(ParticleSystemComponent.prototype, _schema);

export { ParticleSystemComponentSystem };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3lzdGVtLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvZnJhbWV3b3JrL2NvbXBvbmVudHMvcGFydGljbGUtc3lzdGVtL3N5c3RlbS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDdXJ2ZSB9IGZyb20gJy4uLy4uLy4uL2NvcmUvbWF0aC9jdXJ2ZS5qcyc7XG5pbXBvcnQgeyBDdXJ2ZVNldCB9IGZyb20gJy4uLy4uLy4uL2NvcmUvbWF0aC9jdXJ2ZS1zZXQuanMnO1xuaW1wb3J0IHsgVmVjMyB9IGZyb20gJy4uLy4uLy4uL2NvcmUvbWF0aC92ZWMzLmpzJztcblxuaW1wb3J0IHsgTElHSFRUWVBFX0RJUkVDVElPTkFMIH0gZnJvbSAnLi4vLi4vLi4vc2NlbmUvY29uc3RhbnRzLmpzJztcblxuaW1wb3J0IHsgQXNzZXQgfSBmcm9tICcuLi8uLi9hc3NldC9hc3NldC5qcyc7XG5cbmltcG9ydCB7IENvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudC5qcyc7XG5pbXBvcnQgeyBDb21wb25lbnRTeXN0ZW0gfSBmcm9tICcuLi9zeXN0ZW0uanMnO1xuXG5pbXBvcnQgeyBQYXJ0aWNsZVN5c3RlbUNvbXBvbmVudCB9IGZyb20gJy4vY29tcG9uZW50LmpzJztcbmltcG9ydCB7IFBhcnRpY2xlU3lzdGVtQ29tcG9uZW50RGF0YSB9IGZyb20gJy4vZGF0YS5qcyc7XG5cbmNvbnN0IF9zY2hlbWEgPSBbXG4gICAgJ2VuYWJsZWQnLFxuICAgICdhdXRvUGxheScsXG4gICAgJ251bVBhcnRpY2xlcycsXG4gICAgJ2xpZmV0aW1lJyxcbiAgICAncmF0ZScsXG4gICAgJ3JhdGUyJyxcbiAgICAnc3RhcnRBbmdsZScsXG4gICAgJ3N0YXJ0QW5nbGUyJyxcbiAgICAnbG9vcCcsXG4gICAgJ3ByZVdhcm0nLFxuICAgICdsaWdodGluZycsXG4gICAgJ2hhbGZMYW1iZXJ0JyxcbiAgICAnaW50ZW5zaXR5JyxcbiAgICAnZGVwdGhXcml0ZScsXG4gICAgJ25vRm9nJyxcbiAgICAnZGVwdGhTb2Z0ZW5pbmcnLFxuICAgICdzb3J0JyxcbiAgICAnYmxlbmRUeXBlJyxcbiAgICAnc3RyZXRjaCcsXG4gICAgJ2FsaWduVG9Nb3Rpb24nLFxuICAgICdlbWl0dGVyU2hhcGUnLFxuICAgICdlbWl0dGVyRXh0ZW50cycsXG4gICAgJ2VtaXR0ZXJFeHRlbnRzSW5uZXInLFxuICAgICdlbWl0dGVyUmFkaXVzJyxcbiAgICAnZW1pdHRlclJhZGl1c0lubmVyJyxcbiAgICAnaW5pdGlhbFZlbG9jaXR5JyxcbiAgICAnd3JhcCcsXG4gICAgJ3dyYXBCb3VuZHMnLFxuICAgICdsb2NhbFNwYWNlJyxcbiAgICAnc2NyZWVuU3BhY2UnLFxuICAgICdjb2xvck1hcEFzc2V0JyxcbiAgICAnbm9ybWFsTWFwQXNzZXQnLFxuICAgICdtZXNoJyxcbiAgICAnbWVzaEFzc2V0JyxcbiAgICAncmVuZGVyQXNzZXQnLFxuICAgICdvcmllbnRhdGlvbicsXG4gICAgJ3BhcnRpY2xlTm9ybWFsJyxcbiAgICAnbG9jYWxWZWxvY2l0eUdyYXBoJyxcbiAgICAnbG9jYWxWZWxvY2l0eUdyYXBoMicsXG4gICAgJ3ZlbG9jaXR5R3JhcGgnLFxuICAgICd2ZWxvY2l0eUdyYXBoMicsXG4gICAgJ3JvdGF0aW9uU3BlZWRHcmFwaCcsXG4gICAgJ3JvdGF0aW9uU3BlZWRHcmFwaDInLFxuICAgICdyYWRpYWxTcGVlZEdyYXBoJyxcbiAgICAncmFkaWFsU3BlZWRHcmFwaDInLFxuICAgICdzY2FsZUdyYXBoJyxcbiAgICAnc2NhbGVHcmFwaDInLFxuICAgICdjb2xvckdyYXBoJyxcbiAgICAnY29sb3JHcmFwaDInLFxuICAgICdhbHBoYUdyYXBoJyxcbiAgICAnYWxwaGFHcmFwaDInLFxuICAgICdjb2xvck1hcCcsXG4gICAgJ25vcm1hbE1hcCcsXG4gICAgJ2FuaW1UaWxlc1gnLFxuICAgICdhbmltVGlsZXNZJyxcbiAgICAnYW5pbVN0YXJ0RnJhbWUnLFxuICAgICdhbmltTnVtRnJhbWVzJyxcbiAgICAnYW5pbU51bUFuaW1hdGlvbnMnLFxuICAgICdhbmltSW5kZXgnLFxuICAgICdyYW5kb21pemVBbmltSW5kZXgnLFxuICAgICdhbmltU3BlZWQnLFxuICAgICdhbmltTG9vcCcsXG4gICAgJ2xheWVycydcbl07XG5cbi8qKlxuICogQWxsb3dzIGFuIEVudGl0eSB0byByZW5kZXIgYSBwYXJ0aWNsZSBzeXN0ZW0uXG4gKlxuICogQGF1Z21lbnRzIENvbXBvbmVudFN5c3RlbVxuICovXG5jbGFzcyBQYXJ0aWNsZVN5c3RlbUNvbXBvbmVudFN5c3RlbSBleHRlbmRzIENvbXBvbmVudFN5c3RlbSB7XG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IFBhcnRpY2xlU3lzdGVtQ29tcG9uZW50U3lzdGVtLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4uLy4uL2FwcC1iYXNlLmpzJykuQXBwQmFzZX0gYXBwIC0gVGhlIEFwcGxpY2F0aW9uLlxuICAgICAqIEBoaWRlY29uc3RydWN0b3JcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihhcHApIHtcbiAgICAgICAgc3VwZXIoYXBwKTtcblxuICAgICAgICB0aGlzLmlkID0gJ3BhcnRpY2xlc3lzdGVtJztcblxuICAgICAgICB0aGlzLkNvbXBvbmVudFR5cGUgPSBQYXJ0aWNsZVN5c3RlbUNvbXBvbmVudDtcbiAgICAgICAgdGhpcy5EYXRhVHlwZSA9IFBhcnRpY2xlU3lzdGVtQ29tcG9uZW50RGF0YTtcblxuICAgICAgICB0aGlzLnNjaGVtYSA9IF9zY2hlbWE7XG5cbiAgICAgICAgdGhpcy5wcm9wZXJ0eVR5cGVzID0ge1xuICAgICAgICAgICAgZW1pdHRlckV4dGVudHM6ICd2ZWMzJyxcbiAgICAgICAgICAgIGVtaXR0ZXJFeHRlbnRzSW5uZXI6ICd2ZWMzJyxcbiAgICAgICAgICAgIHBhcnRpY2xlTm9ybWFsOiAndmVjMycsXG4gICAgICAgICAgICB3cmFwQm91bmRzOiAndmVjMycsXG4gICAgICAgICAgICBsb2NhbFZlbG9jaXR5R3JhcGg6ICdjdXJ2ZXNldCcsXG4gICAgICAgICAgICBsb2NhbFZlbG9jaXR5R3JhcGgyOiAnY3VydmVzZXQnLFxuICAgICAgICAgICAgdmVsb2NpdHlHcmFwaDogJ2N1cnZlc2V0JyxcbiAgICAgICAgICAgIHZlbG9jaXR5R3JhcGgyOiAnY3VydmVzZXQnLFxuICAgICAgICAgICAgY29sb3JHcmFwaDogJ2N1cnZlc2V0JyxcbiAgICAgICAgICAgIGNvbG9yR3JhcGgyOiAnY3VydmVzZXQnLFxuICAgICAgICAgICAgYWxwaGFHcmFwaDogJ2N1cnZlJyxcbiAgICAgICAgICAgIGFscGhhR3JhcGgyOiAnY3VydmUnLFxuICAgICAgICAgICAgcm90YXRpb25TcGVlZEdyYXBoOiAnY3VydmUnLFxuICAgICAgICAgICAgcm90YXRpb25TcGVlZEdyYXBoMjogJ2N1cnZlJyxcbiAgICAgICAgICAgIHJhZGlhbFNwZWVkR3JhcGg6ICdjdXJ2ZScsXG4gICAgICAgICAgICByYWRpYWxTcGVlZEdyYXBoMjogJ2N1cnZlJyxcbiAgICAgICAgICAgIHNjYWxlR3JhcGg6ICdjdXJ2ZScsXG4gICAgICAgICAgICBzY2FsZUdyYXBoMjogJ2N1cnZlJ1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMub24oJ2JlZm9yZXJlbW92ZScsIHRoaXMub25CZWZvcmVSZW1vdmUsIHRoaXMpO1xuICAgICAgICB0aGlzLmFwcC5zeXN0ZW1zLm9uKCd1cGRhdGUnLCB0aGlzLm9uVXBkYXRlLCB0aGlzKTtcbiAgICB9XG5cbiAgICBpbml0aWFsaXplQ29tcG9uZW50RGF0YShjb21wb25lbnQsIF9kYXRhLCBwcm9wZXJ0aWVzKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSB7fTtcblxuICAgICAgICBwcm9wZXJ0aWVzID0gW107XG4gICAgICAgIGNvbnN0IHR5cGVzID0gdGhpcy5wcm9wZXJ0eVR5cGVzO1xuXG4gICAgICAgIC8vIHdlIHN0b3JlIHRoZSBtZXNoIGFzc2V0IGlkIGFzIFwibWVzaFwiIChpdCBzaG91bGQgYmUgXCJtZXNoQXNzZXRcIilcbiAgICAgICAgLy8gdGhpcyByZS1tYXBzIFwibWVzaFwiIGludG8gXCJtZXNoQXNzZXRcIiBpZiBpdCBpcyBhbiBhc3NldCBvciBhbiBhc3NldCBpZFxuICAgICAgICBpZiAoX2RhdGEubWVzaCBpbnN0YW5jZW9mIEFzc2V0IHx8IHR5cGVvZiBfZGF0YS5tZXNoID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgLy8gbWlncmF0ZSBpbnRvIG1lc2hBc3NldCBwcm9wZXJ0eVxuICAgICAgICAgICAgX2RhdGEubWVzaEFzc2V0ID0gX2RhdGEubWVzaDtcbiAgICAgICAgICAgIGRlbGV0ZSBfZGF0YS5tZXNoO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChjb25zdCBwcm9wIGluIF9kYXRhKSB7XG4gICAgICAgICAgICBpZiAoX2RhdGEuaGFzT3duUHJvcGVydHkocHJvcCkpIHtcbiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzLnB1c2gocHJvcCk7XG4gICAgICAgICAgICAgICAgLy8gZHVwbGljYXRlIGlucHV0IGRhdGEgYXMgd2UgYXJlIG1vZGlmeWluZyBpdFxuICAgICAgICAgICAgICAgIGRhdGFbcHJvcF0gPSBfZGF0YVtwcm9wXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHR5cGVzW3Byb3BdID09PSAndmVjMycpIHtcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhW3Byb3BdKSkge1xuICAgICAgICAgICAgICAgICAgICBkYXRhW3Byb3BdID0gbmV3IFZlYzMoZGF0YVtwcm9wXVswXSwgZGF0YVtwcm9wXVsxXSwgZGF0YVtwcm9wXVsyXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlc1twcm9wXSA9PT0gJ2N1cnZlJykge1xuICAgICAgICAgICAgICAgIGlmICghKGRhdGFbcHJvcF0gaW5zdGFuY2VvZiBDdXJ2ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IGRhdGFbcHJvcF0udHlwZTtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVtwcm9wXSA9IG5ldyBDdXJ2ZShkYXRhW3Byb3BdLmtleXMpO1xuICAgICAgICAgICAgICAgICAgICBkYXRhW3Byb3BdLnR5cGUgPSB0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZXNbcHJvcF0gPT09ICdjdXJ2ZXNldCcpIHtcbiAgICAgICAgICAgICAgICBpZiAoIShkYXRhW3Byb3BdIGluc3RhbmNlb2YgQ3VydmVTZXQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBkYXRhW3Byb3BdLnR5cGU7XG4gICAgICAgICAgICAgICAgICAgIGRhdGFbcHJvcF0gPSBuZXcgQ3VydmVTZXQoZGF0YVtwcm9wXS5rZXlzKTtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVtwcm9wXS50eXBlID0gdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIGR1cGxpY2F0ZSBsYXllciBsaXN0XG4gICAgICAgICAgICBpZiAoZGF0YS5sYXllcnMgJiYgQXJyYXkuaXNBcnJheShkYXRhLmxheWVycykpIHtcbiAgICAgICAgICAgICAgICBkYXRhLmxheWVycyA9IGRhdGEubGF5ZXJzLnNsaWNlKDApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgc3VwZXIuaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEoY29tcG9uZW50LCBkYXRhLCBwcm9wZXJ0aWVzKTtcbiAgICB9XG5cbiAgICBjbG9uZUNvbXBvbmVudChlbnRpdHksIGNsb25lKSB7XG4gICAgICAgIGNvbnN0IHNvdXJjZSA9IGVudGl0eS5wYXJ0aWNsZXN5c3RlbS5kYXRhO1xuICAgICAgICBjb25zdCBzY2hlbWEgPSB0aGlzLnNjaGVtYTtcblxuICAgICAgICBjb25zdCBkYXRhID0ge307XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHNjaGVtYS5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICAgICAgY29uc3QgcHJvcCA9IHNjaGVtYVtpXTtcbiAgICAgICAgICAgIGxldCBzb3VyY2VQcm9wID0gc291cmNlW3Byb3BdO1xuICAgICAgICAgICAgaWYgKHNvdXJjZVByb3AgaW5zdGFuY2VvZiBWZWMzIHx8XG4gICAgICAgICAgICAgICAgc291cmNlUHJvcCBpbnN0YW5jZW9mIEN1cnZlIHx8XG4gICAgICAgICAgICAgICAgc291cmNlUHJvcCBpbnN0YW5jZW9mIEN1cnZlU2V0KSB7XG5cbiAgICAgICAgICAgICAgICBzb3VyY2VQcm9wID0gc291cmNlUHJvcC5jbG9uZSgpO1xuICAgICAgICAgICAgICAgIGRhdGFbcHJvcF0gPSBzb3VyY2VQcm9wO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wID09PSAnbGF5ZXJzJykge1xuICAgICAgICAgICAgICAgIGRhdGEubGF5ZXJzID0gc291cmNlLmxheWVycy5zbGljZSgwKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHNvdXJjZVByb3AgIT09IG51bGwgJiYgc291cmNlUHJvcCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGFbcHJvcF0gPSBzb3VyY2VQcm9wO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmFkZENvbXBvbmVudChjbG9uZSwgZGF0YSk7XG4gICAgfVxuXG4gICAgb25VcGRhdGUoZHQpIHtcbiAgICAgICAgY29uc3QgY29tcG9uZW50cyA9IHRoaXMuc3RvcmU7XG4gICAgICAgIGxldCBudW1TdGVwcztcbiAgICAgICAgY29uc3Qgc3RhdHMgPSB0aGlzLmFwcC5zdGF0cy5wYXJ0aWNsZXM7XG5cbiAgICAgICAgZm9yIChjb25zdCBpZCBpbiBjb21wb25lbnRzKSB7XG4gICAgICAgICAgICBpZiAoY29tcG9uZW50cy5oYXNPd25Qcm9wZXJ0eShpZCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb21wb25lbnQgPSBjb21wb25lbnRzW2lkXTtcbiAgICAgICAgICAgICAgICBjb25zdCBlbnRpdHkgPSBjb21wb25lbnQuZW50aXR5O1xuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBjb21wb25lbnQuZGF0YTtcblxuICAgICAgICAgICAgICAgIGlmIChkYXRhLmVuYWJsZWQgJiYgZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW1pdHRlciA9IGVudGl0eS5wYXJ0aWNsZXN5c3RlbS5lbWl0dGVyO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWVtaXR0ZXI/Lm1lc2hJbnN0YW5jZS52aXNpYmxlKSBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBCYWtlIGFtYmllbnQgYW5kIGRpcmVjdGlvbmFsIGxpZ2h0aW5nIGludG8gb25lIGFtYmllbnQgY3ViZVxuICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBvbmx5IGRvIGlmIGxpZ2h0aW5nIGNoYW5nZWRcbiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogZG9uJ3QgZG8gZm9yIGV2ZXJ5IGVtaXR0ZXJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVtaXR0ZXIubGlnaHRpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxheWVycyA9IGRhdGEubGF5ZXJzO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxpZ2h0Q3ViZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGF5ZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGF5ZXIgPSB0aGlzLmFwcC5zY2VuZS5sYXllcnMuZ2V0TGF5ZXJCeUlkKGxheWVyc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsYXllcikgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxheWVyLl9saWdodEN1YmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGF5ZXIuX2xpZ2h0Q3ViZSA9IG5ldyBGbG9hdDMyQXJyYXkoNiAqIDMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodEN1YmUgPSBsYXllci5fbGlnaHRDdWJlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgNjsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0Q3ViZVtqICogM10gPSB0aGlzLmFwcC5zY2VuZS5hbWJpZW50TGlnaHQucjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHRDdWJlW2ogKiAzICsgMV0gPSB0aGlzLmFwcC5zY2VuZS5hbWJpZW50TGlnaHQuZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHRDdWJlW2ogKiAzICsgMl0gPSB0aGlzLmFwcC5zY2VuZS5hbWJpZW50TGlnaHQuYjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlycyA9IGxheWVyLl9zcGxpdExpZ2h0c1tMSUdIVFRZUEVfRElSRUNUSU9OQUxdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgZGlycy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBjID0gMDsgYyA8IDY7IGMrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd2VpZ2h0ID0gTWF0aC5tYXgoZW1pdHRlci5saWdodEN1YmVEaXJbY10uZG90KGRpcnNbal0uX2RpcmVjdGlvbiksIDApICogZGlyc1tqXS5faW50ZW5zaXR5O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHRDdWJlW2MgKiAzXSArPSBkaXJzW2pdLl9jb2xvci5yICogd2VpZ2h0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHRDdWJlW2MgKiAzICsgMV0gKz0gZGlyc1tqXS5fY29sb3IuZyAqIHdlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0Q3ViZVtjICogMyArIDJdICs9IGRpcnNbal0uX2NvbG9yLmIgKiB3ZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyLmNvbnN0YW50TGlnaHRDdWJlLnNldFZhbHVlKGxpZ2h0Q3ViZSk7IC8vID9cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmICghZGF0YS5wYXVzZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVtaXR0ZXIuc2ltVGltZSArPSBkdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbWl0dGVyLnNpbVRpbWUgPiBlbWl0dGVyLmZpeGVkVGltZVN0ZXApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1TdGVwcyA9IE1hdGguZmxvb3IoZW1pdHRlci5zaW1UaW1lIC8gZW1pdHRlci5maXhlZFRpbWVTdGVwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyLnNpbVRpbWUgLT0gbnVtU3RlcHMgKiBlbWl0dGVyLmZpeGVkVGltZVN0ZXA7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobnVtU3RlcHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1TdGVwcyA9IE1hdGgubWluKG51bVN0ZXBzLCBlbWl0dGVyLm1heFN1YlN0ZXBzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVN0ZXBzOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlci5hZGRUaW1lKGVtaXR0ZXIuZml4ZWRUaW1lU3RlcCwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0cy5fdXBkYXRlc1BlckZyYW1lICs9IG51bVN0ZXBzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRzLl9mcmFtZVRpbWUgKz0gZW1pdHRlci5fYWRkVGltZVRpbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlci5fYWRkVGltZVRpbWUgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlci5maW5pc2hGcmFtZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25CZWZvcmVSZW1vdmUoZW50aXR5LCBjb21wb25lbnQpIHtcbiAgICAgICAgY29tcG9uZW50Lm9uQmVmb3JlUmVtb3ZlKCk7XG4gICAgfVxuXG4gICAgZGVzdHJveSgpIHtcbiAgICAgICAgc3VwZXIuZGVzdHJveSgpO1xuXG4gICAgICAgIHRoaXMuYXBwLnN5c3RlbXMub2ZmKCd1cGRhdGUnLCB0aGlzLm9uVXBkYXRlLCB0aGlzKTtcbiAgICB9XG59XG5cbkNvbXBvbmVudC5fYnVpbGRBY2Nlc3NvcnMoUGFydGljbGVTeXN0ZW1Db21wb25lbnQucHJvdG90eXBlLCBfc2NoZW1hKTtcblxuZXhwb3J0IHsgUGFydGljbGVTeXN0ZW1Db21wb25lbnRTeXN0ZW0gfTtcbiJdLCJuYW1lcyI6WyJfc2NoZW1hIiwiUGFydGljbGVTeXN0ZW1Db21wb25lbnRTeXN0ZW0iLCJDb21wb25lbnRTeXN0ZW0iLCJjb25zdHJ1Y3RvciIsImFwcCIsImlkIiwiQ29tcG9uZW50VHlwZSIsIlBhcnRpY2xlU3lzdGVtQ29tcG9uZW50IiwiRGF0YVR5cGUiLCJQYXJ0aWNsZVN5c3RlbUNvbXBvbmVudERhdGEiLCJzY2hlbWEiLCJwcm9wZXJ0eVR5cGVzIiwiZW1pdHRlckV4dGVudHMiLCJlbWl0dGVyRXh0ZW50c0lubmVyIiwicGFydGljbGVOb3JtYWwiLCJ3cmFwQm91bmRzIiwibG9jYWxWZWxvY2l0eUdyYXBoIiwibG9jYWxWZWxvY2l0eUdyYXBoMiIsInZlbG9jaXR5R3JhcGgiLCJ2ZWxvY2l0eUdyYXBoMiIsImNvbG9yR3JhcGgiLCJjb2xvckdyYXBoMiIsImFscGhhR3JhcGgiLCJhbHBoYUdyYXBoMiIsInJvdGF0aW9uU3BlZWRHcmFwaCIsInJvdGF0aW9uU3BlZWRHcmFwaDIiLCJyYWRpYWxTcGVlZEdyYXBoIiwicmFkaWFsU3BlZWRHcmFwaDIiLCJzY2FsZUdyYXBoIiwic2NhbGVHcmFwaDIiLCJvbiIsIm9uQmVmb3JlUmVtb3ZlIiwic3lzdGVtcyIsIm9uVXBkYXRlIiwiaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEiLCJjb21wb25lbnQiLCJfZGF0YSIsInByb3BlcnRpZXMiLCJkYXRhIiwidHlwZXMiLCJtZXNoIiwiQXNzZXQiLCJtZXNoQXNzZXQiLCJwcm9wIiwiaGFzT3duUHJvcGVydHkiLCJwdXNoIiwiQXJyYXkiLCJpc0FycmF5IiwiVmVjMyIsIkN1cnZlIiwidCIsInR5cGUiLCJrZXlzIiwiQ3VydmVTZXQiLCJsYXllcnMiLCJzbGljZSIsImNsb25lQ29tcG9uZW50IiwiZW50aXR5IiwiY2xvbmUiLCJzb3VyY2UiLCJwYXJ0aWNsZXN5c3RlbSIsImkiLCJsZW4iLCJsZW5ndGgiLCJzb3VyY2VQcm9wIiwidW5kZWZpbmVkIiwiYWRkQ29tcG9uZW50IiwiZHQiLCJjb21wb25lbnRzIiwic3RvcmUiLCJudW1TdGVwcyIsInN0YXRzIiwicGFydGljbGVzIiwiZW5hYmxlZCIsImVtaXR0ZXIiLCJtZXNoSW5zdGFuY2UiLCJ2aXNpYmxlIiwibGlnaHRpbmciLCJsaWdodEN1YmUiLCJsYXllciIsInNjZW5lIiwiZ2V0TGF5ZXJCeUlkIiwiX2xpZ2h0Q3ViZSIsIkZsb2F0MzJBcnJheSIsImoiLCJhbWJpZW50TGlnaHQiLCJyIiwiZyIsImIiLCJkaXJzIiwiX3NwbGl0TGlnaHRzIiwiTElHSFRUWVBFX0RJUkVDVElPTkFMIiwiYyIsIndlaWdodCIsIk1hdGgiLCJtYXgiLCJsaWdodEN1YmVEaXIiLCJkb3QiLCJfZGlyZWN0aW9uIiwiX2ludGVuc2l0eSIsIl9jb2xvciIsImNvbnN0YW50TGlnaHRDdWJlIiwic2V0VmFsdWUiLCJwYXVzZWQiLCJzaW1UaW1lIiwiZml4ZWRUaW1lU3RlcCIsImZsb29yIiwibWluIiwibWF4U3ViU3RlcHMiLCJhZGRUaW1lIiwiX3VwZGF0ZXNQZXJGcmFtZSIsIl9mcmFtZVRpbWUiLCJfYWRkVGltZVRpbWUiLCJmaW5pc2hGcmFtZSIsImRlc3Ryb3kiLCJvZmYiLCJDb21wb25lbnQiLCJfYnVpbGRBY2Nlc3NvcnMiLCJwcm90b3R5cGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFjQSxNQUFNQSxPQUFPLEdBQUcsQ0FDWixTQUFTLEVBQ1QsVUFBVSxFQUNWLGNBQWMsRUFDZCxVQUFVLEVBQ1YsTUFBTSxFQUNOLE9BQU8sRUFDUCxZQUFZLEVBQ1osYUFBYSxFQUNiLE1BQU0sRUFDTixTQUFTLEVBQ1QsVUFBVSxFQUNWLGFBQWEsRUFDYixXQUFXLEVBQ1gsWUFBWSxFQUNaLE9BQU8sRUFDUCxnQkFBZ0IsRUFDaEIsTUFBTSxFQUNOLFdBQVcsRUFDWCxTQUFTLEVBQ1QsZUFBZSxFQUNmLGNBQWMsRUFDZCxnQkFBZ0IsRUFDaEIscUJBQXFCLEVBQ3JCLGVBQWUsRUFDZixvQkFBb0IsRUFDcEIsaUJBQWlCLEVBQ2pCLE1BQU0sRUFDTixZQUFZLEVBQ1osWUFBWSxFQUNaLGFBQWEsRUFDYixlQUFlLEVBQ2YsZ0JBQWdCLEVBQ2hCLE1BQU0sRUFDTixXQUFXLEVBQ1gsYUFBYSxFQUNiLGFBQWEsRUFDYixnQkFBZ0IsRUFDaEIsb0JBQW9CLEVBQ3BCLHFCQUFxQixFQUNyQixlQUFlLEVBQ2YsZ0JBQWdCLEVBQ2hCLG9CQUFvQixFQUNwQixxQkFBcUIsRUFDckIsa0JBQWtCLEVBQ2xCLG1CQUFtQixFQUNuQixZQUFZLEVBQ1osYUFBYSxFQUNiLFlBQVksRUFDWixhQUFhLEVBQ2IsWUFBWSxFQUNaLGFBQWEsRUFDYixVQUFVLEVBQ1YsV0FBVyxFQUNYLFlBQVksRUFDWixZQUFZLEVBQ1osZ0JBQWdCLEVBQ2hCLGVBQWUsRUFDZixtQkFBbUIsRUFDbkIsV0FBVyxFQUNYLG9CQUFvQixFQUNwQixXQUFXLEVBQ1gsVUFBVSxFQUNWLFFBQVEsQ0FDWCxDQUFBOztBQUVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNQyw2QkFBNkIsU0FBU0MsZUFBZSxDQUFDO0FBQ3hEO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNJQyxXQUFXQSxDQUFDQyxHQUFHLEVBQUU7SUFDYixLQUFLLENBQUNBLEdBQUcsQ0FBQyxDQUFBO0lBRVYsSUFBSSxDQUFDQyxFQUFFLEdBQUcsZ0JBQWdCLENBQUE7SUFFMUIsSUFBSSxDQUFDQyxhQUFhLEdBQUdDLHVCQUF1QixDQUFBO0lBQzVDLElBQUksQ0FBQ0MsUUFBUSxHQUFHQywyQkFBMkIsQ0FBQTtJQUUzQyxJQUFJLENBQUNDLE1BQU0sR0FBR1YsT0FBTyxDQUFBO0lBRXJCLElBQUksQ0FBQ1csYUFBYSxHQUFHO0FBQ2pCQyxNQUFBQSxjQUFjLEVBQUUsTUFBTTtBQUN0QkMsTUFBQUEsbUJBQW1CLEVBQUUsTUFBTTtBQUMzQkMsTUFBQUEsY0FBYyxFQUFFLE1BQU07QUFDdEJDLE1BQUFBLFVBQVUsRUFBRSxNQUFNO0FBQ2xCQyxNQUFBQSxrQkFBa0IsRUFBRSxVQUFVO0FBQzlCQyxNQUFBQSxtQkFBbUIsRUFBRSxVQUFVO0FBQy9CQyxNQUFBQSxhQUFhLEVBQUUsVUFBVTtBQUN6QkMsTUFBQUEsY0FBYyxFQUFFLFVBQVU7QUFDMUJDLE1BQUFBLFVBQVUsRUFBRSxVQUFVO0FBQ3RCQyxNQUFBQSxXQUFXLEVBQUUsVUFBVTtBQUN2QkMsTUFBQUEsVUFBVSxFQUFFLE9BQU87QUFDbkJDLE1BQUFBLFdBQVcsRUFBRSxPQUFPO0FBQ3BCQyxNQUFBQSxrQkFBa0IsRUFBRSxPQUFPO0FBQzNCQyxNQUFBQSxtQkFBbUIsRUFBRSxPQUFPO0FBQzVCQyxNQUFBQSxnQkFBZ0IsRUFBRSxPQUFPO0FBQ3pCQyxNQUFBQSxpQkFBaUIsRUFBRSxPQUFPO0FBQzFCQyxNQUFBQSxVQUFVLEVBQUUsT0FBTztBQUNuQkMsTUFBQUEsV0FBVyxFQUFFLE9BQUE7S0FDaEIsQ0FBQTtJQUVELElBQUksQ0FBQ0MsRUFBRSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUNDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQTtBQUNsRCxJQUFBLElBQUksQ0FBQzNCLEdBQUcsQ0FBQzRCLE9BQU8sQ0FBQ0YsRUFBRSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUNHLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQTtBQUN0RCxHQUFBO0FBRUFDLEVBQUFBLHVCQUF1QkEsQ0FBQ0MsU0FBUyxFQUFFQyxLQUFLLEVBQUVDLFVBQVUsRUFBRTtJQUNsRCxNQUFNQyxJQUFJLEdBQUcsRUFBRSxDQUFBO0FBRWZELElBQUFBLFVBQVUsR0FBRyxFQUFFLENBQUE7QUFDZixJQUFBLE1BQU1FLEtBQUssR0FBRyxJQUFJLENBQUM1QixhQUFhLENBQUE7O0FBRWhDO0FBQ0E7QUFDQSxJQUFBLElBQUl5QixLQUFLLENBQUNJLElBQUksWUFBWUMsS0FBSyxJQUFJLE9BQU9MLEtBQUssQ0FBQ0ksSUFBSSxLQUFLLFFBQVEsRUFBRTtBQUMvRDtBQUNBSixNQUFBQSxLQUFLLENBQUNNLFNBQVMsR0FBR04sS0FBSyxDQUFDSSxJQUFJLENBQUE7TUFDNUIsT0FBT0osS0FBSyxDQUFDSSxJQUFJLENBQUE7QUFDckIsS0FBQTtBQUVBLElBQUEsS0FBSyxNQUFNRyxJQUFJLElBQUlQLEtBQUssRUFBRTtBQUN0QixNQUFBLElBQUlBLEtBQUssQ0FBQ1EsY0FBYyxDQUFDRCxJQUFJLENBQUMsRUFBRTtBQUM1Qk4sUUFBQUEsVUFBVSxDQUFDUSxJQUFJLENBQUNGLElBQUksQ0FBQyxDQUFBO0FBQ3JCO0FBQ0FMLFFBQUFBLElBQUksQ0FBQ0ssSUFBSSxDQUFDLEdBQUdQLEtBQUssQ0FBQ08sSUFBSSxDQUFDLENBQUE7QUFDNUIsT0FBQTtBQUVBLE1BQUEsSUFBSUosS0FBSyxDQUFDSSxJQUFJLENBQUMsS0FBSyxNQUFNLEVBQUU7UUFDeEIsSUFBSUcsS0FBSyxDQUFDQyxPQUFPLENBQUNULElBQUksQ0FBQ0ssSUFBSSxDQUFDLENBQUMsRUFBRTtBQUMzQkwsVUFBQUEsSUFBSSxDQUFDSyxJQUFJLENBQUMsR0FBRyxJQUFJSyxJQUFJLENBQUNWLElBQUksQ0FBQ0ssSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUVMLElBQUksQ0FBQ0ssSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUVMLElBQUksQ0FBQ0ssSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUN0RSxTQUFBO09BQ0gsTUFBTSxJQUFJSixLQUFLLENBQUNJLElBQUksQ0FBQyxLQUFLLE9BQU8sRUFBRTtRQUNoQyxJQUFJLEVBQUVMLElBQUksQ0FBQ0ssSUFBSSxDQUFDLFlBQVlNLEtBQUssQ0FBQyxFQUFFO0FBQ2hDLFVBQUEsTUFBTUMsQ0FBQyxHQUFHWixJQUFJLENBQUNLLElBQUksQ0FBQyxDQUFDUSxJQUFJLENBQUE7QUFDekJiLFVBQUFBLElBQUksQ0FBQ0ssSUFBSSxDQUFDLEdBQUcsSUFBSU0sS0FBSyxDQUFDWCxJQUFJLENBQUNLLElBQUksQ0FBQyxDQUFDUyxJQUFJLENBQUMsQ0FBQTtBQUN2Q2QsVUFBQUEsSUFBSSxDQUFDSyxJQUFJLENBQUMsQ0FBQ1EsSUFBSSxHQUFHRCxDQUFDLENBQUE7QUFDdkIsU0FBQTtPQUNILE1BQU0sSUFBSVgsS0FBSyxDQUFDSSxJQUFJLENBQUMsS0FBSyxVQUFVLEVBQUU7UUFDbkMsSUFBSSxFQUFFTCxJQUFJLENBQUNLLElBQUksQ0FBQyxZQUFZVSxRQUFRLENBQUMsRUFBRTtBQUNuQyxVQUFBLE1BQU1ILENBQUMsR0FBR1osSUFBSSxDQUFDSyxJQUFJLENBQUMsQ0FBQ1EsSUFBSSxDQUFBO0FBQ3pCYixVQUFBQSxJQUFJLENBQUNLLElBQUksQ0FBQyxHQUFHLElBQUlVLFFBQVEsQ0FBQ2YsSUFBSSxDQUFDSyxJQUFJLENBQUMsQ0FBQ1MsSUFBSSxDQUFDLENBQUE7QUFDMUNkLFVBQUFBLElBQUksQ0FBQ0ssSUFBSSxDQUFDLENBQUNRLElBQUksR0FBR0QsQ0FBQyxDQUFBO0FBQ3ZCLFNBQUE7QUFDSixPQUFBOztBQUVBO0FBQ0EsTUFBQSxJQUFJWixJQUFJLENBQUNnQixNQUFNLElBQUlSLEtBQUssQ0FBQ0MsT0FBTyxDQUFDVCxJQUFJLENBQUNnQixNQUFNLENBQUMsRUFBRTtRQUMzQ2hCLElBQUksQ0FBQ2dCLE1BQU0sR0FBR2hCLElBQUksQ0FBQ2dCLE1BQU0sQ0FBQ0MsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQ3RDLE9BQUE7QUFDSixLQUFBO0lBRUEsS0FBSyxDQUFDckIsdUJBQXVCLENBQUNDLFNBQVMsRUFBRUcsSUFBSSxFQUFFRCxVQUFVLENBQUMsQ0FBQTtBQUM5RCxHQUFBO0FBRUFtQixFQUFBQSxjQUFjQSxDQUFDQyxNQUFNLEVBQUVDLEtBQUssRUFBRTtBQUMxQixJQUFBLE1BQU1DLE1BQU0sR0FBR0YsTUFBTSxDQUFDRyxjQUFjLENBQUN0QixJQUFJLENBQUE7QUFDekMsSUFBQSxNQUFNNUIsTUFBTSxHQUFHLElBQUksQ0FBQ0EsTUFBTSxDQUFBO0lBRTFCLE1BQU00QixJQUFJLEdBQUcsRUFBRSxDQUFBO0FBRWYsSUFBQSxLQUFLLElBQUl1QixDQUFDLEdBQUcsQ0FBQyxFQUFFQyxHQUFHLEdBQUdwRCxNQUFNLENBQUNxRCxNQUFNLEVBQUVGLENBQUMsR0FBR0MsR0FBRyxFQUFFRCxDQUFDLEVBQUUsRUFBRTtBQUMvQyxNQUFBLE1BQU1sQixJQUFJLEdBQUdqQyxNQUFNLENBQUNtRCxDQUFDLENBQUMsQ0FBQTtBQUN0QixNQUFBLElBQUlHLFVBQVUsR0FBR0wsTUFBTSxDQUFDaEIsSUFBSSxDQUFDLENBQUE7TUFDN0IsSUFBSXFCLFVBQVUsWUFBWWhCLElBQUksSUFDMUJnQixVQUFVLFlBQVlmLEtBQUssSUFDM0JlLFVBQVUsWUFBWVgsUUFBUSxFQUFFO0FBRWhDVyxRQUFBQSxVQUFVLEdBQUdBLFVBQVUsQ0FBQ04sS0FBSyxFQUFFLENBQUE7QUFDL0JwQixRQUFBQSxJQUFJLENBQUNLLElBQUksQ0FBQyxHQUFHcUIsVUFBVSxDQUFBO0FBQzNCLE9BQUMsTUFBTSxJQUFJckIsSUFBSSxLQUFLLFFBQVEsRUFBRTtRQUMxQkwsSUFBSSxDQUFDZ0IsTUFBTSxHQUFHSyxNQUFNLENBQUNMLE1BQU0sQ0FBQ0MsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQ3hDLE9BQUMsTUFBTTtBQUNILFFBQUEsSUFBSVMsVUFBVSxLQUFLLElBQUksSUFBSUEsVUFBVSxLQUFLQyxTQUFTLEVBQUU7QUFDakQzQixVQUFBQSxJQUFJLENBQUNLLElBQUksQ0FBQyxHQUFHcUIsVUFBVSxDQUFBO0FBQzNCLFNBQUE7QUFDSixPQUFBO0FBQ0osS0FBQTtBQUVBLElBQUEsT0FBTyxJQUFJLENBQUNFLFlBQVksQ0FBQ1IsS0FBSyxFQUFFcEIsSUFBSSxDQUFDLENBQUE7QUFDekMsR0FBQTtFQUVBTCxRQUFRQSxDQUFDa0MsRUFBRSxFQUFFO0FBQ1QsSUFBQSxNQUFNQyxVQUFVLEdBQUcsSUFBSSxDQUFDQyxLQUFLLENBQUE7QUFDN0IsSUFBQSxJQUFJQyxRQUFRLENBQUE7SUFDWixNQUFNQyxLQUFLLEdBQUcsSUFBSSxDQUFDbkUsR0FBRyxDQUFDbUUsS0FBSyxDQUFDQyxTQUFTLENBQUE7QUFFdEMsSUFBQSxLQUFLLE1BQU1uRSxFQUFFLElBQUkrRCxVQUFVLEVBQUU7QUFDekIsTUFBQSxJQUFJQSxVQUFVLENBQUN4QixjQUFjLENBQUN2QyxFQUFFLENBQUMsRUFBRTtBQUMvQixRQUFBLE1BQU04QixTQUFTLEdBQUdpQyxVQUFVLENBQUMvRCxFQUFFLENBQUMsQ0FBQTtBQUNoQyxRQUFBLE1BQU1vRCxNQUFNLEdBQUd0QixTQUFTLENBQUNzQixNQUFNLENBQUE7QUFDL0IsUUFBQSxNQUFNbkIsSUFBSSxHQUFHSCxTQUFTLENBQUNHLElBQUksQ0FBQTtBQUUzQixRQUFBLElBQUlBLElBQUksQ0FBQ21DLE9BQU8sSUFBSWhCLE1BQU0sQ0FBQ2dCLE9BQU8sRUFBRTtBQUNoQyxVQUFBLE1BQU1DLE9BQU8sR0FBR2pCLE1BQU0sQ0FBQ0csY0FBYyxDQUFDYyxPQUFPLENBQUE7VUFDN0MsSUFBSSxFQUFDQSxPQUFPLElBQVBBLElBQUFBLElBQUFBLE9BQU8sQ0FBRUMsWUFBWSxDQUFDQyxPQUFPLENBQUUsRUFBQSxTQUFBOztBQUVwQztBQUNBO0FBQ0E7VUFDQSxJQUFJRixPQUFPLENBQUNHLFFBQVEsRUFBRTtBQUNsQixZQUFBLE1BQU12QixNQUFNLEdBQUdoQixJQUFJLENBQUNnQixNQUFNLENBQUE7QUFDMUIsWUFBQSxJQUFJd0IsU0FBUyxDQUFBO0FBQ2IsWUFBQSxLQUFLLElBQUlqQixDQUFDLEdBQUcsQ0FBQyxFQUFFQSxDQUFDLEdBQUdQLE1BQU0sQ0FBQ1MsTUFBTSxFQUFFRixDQUFDLEVBQUUsRUFBRTtBQUNwQyxjQUFBLE1BQU1rQixLQUFLLEdBQUcsSUFBSSxDQUFDM0UsR0FBRyxDQUFDNEUsS0FBSyxDQUFDMUIsTUFBTSxDQUFDMkIsWUFBWSxDQUFDM0IsTUFBTSxDQUFDTyxDQUFDLENBQUMsQ0FBQyxDQUFBO2NBQzNELElBQUksQ0FBQ2tCLEtBQUssRUFBRSxTQUFBO0FBRVosY0FBQSxJQUFJLENBQUNBLEtBQUssQ0FBQ0csVUFBVSxFQUFFO2dCQUNuQkgsS0FBSyxDQUFDRyxVQUFVLEdBQUcsSUFBSUMsWUFBWSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUM5QyxlQUFBO2NBQ0FMLFNBQVMsR0FBR0MsS0FBSyxDQUFDRyxVQUFVLENBQUE7Y0FDNUIsS0FBSyxJQUFJRSxDQUFDLEdBQUcsQ0FBQyxFQUFFQSxDQUFDLEdBQUcsQ0FBQyxFQUFFQSxDQUFDLEVBQUUsRUFBRTtBQUN4Qk4sZ0JBQUFBLFNBQVMsQ0FBQ00sQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQ2hGLEdBQUcsQ0FBQzRFLEtBQUssQ0FBQ0ssWUFBWSxDQUFDQyxDQUFDLENBQUE7QUFDaERSLGdCQUFBQSxTQUFTLENBQUNNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDaEYsR0FBRyxDQUFDNEUsS0FBSyxDQUFDSyxZQUFZLENBQUNFLENBQUMsQ0FBQTtBQUNwRFQsZ0JBQUFBLFNBQVMsQ0FBQ00sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUNoRixHQUFHLENBQUM0RSxLQUFLLENBQUNLLFlBQVksQ0FBQ0csQ0FBQyxDQUFBO0FBQ3hELGVBQUE7QUFDQSxjQUFBLE1BQU1DLElBQUksR0FBR1YsS0FBSyxDQUFDVyxZQUFZLENBQUNDLHFCQUFxQixDQUFDLENBQUE7QUFDdEQsY0FBQSxLQUFLLElBQUlQLENBQUMsR0FBRyxDQUFDLEVBQUVBLENBQUMsR0FBR0ssSUFBSSxDQUFDMUIsTUFBTSxFQUFFcUIsQ0FBQyxFQUFFLEVBQUU7Z0JBQ2xDLEtBQUssSUFBSVEsQ0FBQyxHQUFHLENBQUMsRUFBRUEsQ0FBQyxHQUFHLENBQUMsRUFBRUEsQ0FBQyxFQUFFLEVBQUU7QUFDeEIsa0JBQUEsTUFBTUMsTUFBTSxHQUFHQyxJQUFJLENBQUNDLEdBQUcsQ0FBQ3JCLE9BQU8sQ0FBQ3NCLFlBQVksQ0FBQ0osQ0FBQyxDQUFDLENBQUNLLEdBQUcsQ0FBQ1IsSUFBSSxDQUFDTCxDQUFDLENBQUMsQ0FBQ2MsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUdULElBQUksQ0FBQ0wsQ0FBQyxDQUFDLENBQUNlLFVBQVUsQ0FBQTtBQUNoR3JCLGtCQUFBQSxTQUFTLENBQUNjLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSUgsSUFBSSxDQUFDTCxDQUFDLENBQUMsQ0FBQ2dCLE1BQU0sQ0FBQ2QsQ0FBQyxHQUFHTyxNQUFNLENBQUE7QUFDN0NmLGtCQUFBQSxTQUFTLENBQUNjLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUlILElBQUksQ0FBQ0wsQ0FBQyxDQUFDLENBQUNnQixNQUFNLENBQUNiLENBQUMsR0FBR00sTUFBTSxDQUFBO0FBQ2pEZixrQkFBQUEsU0FBUyxDQUFDYyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJSCxJQUFJLENBQUNMLENBQUMsQ0FBQyxDQUFDZ0IsTUFBTSxDQUFDWixDQUFDLEdBQUdLLE1BQU0sQ0FBQTtBQUNyRCxpQkFBQTtBQUNKLGVBQUE7QUFDSixhQUFBO1lBQ0FuQixPQUFPLENBQUMyQixpQkFBaUIsQ0FBQ0MsUUFBUSxDQUFDeEIsU0FBUyxDQUFDLENBQUM7QUFDbEQsV0FBQTs7QUFFQSxVQUFBLElBQUksQ0FBQ3hDLElBQUksQ0FBQ2lFLE1BQU0sRUFBRTtZQUNkN0IsT0FBTyxDQUFDOEIsT0FBTyxJQUFJckMsRUFBRSxDQUFBO0FBQ3JCLFlBQUEsSUFBSU8sT0FBTyxDQUFDOEIsT0FBTyxHQUFHOUIsT0FBTyxDQUFDK0IsYUFBYSxFQUFFO0FBQ3pDbkMsY0FBQUEsUUFBUSxHQUFHd0IsSUFBSSxDQUFDWSxLQUFLLENBQUNoQyxPQUFPLENBQUM4QixPQUFPLEdBQUc5QixPQUFPLENBQUMrQixhQUFhLENBQUMsQ0FBQTtBQUM5RC9CLGNBQUFBLE9BQU8sQ0FBQzhCLE9BQU8sSUFBSWxDLFFBQVEsR0FBR0ksT0FBTyxDQUFDK0IsYUFBYSxDQUFBO0FBQ3ZELGFBQUE7QUFDQSxZQUFBLElBQUluQyxRQUFRLEVBQUU7Y0FDVkEsUUFBUSxHQUFHd0IsSUFBSSxDQUFDYSxHQUFHLENBQUNyQyxRQUFRLEVBQUVJLE9BQU8sQ0FBQ2tDLFdBQVcsQ0FBQyxDQUFBO2NBQ2xELEtBQUssSUFBSS9DLENBQUMsR0FBRyxDQUFDLEVBQUVBLENBQUMsR0FBR1MsUUFBUSxFQUFFVCxDQUFDLEVBQUUsRUFBRTtnQkFDL0JhLE9BQU8sQ0FBQ21DLE9BQU8sQ0FBQ25DLE9BQU8sQ0FBQytCLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQTtBQUNqRCxlQUFBO2NBQ0FsQyxLQUFLLENBQUN1QyxnQkFBZ0IsSUFBSXhDLFFBQVEsQ0FBQTtBQUNsQ0MsY0FBQUEsS0FBSyxDQUFDd0MsVUFBVSxJQUFJckMsT0FBTyxDQUFDc0MsWUFBWSxDQUFBO2NBQ3hDdEMsT0FBTyxDQUFDc0MsWUFBWSxHQUFHLENBQUMsQ0FBQTtBQUM1QixhQUFBO1lBQ0F0QyxPQUFPLENBQUN1QyxXQUFXLEVBQUUsQ0FBQTtBQUN6QixXQUFBO0FBQ0osU0FBQTtBQUNKLE9BQUE7QUFDSixLQUFBO0FBQ0osR0FBQTtBQUVBbEYsRUFBQUEsY0FBY0EsQ0FBQzBCLE1BQU0sRUFBRXRCLFNBQVMsRUFBRTtJQUM5QkEsU0FBUyxDQUFDSixjQUFjLEVBQUUsQ0FBQTtBQUM5QixHQUFBO0FBRUFtRixFQUFBQSxPQUFPQSxHQUFHO0lBQ04sS0FBSyxDQUFDQSxPQUFPLEVBQUUsQ0FBQTtBQUVmLElBQUEsSUFBSSxDQUFDOUcsR0FBRyxDQUFDNEIsT0FBTyxDQUFDbUYsR0FBRyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUNsRixRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUE7QUFDdkQsR0FBQTtBQUNKLENBQUE7QUFFQW1GLFNBQVMsQ0FBQ0MsZUFBZSxDQUFDOUcsdUJBQXVCLENBQUMrRyxTQUFTLEVBQUV0SCxPQUFPLENBQUM7Ozs7In0=
