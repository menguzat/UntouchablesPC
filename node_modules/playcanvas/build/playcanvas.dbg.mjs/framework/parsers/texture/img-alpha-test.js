import { PIXELFORMAT_RGBA8 } from '../../../platform/graphics/constants.js';
import { RenderTarget } from '../../../platform/graphics/render-target.js';
import { Texture } from '../../../platform/graphics/texture.js';

//
// Current state of ImageBitmap (April 2023):
//
// Chrome MacOS and Android (Pixel 3a and Pixel 7 Pro):
//   Correctly loads PNG alpha and runs faster (significantly so on mobile) than HTMLImageElement.
//
// Firefox MacOS:
//   Correctly loads PNG alpha, but runs significantly slower than HTMLImageElement.
//
// Safari MacOS and iOS (iPhone 8 and iPhone 13 Pro Max):
//   Incorrectly loads PNG alpha and runs significantly slower than HTMLImageElement.
//

// 1x1 png image containing rgba(1, 2, 3, 63)
const pngBytes = new Uint8Array([137, 80, 78, 71, 13, 10, 26, 10, 0, 0, 0, 13, 73, 72, 68, 82, 0, 0, 0, 1, 0, 0, 0, 1, 8, 6, 0, 0, 0, 31, 21, 196, 137, 0, 0, 0, 13, 73, 68, 65, 84, 120, 218, 99, 100, 100, 98, 182, 7, 0, 0, 89, 0, 71, 67, 133, 148, 237, 0, 0, 0, 0, 73, 69, 78, 68, 174, 66, 96, 130]);
const testAlpha = (device, image) => {
  // create the texture
  const texture = new Texture(device, {
    width: 1,
    height: 1,
    format: PIXELFORMAT_RGBA8,
    mipmaps: false,
    levels: [image]
  });

  // read pixels
  const rt = new RenderTarget({
    colorBuffer: texture,
    depth: false
  });
  device.setFramebuffer(rt.impl._glFrameBuffer);
  device.initRenderTarget(rt);
  const data = new Uint8ClampedArray(4);
  device.gl.readPixels(0, 0, 1, 1, device.gl.RGBA, device.gl.UNSIGNED_BYTE, data);
  rt.destroy();
  texture.destroy();
  return data[0] === 1 && data[1] === 2 && data[2] === 3 && data[3] === 63;
};

// Test whether ImageBitmap correctly loads PNG alpha data.
const testImageBitmapAlpha = device => {
  return createImageBitmap(new Blob([pngBytes], {
    type: 'image/png'
  }), {
    premultiplyAlpha: 'none',
    colorSpaceConversion: 'none'
  }).then(image => {
    return testAlpha(device, image);
  }).catch(e => false);
};

// Test whether image element correctly loads PNG alpha data.
const testImgElementAlpha = device => {
  return new Promise((resolve, reject) => {
    const image = new Image();
    image.src = URL.createObjectURL(new Blob([pngBytes]));
    image.onload = () => {
      resolve(testAlpha(device, image));
    };
  });
};
class ImgAlphaTest {
  static run(device) {
    testImageBitmapAlpha(device).then(result => {
      console.log(`imageBitmapIsCorrect=${result}`);
    });
    testImgElementAlpha(device).then(result => {
      console.log(`imgElementIsCorrect=${result}`);
    });
  }
}

export { ImgAlphaTest };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1nLWFscGhhLXRlc3QuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9mcmFtZXdvcmsvcGFyc2Vycy90ZXh0dXJlL2ltZy1hbHBoYS10ZXN0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBJWEVMRk9STUFUX1JHQkE4IH0gZnJvbSAnLi4vLi4vLi4vcGxhdGZvcm0vZ3JhcGhpY3MvY29uc3RhbnRzLmpzJztcbmltcG9ydCB7IFJlbmRlclRhcmdldCB9IGZyb20gJy4uLy4uLy4uL3BsYXRmb3JtL2dyYXBoaWNzL3JlbmRlci10YXJnZXQuanMnO1xuaW1wb3J0IHsgVGV4dHVyZSB9IGZyb20gJy4uLy4uLy4uL3BsYXRmb3JtL2dyYXBoaWNzL3RleHR1cmUuanMnO1xuXG4vL1xuLy8gQ3VycmVudCBzdGF0ZSBvZiBJbWFnZUJpdG1hcCAoQXByaWwgMjAyMyk6XG4vL1xuLy8gQ2hyb21lIE1hY09TIGFuZCBBbmRyb2lkIChQaXhlbCAzYSBhbmQgUGl4ZWwgNyBQcm8pOlxuLy8gICBDb3JyZWN0bHkgbG9hZHMgUE5HIGFscGhhIGFuZCBydW5zIGZhc3RlciAoc2lnbmlmaWNhbnRseSBzbyBvbiBtb2JpbGUpIHRoYW4gSFRNTEltYWdlRWxlbWVudC5cbi8vXG4vLyBGaXJlZm94IE1hY09TOlxuLy8gICBDb3JyZWN0bHkgbG9hZHMgUE5HIGFscGhhLCBidXQgcnVucyBzaWduaWZpY2FudGx5IHNsb3dlciB0aGFuIEhUTUxJbWFnZUVsZW1lbnQuXG4vL1xuLy8gU2FmYXJpIE1hY09TIGFuZCBpT1MgKGlQaG9uZSA4IGFuZCBpUGhvbmUgMTMgUHJvIE1heCk6XG4vLyAgIEluY29ycmVjdGx5IGxvYWRzIFBORyBhbHBoYSBhbmQgcnVucyBzaWduaWZpY2FudGx5IHNsb3dlciB0aGFuIEhUTUxJbWFnZUVsZW1lbnQuXG4vL1xuXG4vLyAxeDEgcG5nIGltYWdlIGNvbnRhaW5pbmcgcmdiYSgxLCAyLCAzLCA2MylcbmNvbnN0IHBuZ0J5dGVzID0gbmV3IFVpbnQ4QXJyYXkoW1xuICAgIDEzNywgODAsIDc4LCA3MSwgMTMsIDEwLCAyNiwgMTAsIDAsIDAsIDAsIDEzLCA3MywgNzIsIDY4LCA4MiwgMCwgMCwgMCwgMSwgMCwgMCwgMCwgMSwgOCwgNiwgMCwgMCwgMCwgMzEsIDIxLFxuICAgIDE5NiwgMTM3LCAwLCAwLCAwLCAxMywgNzMsIDY4LCA2NSwgODQsIDEyMCwgMjE4LCA5OSwgMTAwLCAxMDAsIDk4LCAxODIsIDcsIDAsIDAsIDg5LCAwLCA3MSwgNjcsIDEzMywgMTQ4LCAyMzcsXG4gICAgMCwgMCwgMCwgMCwgNzMsIDY5LCA3OCwgNjgsIDE3NCwgNjYsIDk2LCAxMzBcbl0pO1xuXG5jb25zdCB0ZXN0QWxwaGEgPSAoZGV2aWNlLCBpbWFnZSkgPT4ge1xuICAgIC8vIGNyZWF0ZSB0aGUgdGV4dHVyZVxuICAgIGNvbnN0IHRleHR1cmUgPSBuZXcgVGV4dHVyZShkZXZpY2UsIHtcbiAgICAgICAgd2lkdGg6IDEsXG4gICAgICAgIGhlaWdodDogMSxcbiAgICAgICAgZm9ybWF0OiBQSVhFTEZPUk1BVF9SR0JBOCxcbiAgICAgICAgbWlwbWFwczogZmFsc2UsXG4gICAgICAgIGxldmVsczogW2ltYWdlXVxuICAgIH0pO1xuXG4gICAgLy8gcmVhZCBwaXhlbHNcbiAgICBjb25zdCBydCA9IG5ldyBSZW5kZXJUYXJnZXQoeyBjb2xvckJ1ZmZlcjogdGV4dHVyZSwgZGVwdGg6IGZhbHNlIH0pO1xuICAgIGRldmljZS5zZXRGcmFtZWJ1ZmZlcihydC5pbXBsLl9nbEZyYW1lQnVmZmVyKTtcbiAgICBkZXZpY2UuaW5pdFJlbmRlclRhcmdldChydCk7XG5cbiAgICBjb25zdCBkYXRhID0gbmV3IFVpbnQ4Q2xhbXBlZEFycmF5KDQpO1xuICAgIGRldmljZS5nbC5yZWFkUGl4ZWxzKDAsIDAsIDEsIDEsIGRldmljZS5nbC5SR0JBLCBkZXZpY2UuZ2wuVU5TSUdORURfQllURSwgZGF0YSk7XG5cbiAgICBydC5kZXN0cm95KCk7XG4gICAgdGV4dHVyZS5kZXN0cm95KCk7XG5cbiAgICByZXR1cm4gZGF0YVswXSA9PT0gMSAmJiBkYXRhWzFdID09PSAyICYmIGRhdGFbMl0gPT09IDMgJiYgZGF0YVszXSA9PT0gNjM7XG59O1xuXG4vLyBUZXN0IHdoZXRoZXIgSW1hZ2VCaXRtYXAgY29ycmVjdGx5IGxvYWRzIFBORyBhbHBoYSBkYXRhLlxuY29uc3QgdGVzdEltYWdlQml0bWFwQWxwaGEgPSAoZGV2aWNlKSA9PiB7XG4gICAgcmV0dXJuIGNyZWF0ZUltYWdlQml0bWFwKG5ldyBCbG9iKFtwbmdCeXRlc10sIHtcbiAgICAgICAgdHlwZTogJ2ltYWdlL3BuZydcbiAgICB9KSwge1xuICAgICAgICBwcmVtdWx0aXBseUFscGhhOiAnbm9uZScsXG4gICAgICAgIGNvbG9yU3BhY2VDb252ZXJzaW9uOiAnbm9uZSdcbiAgICB9KVxuICAgICAgICAudGhlbigoaW1hZ2UpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0ZXN0QWxwaGEoZGV2aWNlLCBpbWFnZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChlID0+IGZhbHNlKTtcbn07XG5cbi8vIFRlc3Qgd2hldGhlciBpbWFnZSBlbGVtZW50IGNvcnJlY3RseSBsb2FkcyBQTkcgYWxwaGEgZGF0YS5cbmNvbnN0IHRlc3RJbWdFbGVtZW50QWxwaGEgPSAoZGV2aWNlKSA9PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgaW1hZ2UgPSBuZXcgSW1hZ2UoKTtcbiAgICAgICAgaW1hZ2Uuc3JjID0gVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbcG5nQnl0ZXNdKSk7XG4gICAgICAgIGltYWdlLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgICAgIHJlc29sdmUodGVzdEFscGhhKGRldmljZSwgaW1hZ2UpKTtcbiAgICAgICAgfTtcbiAgICB9KTtcbn07XG5cbmNsYXNzIEltZ0FscGhhVGVzdCB7XG4gICAgc3RhdGljIHJ1bihkZXZpY2UpIHtcbiAgICAgICAgdGVzdEltYWdlQml0bWFwQWxwaGEoZGV2aWNlKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBpbWFnZUJpdG1hcElzQ29ycmVjdD0ke3Jlc3VsdH1gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGVzdEltZ0VsZW1lbnRBbHBoYShkZXZpY2UpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYGltZ0VsZW1lbnRJc0NvcnJlY3Q9JHtyZXN1bHR9YCk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgSW1nQWxwaGFUZXN0IH07XG4iXSwibmFtZXMiOlsicG5nQnl0ZXMiLCJVaW50OEFycmF5IiwidGVzdEFscGhhIiwiZGV2aWNlIiwiaW1hZ2UiLCJ0ZXh0dXJlIiwiVGV4dHVyZSIsIndpZHRoIiwiaGVpZ2h0IiwiZm9ybWF0IiwiUElYRUxGT1JNQVRfUkdCQTgiLCJtaXBtYXBzIiwibGV2ZWxzIiwicnQiLCJSZW5kZXJUYXJnZXQiLCJjb2xvckJ1ZmZlciIsImRlcHRoIiwic2V0RnJhbWVidWZmZXIiLCJpbXBsIiwiX2dsRnJhbWVCdWZmZXIiLCJpbml0UmVuZGVyVGFyZ2V0IiwiZGF0YSIsIlVpbnQ4Q2xhbXBlZEFycmF5IiwiZ2wiLCJyZWFkUGl4ZWxzIiwiUkdCQSIsIlVOU0lHTkVEX0JZVEUiLCJkZXN0cm95IiwidGVzdEltYWdlQml0bWFwQWxwaGEiLCJjcmVhdGVJbWFnZUJpdG1hcCIsIkJsb2IiLCJ0eXBlIiwicHJlbXVsdGlwbHlBbHBoYSIsImNvbG9yU3BhY2VDb252ZXJzaW9uIiwidGhlbiIsImNhdGNoIiwiZSIsInRlc3RJbWdFbGVtZW50QWxwaGEiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIkltYWdlIiwic3JjIiwiVVJMIiwiY3JlYXRlT2JqZWN0VVJMIiwib25sb2FkIiwiSW1nQWxwaGFUZXN0IiwicnVuIiwicmVzdWx0IiwiY29uc29sZSIsImxvZyJdLCJtYXBwaW5ncyI6Ijs7OztBQUlBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBLE1BQU1BLFFBQVEsR0FBRyxJQUFJQyxVQUFVLENBQUMsQ0FDNUIsR0FBRyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUMzRyxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFDN0csQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLENBQy9DLENBQUMsQ0FBQTtBQUVGLE1BQU1DLFNBQVMsR0FBR0EsQ0FBQ0MsTUFBTSxFQUFFQyxLQUFLLEtBQUs7QUFDakM7QUFDQSxFQUFBLE1BQU1DLE9BQU8sR0FBRyxJQUFJQyxPQUFPLENBQUNILE1BQU0sRUFBRTtBQUNoQ0ksSUFBQUEsS0FBSyxFQUFFLENBQUM7QUFDUkMsSUFBQUEsTUFBTSxFQUFFLENBQUM7QUFDVEMsSUFBQUEsTUFBTSxFQUFFQyxpQkFBaUI7QUFDekJDLElBQUFBLE9BQU8sRUFBRSxLQUFLO0lBQ2RDLE1BQU0sRUFBRSxDQUFDUixLQUFLLENBQUE7QUFDbEIsR0FBQyxDQUFDLENBQUE7O0FBRUY7QUFDQSxFQUFBLE1BQU1TLEVBQUUsR0FBRyxJQUFJQyxZQUFZLENBQUM7QUFBRUMsSUFBQUEsV0FBVyxFQUFFVixPQUFPO0FBQUVXLElBQUFBLEtBQUssRUFBRSxLQUFBO0FBQU0sR0FBQyxDQUFDLENBQUE7RUFDbkViLE1BQU0sQ0FBQ2MsY0FBYyxDQUFDSixFQUFFLENBQUNLLElBQUksQ0FBQ0MsY0FBYyxDQUFDLENBQUE7QUFDN0NoQixFQUFBQSxNQUFNLENBQUNpQixnQkFBZ0IsQ0FBQ1AsRUFBRSxDQUFDLENBQUE7QUFFM0IsRUFBQSxNQUFNUSxJQUFJLEdBQUcsSUFBSUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUE7RUFDckNuQixNQUFNLENBQUNvQixFQUFFLENBQUNDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUVyQixNQUFNLENBQUNvQixFQUFFLENBQUNFLElBQUksRUFBRXRCLE1BQU0sQ0FBQ29CLEVBQUUsQ0FBQ0csYUFBYSxFQUFFTCxJQUFJLENBQUMsQ0FBQTtFQUUvRVIsRUFBRSxDQUFDYyxPQUFPLEVBQUUsQ0FBQTtFQUNadEIsT0FBTyxDQUFDc0IsT0FBTyxFQUFFLENBQUE7RUFFakIsT0FBT04sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSUEsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSUEsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSUEsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtBQUM1RSxDQUFDLENBQUE7O0FBRUQ7QUFDQSxNQUFNTyxvQkFBb0IsR0FBSXpCLE1BQU0sSUFBSztFQUNyQyxPQUFPMEIsaUJBQWlCLENBQUMsSUFBSUMsSUFBSSxDQUFDLENBQUM5QixRQUFRLENBQUMsRUFBRTtBQUMxQytCLElBQUFBLElBQUksRUFBRSxXQUFBO0FBQ1YsR0FBQyxDQUFDLEVBQUU7QUFDQUMsSUFBQUEsZ0JBQWdCLEVBQUUsTUFBTTtBQUN4QkMsSUFBQUEsb0JBQW9CLEVBQUUsTUFBQTtBQUMxQixHQUFDLENBQUMsQ0FDR0MsSUFBSSxDQUFFOUIsS0FBSyxJQUFLO0FBQ2IsSUFBQSxPQUFPRixTQUFTLENBQUNDLE1BQU0sRUFBRUMsS0FBSyxDQUFDLENBQUE7QUFDbkMsR0FBQyxDQUFDLENBQ0QrQixLQUFLLENBQUNDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQTtBQUMxQixDQUFDLENBQUE7O0FBRUQ7QUFDQSxNQUFNQyxtQkFBbUIsR0FBSWxDLE1BQU0sSUFBSztBQUNwQyxFQUFBLE9BQU8sSUFBSW1DLE9BQU8sQ0FBQyxDQUFDQyxPQUFPLEVBQUVDLE1BQU0sS0FBSztBQUNwQyxJQUFBLE1BQU1wQyxLQUFLLEdBQUcsSUFBSXFDLEtBQUssRUFBRSxDQUFBO0FBQ3pCckMsSUFBQUEsS0FBSyxDQUFDc0MsR0FBRyxHQUFHQyxHQUFHLENBQUNDLGVBQWUsQ0FBQyxJQUFJZCxJQUFJLENBQUMsQ0FBQzlCLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNyREksS0FBSyxDQUFDeUMsTUFBTSxHQUFHLE1BQU07QUFDakJOLE1BQUFBLE9BQU8sQ0FBQ3JDLFNBQVMsQ0FBQ0MsTUFBTSxFQUFFQyxLQUFLLENBQUMsQ0FBQyxDQUFBO0tBQ3BDLENBQUE7QUFDTCxHQUFDLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQTtBQUVELE1BQU0wQyxZQUFZLENBQUM7RUFDZixPQUFPQyxHQUFHQSxDQUFDNUMsTUFBTSxFQUFFO0FBQ2Z5QixJQUFBQSxvQkFBb0IsQ0FBQ3pCLE1BQU0sQ0FBQyxDQUFDK0IsSUFBSSxDQUFFYyxNQUFNLElBQUs7QUFDMUNDLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBRyxDQUFFLENBQXVCRixxQkFBQUEsRUFBQUEsTUFBTyxFQUFDLENBQUMsQ0FBQTtBQUNqRCxLQUFDLENBQUMsQ0FBQTtBQUVGWCxJQUFBQSxtQkFBbUIsQ0FBQ2xDLE1BQU0sQ0FBQyxDQUFDK0IsSUFBSSxDQUFFYyxNQUFNLElBQUs7QUFDekNDLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBRyxDQUFFLENBQXNCRixvQkFBQUEsRUFBQUEsTUFBTyxFQUFDLENBQUMsQ0FBQTtBQUNoRCxLQUFDLENBQUMsQ0FBQTtBQUNOLEdBQUE7QUFDSjs7OzsifQ==
