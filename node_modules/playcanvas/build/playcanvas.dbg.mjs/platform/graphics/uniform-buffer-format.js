import { Debug } from '../../core/debug.js';
import { math } from '../../core/math/math.js';
import { uniformTypeToName, UNIFORMTYPE_MAT4, UNIFORMTYPE_MAT4ARRAY, UNIFORMTYPE_VEC4, UNIFORMTYPE_VEC4ARRAY, UNIFORMTYPE_VEC3, UNIFORMTYPE_VEC3ARRAY, UNIFORMTYPE_VEC2, UNIFORMTYPE_VEC2ARRAY, UNIFORMTYPE_FLOAT, UNIFORMTYPE_FLOATARRAY, bindGroupNames, UNIFORMTYPE_INT, UNIFORMTYPE_IVEC2, UNIFORMTYPE_IVEC3, UNIFORMTYPE_IVEC4, UNIFORMTYPE_BOOL, UNIFORMTYPE_BVEC2, UNIFORMTYPE_BVEC3, UNIFORMTYPE_BVEC4, UNIFORMTYPE_MAT2, UNIFORMTYPE_MAT3 } from './constants.js';

// map of UNIFORMTYPE_*** to number of 32bit elements
const uniformTypeToNumElements = [];
uniformTypeToNumElements[UNIFORMTYPE_FLOAT] = 1;
uniformTypeToNumElements[UNIFORMTYPE_VEC2] = 2;
uniformTypeToNumElements[UNIFORMTYPE_VEC3] = 3;
uniformTypeToNumElements[UNIFORMTYPE_VEC4] = 4;
uniformTypeToNumElements[UNIFORMTYPE_INT] = 1;
uniformTypeToNumElements[UNIFORMTYPE_IVEC2] = 2;
uniformTypeToNumElements[UNIFORMTYPE_IVEC3] = 3;
uniformTypeToNumElements[UNIFORMTYPE_IVEC4] = 4;
uniformTypeToNumElements[UNIFORMTYPE_BOOL] = 1;
uniformTypeToNumElements[UNIFORMTYPE_BVEC2] = 2;
uniformTypeToNumElements[UNIFORMTYPE_BVEC3] = 3;
uniformTypeToNumElements[UNIFORMTYPE_BVEC4] = 4;
uniformTypeToNumElements[UNIFORMTYPE_MAT2] = 8; // 2 x vec4
uniformTypeToNumElements[UNIFORMTYPE_MAT3] = 12; // 3 x vec4
uniformTypeToNumElements[UNIFORMTYPE_MAT4] = 16; // 4 x vec4

/**
 * A class storing description of an individual uniform, stored inside a uniform buffer.
 *
 * @ignore
 */
class UniformFormat {
  constructor(name, type, count = 0) {
    /** @type {string} */
    this.name = void 0;
    // UNIFORMTYPE_***
    /** @type {number} */
    this.type = void 0;
    /** @type {number} */
    this.byteSize = void 0;
    /**
     * Index of the uniform in an array of 32bit values (Float32Array and similar)
     *
     * @type {number}
     */
    this.offset = void 0;
    /** @type {import('./scope-id.js').ScopeId} */
    this.scopeId = void 0;
    /**
     * Count of elements for arrays, otherwise 0.
     *
     * @type {number}
     */
    this.count = void 0;
    // just a name
    this.shortName = name;

    // name with [0] if this is an array
    this.name = count ? `${name}[0]` : name;
    this.type = type;
    this.updateType = type;
    if (count) {
      switch (type) {
        case UNIFORMTYPE_FLOAT:
          this.updateType = UNIFORMTYPE_FLOATARRAY;
          break;
        case UNIFORMTYPE_VEC2:
          this.updateType = UNIFORMTYPE_VEC2ARRAY;
          break;
        case UNIFORMTYPE_VEC3:
          this.updateType = UNIFORMTYPE_VEC3ARRAY;
          break;
        case UNIFORMTYPE_VEC4:
          this.updateType = UNIFORMTYPE_VEC4ARRAY;
          break;
        case UNIFORMTYPE_MAT4:
          this.updateType = UNIFORMTYPE_MAT4ARRAY;
          break;
        default:
          Debug.error(`Uniform array of type ${uniformTypeToName[type]} is not supported when processing uniform '${name}'.`);
          Debug.call(() => {
            this.invalid = true;
          });
          break;
      }
    }
    this.count = count;
    Debug.assert(!isNaN(count), `Unsupported uniform: ${name}[${count}]`);
    Debug.call(() => {
      if (isNaN(count)) this.invalid = true;
    });
    let elementSize = uniformTypeToNumElements[type];
    Debug.assert(elementSize, `Unhandled uniform format ${type} used for ${name}`);

    // element size for arrays is aligned up to vec4
    if (count) elementSize = math.roundUp(elementSize, 4);
    this.byteSize = elementSize * 4;
    if (count) this.byteSize *= count;
    Debug.assert(this.byteSize, `Unknown byte size for uniform format ${type} used for ${name}`);
  }

  // std140 rules: https://registry.khronos.org/OpenGL/specs/gl/glspec45.core.pdf#page=159
  // TODO: this support limited subset of functionality, arrays and structs are not supported.
  calculateOffset(offset) {
    // Note: vec3 has the same alignment as vec4
    let alignment = this.byteSize <= 8 ? this.byteSize : 16;

    // arrays have vec4 alignments
    if (this.count) alignment = 16;

    // align the start offset
    offset = math.roundUp(offset, alignment);
    this.offset = offset / 4;
  }
}

/**
 * A descriptor that defines the layout of of data inside the {@link UniformBuffer}.
 *
 * @ignore
 */
class UniformBufferFormat {
  /**
   * Create a new UniformBufferFormat instance.
   *
   * @param {import('./graphics-device.js').GraphicsDevice} graphicsDevice - The graphics device.
   * @param {UniformFormat[]} uniforms - An array of uniforms to be stored in the buffer
   */
  constructor(graphicsDevice, uniforms) {
    /** @type {number} */
    this.byteSize = 0;
    /** @type {Map<string,UniformFormat>} */
    this.map = new Map();
    this.scope = graphicsDevice.scope;

    /** @type {UniformFormat[]} */
    this.uniforms = uniforms;

    // TODO: optimize uniforms ordering

    let offset = 0;
    for (let i = 0; i < uniforms.length; i++) {
      const uniform = uniforms[i];
      uniform.calculateOffset(offset);
      offset = uniform.offset * 4 + uniform.byteSize;
      uniform.scopeId = this.scope.resolve(uniform.name);
      this.map.set(uniform.name, uniform);
    }

    // round up buffer size
    this.byteSize = math.roundUp(offset, 16);
  }

  /**
   * Returns format of a uniform with specified name.
   *
   * @param {string} name - The name of the uniform.
   * @returns {UniformFormat} - The format of the uniform.
   */
  get(name) {
    return this.map.get(name);
  }
  getShaderDeclaration(bindGroup, bindIndex) {
    const name = bindGroupNames[bindGroup];
    let code = `layout(set = ${bindGroup}, binding = ${bindIndex}, std140) uniform ub_${name} {\n`;
    this.uniforms.forEach(uniform => {
      const typeString = uniformTypeToName[uniform.type];
      Debug.assert(typeString.length > 0, `Uniform type ${uniform.type} is not handled.`);
      code += `    ${typeString} ${uniform.shortName}${uniform.count ? `[${uniform.count}]` : ''};\n`;
    });
    return code + '};\n';
  }
}

export { UniformBufferFormat, UniformFormat };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidW5pZm9ybS1idWZmZXItZm9ybWF0LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvcGxhdGZvcm0vZ3JhcGhpY3MvdW5pZm9ybS1idWZmZXItZm9ybWF0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERlYnVnIH0gZnJvbSAnLi4vLi4vY29yZS9kZWJ1Zy5qcyc7XG5pbXBvcnQgeyBtYXRoIH0gZnJvbSAnLi4vLi4vY29yZS9tYXRoL21hdGguanMnO1xuaW1wb3J0IHtcbiAgICB1bmlmb3JtVHlwZVRvTmFtZSwgYmluZEdyb3VwTmFtZXMsXG4gICAgVU5JRk9STVRZUEVfQk9PTCwgVU5JRk9STVRZUEVfSU5ULCBVTklGT1JNVFlQRV9GTE9BVCwgVU5JRk9STVRZUEVfVkVDMiwgVU5JRk9STVRZUEVfVkVDMyxcbiAgICBVTklGT1JNVFlQRV9WRUM0LCBVTklGT1JNVFlQRV9JVkVDMiwgVU5JRk9STVRZUEVfSVZFQzMsIFVOSUZPUk1UWVBFX0lWRUM0LCBVTklGT1JNVFlQRV9CVkVDMixcbiAgICBVTklGT1JNVFlQRV9CVkVDMywgVU5JRk9STVRZUEVfQlZFQzQsIFVOSUZPUk1UWVBFX01BVDQsIFVOSUZPUk1UWVBFX01BVDIsIFVOSUZPUk1UWVBFX01BVDMsXG4gICAgVU5JRk9STVRZUEVfRkxPQVRBUlJBWSwgVU5JRk9STVRZUEVfVkVDMkFSUkFZLCBVTklGT1JNVFlQRV9WRUMzQVJSQVksIFVOSUZPUk1UWVBFX1ZFQzRBUlJBWSxcbiAgICBVTklGT1JNVFlQRV9NQVQ0QVJSQVlcbn0gZnJvbSAnLi9jb25zdGFudHMuanMnO1xuXG4vLyBtYXAgb2YgVU5JRk9STVRZUEVfKioqIHRvIG51bWJlciBvZiAzMmJpdCBlbGVtZW50c1xuY29uc3QgdW5pZm9ybVR5cGVUb051bUVsZW1lbnRzID0gW107XG51bmlmb3JtVHlwZVRvTnVtRWxlbWVudHNbVU5JRk9STVRZUEVfRkxPQVRdID0gMTtcbnVuaWZvcm1UeXBlVG9OdW1FbGVtZW50c1tVTklGT1JNVFlQRV9WRUMyXSA9IDI7XG51bmlmb3JtVHlwZVRvTnVtRWxlbWVudHNbVU5JRk9STVRZUEVfVkVDM10gPSAzO1xudW5pZm9ybVR5cGVUb051bUVsZW1lbnRzW1VOSUZPUk1UWVBFX1ZFQzRdID0gNDtcbnVuaWZvcm1UeXBlVG9OdW1FbGVtZW50c1tVTklGT1JNVFlQRV9JTlRdID0gMTtcbnVuaWZvcm1UeXBlVG9OdW1FbGVtZW50c1tVTklGT1JNVFlQRV9JVkVDMl0gPSAyO1xudW5pZm9ybVR5cGVUb051bUVsZW1lbnRzW1VOSUZPUk1UWVBFX0lWRUMzXSA9IDM7XG51bmlmb3JtVHlwZVRvTnVtRWxlbWVudHNbVU5JRk9STVRZUEVfSVZFQzRdID0gNDtcbnVuaWZvcm1UeXBlVG9OdW1FbGVtZW50c1tVTklGT1JNVFlQRV9CT09MXSA9IDE7XG51bmlmb3JtVHlwZVRvTnVtRWxlbWVudHNbVU5JRk9STVRZUEVfQlZFQzJdID0gMjtcbnVuaWZvcm1UeXBlVG9OdW1FbGVtZW50c1tVTklGT1JNVFlQRV9CVkVDM10gPSAzO1xudW5pZm9ybVR5cGVUb051bUVsZW1lbnRzW1VOSUZPUk1UWVBFX0JWRUM0XSA9IDQ7XG51bmlmb3JtVHlwZVRvTnVtRWxlbWVudHNbVU5JRk9STVRZUEVfTUFUMl0gPSA4OyAgICAvLyAyIHggdmVjNFxudW5pZm9ybVR5cGVUb051bUVsZW1lbnRzW1VOSUZPUk1UWVBFX01BVDNdID0gMTI7ICAgLy8gMyB4IHZlYzRcbnVuaWZvcm1UeXBlVG9OdW1FbGVtZW50c1tVTklGT1JNVFlQRV9NQVQ0XSA9IDE2OyAgIC8vIDQgeCB2ZWM0XG5cbi8qKlxuICogQSBjbGFzcyBzdG9yaW5nIGRlc2NyaXB0aW9uIG9mIGFuIGluZGl2aWR1YWwgdW5pZm9ybSwgc3RvcmVkIGluc2lkZSBhIHVuaWZvcm0gYnVmZmVyLlxuICpcbiAqIEBpZ25vcmVcbiAqL1xuY2xhc3MgVW5pZm9ybUZvcm1hdCB7XG4gICAgLyoqIEB0eXBlIHtzdHJpbmd9ICovXG4gICAgbmFtZTtcblxuICAgIC8vIFVOSUZPUk1UWVBFXyoqKlxuICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqL1xuICAgIHR5cGU7XG5cbiAgICAvKiogQHR5cGUge251bWJlcn0gKi9cbiAgICBieXRlU2l6ZTtcblxuICAgIC8qKlxuICAgICAqIEluZGV4IG9mIHRoZSB1bmlmb3JtIGluIGFuIGFycmF5IG9mIDMyYml0IHZhbHVlcyAoRmxvYXQzMkFycmF5IGFuZCBzaW1pbGFyKVxuICAgICAqXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICBvZmZzZXQ7XG5cbiAgICAvKiogQHR5cGUge2ltcG9ydCgnLi9zY29wZS1pZC5qcycpLlNjb3BlSWR9ICovXG4gICAgc2NvcGVJZDtcblxuICAgIC8qKlxuICAgICAqIENvdW50IG9mIGVsZW1lbnRzIGZvciBhcnJheXMsIG90aGVyd2lzZSAwLlxuICAgICAqXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICBjb3VudDtcblxuICAgIGNvbnN0cnVjdG9yKG5hbWUsIHR5cGUsIGNvdW50ID0gMCkge1xuXG4gICAgICAgIC8vIGp1c3QgYSBuYW1lXG4gICAgICAgIHRoaXMuc2hvcnROYW1lID0gbmFtZTtcblxuICAgICAgICAvLyBuYW1lIHdpdGggWzBdIGlmIHRoaXMgaXMgYW4gYXJyYXlcbiAgICAgICAgdGhpcy5uYW1lID0gY291bnQgPyBgJHtuYW1lfVswXWAgOiBuYW1lO1xuXG4gICAgICAgIHRoaXMudHlwZSA9IHR5cGU7XG5cbiAgICAgICAgdGhpcy51cGRhdGVUeXBlID0gdHlwZTtcbiAgICAgICAgaWYgKGNvdW50KSB7XG5cbiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgVU5JRk9STVRZUEVfRkxPQVQ6IHRoaXMudXBkYXRlVHlwZSA9IFVOSUZPUk1UWVBFX0ZMT0FUQVJSQVk7IGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgVU5JRk9STVRZUEVfVkVDMjogdGhpcy51cGRhdGVUeXBlID0gVU5JRk9STVRZUEVfVkVDMkFSUkFZOyBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIFVOSUZPUk1UWVBFX1ZFQzM6IHRoaXMudXBkYXRlVHlwZSA9IFVOSUZPUk1UWVBFX1ZFQzNBUlJBWTsgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBVTklGT1JNVFlQRV9WRUM0OiB0aGlzLnVwZGF0ZVR5cGUgPSBVTklGT1JNVFlQRV9WRUM0QVJSQVk7IGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgVU5JRk9STVRZUEVfTUFUNDogdGhpcy51cGRhdGVUeXBlID0gVU5JRk9STVRZUEVfTUFUNEFSUkFZOyBicmVhaztcblxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIERlYnVnLmVycm9yKGBVbmlmb3JtIGFycmF5IG9mIHR5cGUgJHt1bmlmb3JtVHlwZVRvTmFtZVt0eXBlXX0gaXMgbm90IHN1cHBvcnRlZCB3aGVuIHByb2Nlc3NpbmcgdW5pZm9ybSAnJHtuYW1lfScuYCk7XG4gICAgICAgICAgICAgICAgICAgIERlYnVnLmNhbGwoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jb3VudCA9IGNvdW50O1xuICAgICAgICBEZWJ1Zy5hc3NlcnQoIWlzTmFOKGNvdW50KSwgYFVuc3VwcG9ydGVkIHVuaWZvcm06ICR7bmFtZX1bJHtjb3VudH1dYCk7XG4gICAgICAgIERlYnVnLmNhbGwoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKGlzTmFOKGNvdW50KSlcbiAgICAgICAgICAgICAgICB0aGlzLmludmFsaWQgPSB0cnVlO1xuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgZWxlbWVudFNpemUgPSB1bmlmb3JtVHlwZVRvTnVtRWxlbWVudHNbdHlwZV07XG4gICAgICAgIERlYnVnLmFzc2VydChlbGVtZW50U2l6ZSwgYFVuaGFuZGxlZCB1bmlmb3JtIGZvcm1hdCAke3R5cGV9IHVzZWQgZm9yICR7bmFtZX1gKTtcblxuICAgICAgICAvLyBlbGVtZW50IHNpemUgZm9yIGFycmF5cyBpcyBhbGlnbmVkIHVwIHRvIHZlYzRcbiAgICAgICAgaWYgKGNvdW50KVxuICAgICAgICAgICAgZWxlbWVudFNpemUgPSBtYXRoLnJvdW5kVXAoZWxlbWVudFNpemUsIDQpO1xuXG4gICAgICAgIHRoaXMuYnl0ZVNpemUgPSBlbGVtZW50U2l6ZSAqIDQ7XG4gICAgICAgIGlmIChjb3VudClcbiAgICAgICAgICAgIHRoaXMuYnl0ZVNpemUgKj0gY291bnQ7XG5cbiAgICAgICAgRGVidWcuYXNzZXJ0KHRoaXMuYnl0ZVNpemUsIGBVbmtub3duIGJ5dGUgc2l6ZSBmb3IgdW5pZm9ybSBmb3JtYXQgJHt0eXBlfSB1c2VkIGZvciAke25hbWV9YCk7XG4gICAgfVxuXG4gICAgLy8gc3RkMTQwIHJ1bGVzOiBodHRwczovL3JlZ2lzdHJ5Lmtocm9ub3Mub3JnL09wZW5HTC9zcGVjcy9nbC9nbHNwZWM0NS5jb3JlLnBkZiNwYWdlPTE1OVxuICAgIC8vIFRPRE86IHRoaXMgc3VwcG9ydCBsaW1pdGVkIHN1YnNldCBvZiBmdW5jdGlvbmFsaXR5LCBhcnJheXMgYW5kIHN0cnVjdHMgYXJlIG5vdCBzdXBwb3J0ZWQuXG4gICAgY2FsY3VsYXRlT2Zmc2V0KG9mZnNldCkge1xuXG4gICAgICAgIC8vIE5vdGU6IHZlYzMgaGFzIHRoZSBzYW1lIGFsaWdubWVudCBhcyB2ZWM0XG4gICAgICAgIGxldCBhbGlnbm1lbnQgPSB0aGlzLmJ5dGVTaXplIDw9IDggPyB0aGlzLmJ5dGVTaXplIDogMTY7XG5cbiAgICAgICAgLy8gYXJyYXlzIGhhdmUgdmVjNCBhbGlnbm1lbnRzXG4gICAgICAgIGlmICh0aGlzLmNvdW50KVxuICAgICAgICAgICAgYWxpZ25tZW50ID0gMTY7XG5cbiAgICAgICAgLy8gYWxpZ24gdGhlIHN0YXJ0IG9mZnNldFxuICAgICAgICBvZmZzZXQgPSBtYXRoLnJvdW5kVXAob2Zmc2V0LCBhbGlnbm1lbnQpO1xuICAgICAgICB0aGlzLm9mZnNldCA9IG9mZnNldCAvIDQ7XG4gICAgfVxufVxuXG4vKipcbiAqIEEgZGVzY3JpcHRvciB0aGF0IGRlZmluZXMgdGhlIGxheW91dCBvZiBvZiBkYXRhIGluc2lkZSB0aGUge0BsaW5rIFVuaWZvcm1CdWZmZXJ9LlxuICpcbiAqIEBpZ25vcmVcbiAqL1xuY2xhc3MgVW5pZm9ybUJ1ZmZlckZvcm1hdCB7XG4gICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovXG4gICAgYnl0ZVNpemUgPSAwO1xuXG4gICAgLyoqIEB0eXBlIHtNYXA8c3RyaW5nLFVuaWZvcm1Gb3JtYXQ+fSAqL1xuICAgIG1hcCA9IG5ldyBNYXAoKTtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBVbmlmb3JtQnVmZmVyRm9ybWF0IGluc3RhbmNlLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4vZ3JhcGhpY3MtZGV2aWNlLmpzJykuR3JhcGhpY3NEZXZpY2V9IGdyYXBoaWNzRGV2aWNlIC0gVGhlIGdyYXBoaWNzIGRldmljZS5cbiAgICAgKiBAcGFyYW0ge1VuaWZvcm1Gb3JtYXRbXX0gdW5pZm9ybXMgLSBBbiBhcnJheSBvZiB1bmlmb3JtcyB0byBiZSBzdG9yZWQgaW4gdGhlIGJ1ZmZlclxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGdyYXBoaWNzRGV2aWNlLCB1bmlmb3Jtcykge1xuICAgICAgICB0aGlzLnNjb3BlID0gZ3JhcGhpY3NEZXZpY2Uuc2NvcGU7XG5cbiAgICAgICAgLyoqIEB0eXBlIHtVbmlmb3JtRm9ybWF0W119ICovXG4gICAgICAgIHRoaXMudW5pZm9ybXMgPSB1bmlmb3JtcztcblxuICAgICAgICAvLyBUT0RPOiBvcHRpbWl6ZSB1bmlmb3JtcyBvcmRlcmluZ1xuXG4gICAgICAgIGxldCBvZmZzZXQgPSAwO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVuaWZvcm1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCB1bmlmb3JtID0gdW5pZm9ybXNbaV07XG4gICAgICAgICAgICB1bmlmb3JtLmNhbGN1bGF0ZU9mZnNldChvZmZzZXQpO1xuICAgICAgICAgICAgb2Zmc2V0ID0gdW5pZm9ybS5vZmZzZXQgKiA0ICsgdW5pZm9ybS5ieXRlU2l6ZTtcblxuICAgICAgICAgICAgdW5pZm9ybS5zY29wZUlkID0gdGhpcy5zY29wZS5yZXNvbHZlKHVuaWZvcm0ubmFtZSk7XG5cbiAgICAgICAgICAgIHRoaXMubWFwLnNldCh1bmlmb3JtLm5hbWUsIHVuaWZvcm0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gcm91bmQgdXAgYnVmZmVyIHNpemVcbiAgICAgICAgdGhpcy5ieXRlU2l6ZSA9IG1hdGgucm91bmRVcChvZmZzZXQsIDE2KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGZvcm1hdCBvZiBhIHVuaWZvcm0gd2l0aCBzcGVjaWZpZWQgbmFtZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHVuaWZvcm0uXG4gICAgICogQHJldHVybnMge1VuaWZvcm1Gb3JtYXR9IC0gVGhlIGZvcm1hdCBvZiB0aGUgdW5pZm9ybS5cbiAgICAgKi9cbiAgICBnZXQobmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5tYXAuZ2V0KG5hbWUpO1xuICAgIH1cblxuICAgIGdldFNoYWRlckRlY2xhcmF0aW9uKGJpbmRHcm91cCwgYmluZEluZGV4KSB7XG5cbiAgICAgICAgY29uc3QgbmFtZSA9IGJpbmRHcm91cE5hbWVzW2JpbmRHcm91cF07XG4gICAgICAgIGxldCBjb2RlID0gYGxheW91dChzZXQgPSAke2JpbmRHcm91cH0sIGJpbmRpbmcgPSAke2JpbmRJbmRleH0sIHN0ZDE0MCkgdW5pZm9ybSB1Yl8ke25hbWV9IHtcXG5gO1xuXG4gICAgICAgIHRoaXMudW5pZm9ybXMuZm9yRWFjaCgodW5pZm9ybSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdHlwZVN0cmluZyA9IHVuaWZvcm1UeXBlVG9OYW1lW3VuaWZvcm0udHlwZV07XG4gICAgICAgICAgICBEZWJ1Zy5hc3NlcnQodHlwZVN0cmluZy5sZW5ndGggPiAwLCBgVW5pZm9ybSB0eXBlICR7dW5pZm9ybS50eXBlfSBpcyBub3QgaGFuZGxlZC5gKTtcbiAgICAgICAgICAgIGNvZGUgKz0gYCAgICAke3R5cGVTdHJpbmd9ICR7dW5pZm9ybS5zaG9ydE5hbWV9JHt1bmlmb3JtLmNvdW50ID8gYFske3VuaWZvcm0uY291bnR9XWAgOiAnJ307XFxuYDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGNvZGUgKyAnfTtcXG4nO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgVW5pZm9ybUZvcm1hdCwgVW5pZm9ybUJ1ZmZlckZvcm1hdCB9O1xuIl0sIm5hbWVzIjpbInVuaWZvcm1UeXBlVG9OdW1FbGVtZW50cyIsIlVOSUZPUk1UWVBFX0ZMT0FUIiwiVU5JRk9STVRZUEVfVkVDMiIsIlVOSUZPUk1UWVBFX1ZFQzMiLCJVTklGT1JNVFlQRV9WRUM0IiwiVU5JRk9STVRZUEVfSU5UIiwiVU5JRk9STVRZUEVfSVZFQzIiLCJVTklGT1JNVFlQRV9JVkVDMyIsIlVOSUZPUk1UWVBFX0lWRUM0IiwiVU5JRk9STVRZUEVfQk9PTCIsIlVOSUZPUk1UWVBFX0JWRUMyIiwiVU5JRk9STVRZUEVfQlZFQzMiLCJVTklGT1JNVFlQRV9CVkVDNCIsIlVOSUZPUk1UWVBFX01BVDIiLCJVTklGT1JNVFlQRV9NQVQzIiwiVU5JRk9STVRZUEVfTUFUNCIsIlVuaWZvcm1Gb3JtYXQiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJ0eXBlIiwiY291bnQiLCJieXRlU2l6ZSIsIm9mZnNldCIsInNjb3BlSWQiLCJzaG9ydE5hbWUiLCJ1cGRhdGVUeXBlIiwiVU5JRk9STVRZUEVfRkxPQVRBUlJBWSIsIlVOSUZPUk1UWVBFX1ZFQzJBUlJBWSIsIlVOSUZPUk1UWVBFX1ZFQzNBUlJBWSIsIlVOSUZPUk1UWVBFX1ZFQzRBUlJBWSIsIlVOSUZPUk1UWVBFX01BVDRBUlJBWSIsIkRlYnVnIiwiZXJyb3IiLCJ1bmlmb3JtVHlwZVRvTmFtZSIsImNhbGwiLCJpbnZhbGlkIiwiYXNzZXJ0IiwiaXNOYU4iLCJlbGVtZW50U2l6ZSIsIm1hdGgiLCJyb3VuZFVwIiwiY2FsY3VsYXRlT2Zmc2V0IiwiYWxpZ25tZW50IiwiVW5pZm9ybUJ1ZmZlckZvcm1hdCIsImdyYXBoaWNzRGV2aWNlIiwidW5pZm9ybXMiLCJtYXAiLCJNYXAiLCJzY29wZSIsImkiLCJsZW5ndGgiLCJ1bmlmb3JtIiwicmVzb2x2ZSIsInNldCIsImdldCIsImdldFNoYWRlckRlY2xhcmF0aW9uIiwiYmluZEdyb3VwIiwiYmluZEluZGV4IiwiYmluZEdyb3VwTmFtZXMiLCJjb2RlIiwiZm9yRWFjaCIsInR5cGVTdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7QUFXQTtBQUNBLE1BQU1BLHdCQUF3QixHQUFHLEVBQUUsQ0FBQTtBQUNuQ0Esd0JBQXdCLENBQUNDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBQy9DRCx3QkFBd0IsQ0FBQ0UsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDOUNGLHdCQUF3QixDQUFDRyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQTtBQUM5Q0gsd0JBQXdCLENBQUNJLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBQzlDSix3QkFBd0IsQ0FBQ0ssZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBQzdDTCx3QkFBd0IsQ0FBQ00saUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDL0NOLHdCQUF3QixDQUFDTyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQTtBQUMvQ1Asd0JBQXdCLENBQUNRLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBQy9DUix3QkFBd0IsQ0FBQ1MsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDOUNULHdCQUF3QixDQUFD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
