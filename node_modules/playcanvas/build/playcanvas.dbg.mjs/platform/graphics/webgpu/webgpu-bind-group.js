import { Debug, DebugHelper } from '../../../core/debug.js';
import { WebgpuDebug } from './webgpu-debug.js';

/**
 * A WebGPU implementation of the BindGroup, which is a wrapper over GPUBindGroup.
 *
 * @ignore
 */
class WebgpuBindGroup {
  constructor() {
    /**
     * @type {GPUBindGroup}
     * @private
     */
    this.bindGroup = void 0;
  }
  update(bindGroup) {
    this.destroy();
    const device = bindGroup.device;

    /** @type {GPUBindGroupDescriptor} */
    const descr = this.createDescriptor(device, bindGroup);
    WebgpuDebug.validate(device);
    this.bindGroup = device.wgpu.createBindGroup(descr);
    WebgpuDebug.end(device, {
      debugFormat: this.debugFormat,
      descr: descr,
      format: bindGroup.format,
      bindGroup: bindGroup
    });
  }
  destroy() {
    // this.bindGroup?.destroy();
    this.bindGroup = null;
  }

  /**
   * Creates a bind group descriptor in WebGPU format
   *
   * @param {import('./webgpu-graphics-device.js').WebgpuGraphicsDevice} device - Graphics device.
   * @param {import('../bind-group.js').BindGroup} bindGroup - Bind group to create the
   * descriptor for.
   * @returns {object} - Returns the generated descriptor of type
   * GPUBindGroupDescriptor, which can be used to create a GPUBindGroup
   */
  createDescriptor(device, bindGroup) {
    // Note: This needs to match WebgpuBindGroupFormat.createDescriptor
    const entries = [];
    const format = bindGroup.format;
    Debug.call(() => {
      this.debugFormat = '';
    });

    // uniform buffers
    let index = 0;
    bindGroup.uniformBuffers.forEach(ub => {
      const buffer = ub.impl.buffer;
      Debug.assert(buffer, 'NULL uniform buffer cannot be used by the bind group');
      Debug.call(() => {
        this.debugFormat += `${index}: UB\n`;
      });
      entries.push({
        binding: index++,
        resource: {
          buffer: buffer
        }
      });
    });

    // textures
    bindGroup.textures.forEach((tex, textureIndex) => {
      /** @type {import('./webgpu-texture.js').WebgpuTexture} */
      const wgpuTexture = tex.impl;
      const textureFormat = format.textureFormats[textureIndex];

      // texture
      const view = wgpuTexture.getView(device);
      Debug.assert(view, 'NULL texture view cannot be used by the bind group');
      Debug.call(() => {
        this.debugFormat += `${index}: ${bindGroup.format.textureFormats[textureIndex].name}\n`;
      });
      entries.push({
        binding: index++,
        resource: view
      });

      // sampler
      const sampler = wgpuTexture.getSampler(device, textureFormat.sampleType);
      Debug.assert(sampler, 'NULL sampler cannot be used by the bind group');
      Debug.call(() => {
        this.debugFormat += `${index}: ${sampler.label}\n`;
      });
      entries.push({
        binding: index++,
        resource: sampler
      });
    });
    const descr = {
      layout: bindGroup.format.impl.bindGroupLayout,
      entries: entries
    };
    DebugHelper.setLabel(descr, bindGroup.name);
    return descr;
  }
}

export { WebgpuBindGroup };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViZ3B1LWJpbmQtZ3JvdXAuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9wbGF0Zm9ybS9ncmFwaGljcy93ZWJncHUvd2ViZ3B1LWJpbmQtZ3JvdXAuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVidWcsIERlYnVnSGVscGVyIH0gZnJvbSAnLi4vLi4vLi4vY29yZS9kZWJ1Zy5qcyc7XG5pbXBvcnQgeyBXZWJncHVEZWJ1ZyB9IGZyb20gJy4vd2ViZ3B1LWRlYnVnLmpzJztcblxuLyoqXG4gKiBBIFdlYkdQVSBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgQmluZEdyb3VwLCB3aGljaCBpcyBhIHdyYXBwZXIgb3ZlciBHUFVCaW5kR3JvdXAuXG4gKlxuICogQGlnbm9yZVxuICovXG5jbGFzcyBXZWJncHVCaW5kR3JvdXAge1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHtHUFVCaW5kR3JvdXB9XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBiaW5kR3JvdXA7XG5cbiAgICB1cGRhdGUoYmluZEdyb3VwKSB7XG5cbiAgICAgICAgdGhpcy5kZXN0cm95KCk7XG4gICAgICAgIGNvbnN0IGRldmljZSA9IGJpbmRHcm91cC5kZXZpY2U7XG5cbiAgICAgICAgLyoqIEB0eXBlIHtHUFVCaW5kR3JvdXBEZXNjcmlwdG9yfSAqL1xuICAgICAgICBjb25zdCBkZXNjciA9IHRoaXMuY3JlYXRlRGVzY3JpcHRvcihkZXZpY2UsIGJpbmRHcm91cCk7XG5cbiAgICAgICAgV2ViZ3B1RGVidWcudmFsaWRhdGUoZGV2aWNlKTtcblxuICAgICAgICB0aGlzLmJpbmRHcm91cCA9IGRldmljZS53Z3B1LmNyZWF0ZUJpbmRHcm91cChkZXNjcik7XG5cbiAgICAgICAgV2ViZ3B1RGVidWcuZW5kKGRldmljZSwge1xuICAgICAgICAgICAgZGVidWdGb3JtYXQ6IHRoaXMuZGVidWdGb3JtYXQsXG4gICAgICAgICAgICBkZXNjcjogZGVzY3IsXG4gICAgICAgICAgICBmb3JtYXQ6IGJpbmRHcm91cC5mb3JtYXQsXG4gICAgICAgICAgICBiaW5kR3JvdXA6IGJpbmRHcm91cFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBkZXN0cm95KCkge1xuICAgICAgICAvLyB0aGlzLmJpbmRHcm91cD8uZGVzdHJveSgpO1xuICAgICAgICB0aGlzLmJpbmRHcm91cCA9IG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBhIGJpbmQgZ3JvdXAgZGVzY3JpcHRvciBpbiBXZWJHUFUgZm9ybWF0XG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi93ZWJncHUtZ3JhcGhpY3MtZGV2aWNlLmpzJykuV2ViZ3B1R3JhcGhpY3NEZXZpY2V9IGRldmljZSAtIEdyYXBoaWNzIGRldmljZS5cbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi4vYmluZC1ncm91cC5qcycpLkJpbmRHcm91cH0gYmluZEdyb3VwIC0gQmluZCBncm91cCB0byBjcmVhdGUgdGhlXG4gICAgICogZGVzY3JpcHRvciBmb3IuXG4gICAgICogQHJldHVybnMge29iamVjdH0gLSBSZXR1cm5zIHRoZSBnZW5lcmF0ZWQgZGVzY3JpcHRvciBvZiB0eXBlXG4gICAgICogR1BVQmluZEdyb3VwRGVzY3JpcHRvciwgd2hpY2ggY2FuIGJlIHVzZWQgdG8gY3JlYXRlIGEgR1BVQmluZEdyb3VwXG4gICAgICovXG4gICAgY3JlYXRlRGVzY3JpcHRvcihkZXZpY2UsIGJpbmRHcm91cCkge1xuXG4gICAgICAgIC8vIE5vdGU6IFRoaXMgbmVlZHMgdG8gbWF0Y2ggV2ViZ3B1QmluZEdyb3VwRm9ybWF0LmNyZWF0ZURlc2NyaXB0b3JcbiAgICAgICAgY29uc3QgZW50cmllcyA9IFtdO1xuXG4gICAgICAgIGNvbnN0IGZvcm1hdCA9IGJpbmRHcm91cC5mb3JtYXQ7XG5cbiAgICAgICAgRGVidWcuY2FsbCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRlYnVnRm9ybWF0ID0gJyc7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIHVuaWZvcm0gYnVmZmVyc1xuICAgICAgICBsZXQgaW5kZXggPSAwO1xuICAgICAgICBiaW5kR3JvdXAudW5pZm9ybUJ1ZmZlcnMuZm9yRWFjaCgodWIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHViLmltcGwuYnVmZmVyO1xuICAgICAgICAgICAgRGVidWcuYXNzZXJ0KGJ1ZmZlciwgJ05VTEwgdW5pZm9ybSBidWZmZXIgY2Fubm90IGJlIHVzZWQgYnkgdGhlIGJpbmQgZ3JvdXAnKTtcbiAgICAgICAgICAgIERlYnVnLmNhbGwoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVidWdGb3JtYXQgKz0gYCR7aW5kZXh9OiBVQlxcbmA7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgZW50cmllcy5wdXNoKHtcbiAgICAgICAgICAgICAgICBiaW5kaW5nOiBpbmRleCsrLFxuICAgICAgICAgICAgICAgIHJlc291cmNlOiB7XG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZlcjogYnVmZmVyXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIHRleHR1cmVzXG4gICAgICAgIGJpbmRHcm91cC50ZXh0dXJlcy5mb3JFYWNoKCh0ZXgsIHRleHR1cmVJbmRleCkgPT4ge1xuXG4gICAgICAgICAgICAvKiogQHR5cGUge2ltcG9ydCgnLi93ZWJncHUtdGV4dHVyZS5qcycpLldlYmdwdVRleHR1cmV9ICovXG4gICAgICAgICAgICBjb25zdCB3Z3B1VGV4dHVyZSA9IHRleC5pbXBsO1xuICAgICAgICAgICAgY29uc3QgdGV4dHVyZUZvcm1hdCA9IGZvcm1hdC50ZXh0dXJlRm9ybWF0c1t0ZXh0dXJlSW5kZXhdO1xuXG4gICAgICAgICAgICAvLyB0ZXh0dXJlXG4gICAgICAgICAgICBjb25zdCB2aWV3ID0gd2dwdVRleHR1cmUuZ2V0VmlldyhkZXZpY2UpO1xuICAgICAgICAgICAgRGVidWcuYXNzZXJ0KHZpZXcsICdOVUxMIHRleHR1cmUgdmlldyBjYW5ub3QgYmUgdXNlZCBieSB0aGUgYmluZCBncm91cCcpO1xuICAgICAgICAgICAgRGVidWcuY2FsbCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z0Zvcm1hdCArPSBgJHtpbmRleH06ICR7YmluZEdyb3VwLmZvcm1hdC50ZXh0dXJlRm9ybWF0c1t0ZXh0dXJlSW5kZXhdLm5hbWV9XFxuYDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBlbnRyaWVzLnB1c2goe1xuICAgICAgICAgICAgICAgIGJpbmRpbmc6IGluZGV4KyssXG4gICAgICAgICAgICAgICAgcmVzb3VyY2U6IHZpZXdcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyBzYW1wbGVyXG4gICAgICAgICAgICBjb25zdCBzYW1wbGVyID0gd2dwdVRleHR1cmUuZ2V0U2FtcGxlcihkZXZpY2UsIHRleHR1cmVGb3JtYXQuc2FtcGxlVHlwZSk7XG4gICAgICAgICAgICBEZWJ1Zy5hc3NlcnQoc2FtcGxlciwgJ05VTEwgc2FtcGxlciBjYW5ub3QgYmUgdXNlZCBieSB0aGUgYmluZCBncm91cCcpO1xuICAgICAgICAgICAgRGVidWcuY2FsbCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z0Zvcm1hdCArPSBgJHtpbmRleH06ICR7c2FtcGxlci5sYWJlbH1cXG5gO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGVudHJpZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgYmluZGluZzogaW5kZXgrKyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZTogc2FtcGxlclxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGRlc2NyID0ge1xuICAgICAgICAgICAgbGF5b3V0OiBiaW5kR3JvdXAuZm9ybWF0LmltcGwuYmluZEdyb3VwTGF5b3V0LFxuICAgICAgICAgICAgZW50cmllczogZW50cmllc1xuICAgICAgICB9O1xuXG4gICAgICAgIERlYnVnSGVscGVyLnNldExhYmVsKGRlc2NyLCBiaW5kR3JvdXAubmFtZSk7XG5cbiAgICAgICAgcmV0dXJuIGRlc2NyO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgV2ViZ3B1QmluZEdyb3VwIH07XG4iXSwibmFtZXMiOlsiV2ViZ3B1QmluZEdyb3VwIiwiY29uc3RydWN0b3IiLCJiaW5kR3JvdXAiLCJ1cGRhdGUiLCJkZXN0cm95IiwiZGV2aWNlIiwiZGVzY3IiLCJjcmVhdGVEZXNjcmlwdG9yIiwiV2ViZ3B1RGVidWciLCJ2YWxpZGF0ZSIsIndncHUiLCJjcmVhdGVCaW5kR3JvdXAiLCJlbmQiLCJkZWJ1Z0Zvcm1hdCIsImZvcm1hdCIsImVudHJpZXMiLCJEZWJ1ZyIsImNhbGwiLCJpbmRleCIsInVuaWZvcm1CdWZmZXJzIiwiZm9yRWFjaCIsInViIiwiYnVmZmVyIiwiaW1wbCIsImFzc2VydCIsInB1c2giLCJiaW5kaW5nIiwicmVzb3VyY2UiLCJ0ZXh0dXJlcyIsInRleCIsInRleHR1cmVJbmRleCIsIndncHVUZXh0dXJlIiwidGV4dHVyZUZvcm1hdCIsInRleHR1cmVGb3JtYXRzIiwidmlldyIsImdldFZpZXciLCJuYW1lIiwic2FtcGxlciIsImdldFNhbXBsZXIiLCJzYW1wbGVUeXBlIiwibGFiZWwiLCJsYXlvdXQiLCJiaW5kR3JvdXBMYXlvdXQiLCJEZWJ1Z0hlbHBlciIsInNldExhYmVsIl0sIm1hcHBpbmdzIjoiOzs7QUFHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTUEsZUFBZSxDQUFDO0VBQUFDLFdBQUEsR0FBQTtBQUNsQjtBQUNKO0FBQ0E7QUFDQTtBQUhJLElBQUEsSUFBQSxDQUlBQyxTQUFTLEdBQUEsS0FBQSxDQUFBLENBQUE7QUFBQSxHQUFBO0VBRVRDLE1BQU1BLENBQUNELFNBQVMsRUFBRTtJQUVkLElBQUksQ0FBQ0UsT0FBTyxFQUFFLENBQUE7QUFDZCxJQUFBLE1BQU1DLE1BQU0sR0FBR0gsU0FBUyxDQUFDRyxNQUFN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
