import { Debug } from '../../core/debug.js';
import { EventHandler } from '../../core/event-handler.js';
import { math } from '../../core/math/math.js';
import { Channel } from '../audio/channel.js';
import { Channel3d } from '../audio/channel3d.js';
import { Listener } from './listener.js';

const CONTEXT_STATE_RUNNING = 'running';

/**
 * List of Window events to listen when AudioContext needs to be unlocked.
 */
const USER_INPUT_EVENTS = ['click', 'touchstart', 'mousedown'];

/**
 * The SoundManager is used to load and play audio. It also applies system-wide settings like
 * global volume, suspend and resume.
 *
 * @augments EventHandler
 */
class SoundManager extends EventHandler {
  /**
   * Create a new SoundManager instance.
   *
   */
  constructor() {
    super();

    /**
     * The underlying AudioContext, lazy loaded in the 'context' property.
     *
     * @type {AudioContext}
     * @private
     */
    this._context = null;
    this.AudioContext = typeof AudioContext !== 'undefined' && AudioContext || typeof webkitAudioContext !== 'undefined' && webkitAudioContext;
    if (!this.AudioContext) {
      Debug.warn('No support for 3D audio found');
    }
    this._unlockHandlerFunc = this._unlockHandler.bind(this);

    // user suspended audio
    this._userSuspended = false;
    this.listener = new Listener(this);
    this._volume = 1;
  }

  /**
   * Global volume for the manager. All {@link SoundInstance}s will scale their volume with this
   * volume. Valid between [0, 1].
   *
   * @type {number}
   */
  set volume(volume) {
    volume = math.clamp(volume, 0, 1);
    this._volume = volume;
    this.fire('volumechange', volume);
  }
  get volume() {
    return this._volume;
  }
  get suspended() {
    return this._userSuspended;
  }

  /**
   * Get the Web Audio API context.
   *
   * @type {AudioContext}
   * @ignore
   */
  get context() {
    // lazy create the AudioContext
    if (!this._context && this.AudioContext) {
      this._context = new this.AudioContext();
      if (this._context.state !== CONTEXT_STATE_RUNNING) {
        this._registerUnlockListeners();
      }
    }
    return this._context;
  }
  suspend() {
    if (!this._userSuspended) {
      this._userSuspended = true;
      if (this._context && this._context.state === CONTEXT_STATE_RUNNING) {
        this._suspend();
      }
    }
  }
  resume() {
    if (this._userSuspended) {
      this._userSuspended = false;
      if (this._context && this._context.state !== CONTEXT_STATE_RUNNING) {
        this._resume();
      }
    }
  }
  destroy() {
    this.fire('destroy');
    if (this._context) {
      var _this$_context;
      this._removeUnlockListeners();
      (_this$_context = this._context) == null ? void 0 : _this$_context.close();
      this._context = null;
    }
  }

  /**
   * Create a new {@link Channel} and begin playback of the sound.
   *
   * @param {Sound} sound - The Sound object to play.
   * @param {object} options - Optional options object.
   * @param {number} [options.volume] - The volume to playback at, between 0 and 1.
   * @param {boolean} [options.loop] - Whether to loop the sound when it reaches the end.
   * @returns {Channel} The channel playing the sound.
   * @private
   */
  playSound(sound, options = {}) {
    let channel = null;
    if (Channel) {
      channel = new Channel(this, sound, options);
      channel.play();
    }
    return channel;
  }

  /**
   * Create a new {@link Channel3d} and begin playback of the sound at the position specified.
   *
   * @param {Sound} sound - The Sound object to play.
   * @param {Vec3} position - The position of the sound in 3D space.
   * @param {object} options - Optional options object.
   * @param {number} [options.volume] - The volume to playback at, between 0 and 1.
   * @param {boolean} [options.loop] - Whether to loop the sound when it reaches the end.
   * @returns {Channel3d} The 3D channel playing the sound.
   * @private
   */
  playSound3d(sound, position, options = {}) {
    let channel = null;
    if (Channel3d) {
      channel = new Channel3d(this, sound, options);
      channel.setPosition(position);
      if (options.volume) {
        channel.setVolume(options.volume);
      }
      if (options.loop) {
        channel.setLoop(options.loop);
      }
      if (options.maxDistance) {
        channel.setMaxDistance(options.maxDistance);
      }
      if (options.minDistance) {
        channel.setMinDistance(options.minDistance);
      }
      if (options.rollOffFactor) {
        channel.setRollOffFactor(options.rollOffFactor);
      }
      if (options.distanceModel) {
        channel.setDistanceModel(options.distanceModel);
      }
      channel.play();
    }
    return channel;
  }

  // resume the sound context
  _resume() {
    this._context.resume().then(() => {
      // Some platforms (mostly iOS) require an additional sound to be played.
      // This also performs a sanity check and verifies sounds can be played.
      const source = this._context.createBufferSource();
      source.buffer = this._context.createBuffer(1, 1, this._context.sampleRate);
      source.connect(this._context.destination);
      source.start(0);

      // onended is only called if everything worked as expected (context is running)
      source.onended = event => {
        source.disconnect(0);
        this.fire('resume');
      };
    }, e => {
      Debug.error(`Attempted to resume the AudioContext on SoundManager.resume(), but it was rejected ${e}`);
    }).catch(e => {
      Debug.error(`Attempted to resume the AudioContext on SoundManager.resume(), but threw an exception ${e}`);
    });
  }

  // resume the sound context and fire suspend event if it succeeds
  _suspend() {
    this._context.suspend().then(() => {
      this.fire('suspend');
    }, e => {
      Debug.error(`Attempted to suspend the AudioContext on SoundManager.suspend(), but it was rejected ${e}`);
    }).catch(e => {
      Debug.error(`Attempted to suspend the AudioContext on SoundManager.suspend(), but threw an exception ${e}`);
    });
  }
  _unlockHandler() {
    this._removeUnlockListeners();
    if (!this._userSuspended && this._context.state !== CONTEXT_STATE_RUNNING) {
      this._resume();
    }
  }
  _registerUnlockListeners() {
    // attach to all user input events
    USER_INPUT_EVENTS.forEach(eventName => {
      window.addEventListener(eventName, this._unlockHandlerFunc, false);
    });
  }
  _removeUnlockListeners() {
    USER_INPUT_EVENTS.forEach(eventName => {
      window.removeEventListener(eventName, this._unlockHandlerFunc, false);
    });
  }
}

export { SoundManager };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlci5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3BsYXRmb3JtL3NvdW5kL21hbmFnZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVidWcgfSBmcm9tICcuLi8uLi9jb3JlL2RlYnVnLmpzJztcblxuaW1wb3J0IHsgRXZlbnRIYW5kbGVyIH0gZnJvbSAnLi4vLi4vY29yZS9ldmVudC1oYW5kbGVyLmpzJztcblxuaW1wb3J0IHsgbWF0aCB9IGZyb20gJy4uLy4uL2NvcmUvbWF0aC9tYXRoLmpzJztcblxuaW1wb3J0IHsgQ2hhbm5lbCB9IGZyb20gJy4uL2F1ZGlvL2NoYW5uZWwuanMnO1xuaW1wb3J0IHsgQ2hhbm5lbDNkIH0gZnJvbSAnLi4vYXVkaW8vY2hhbm5lbDNkLmpzJztcblxuaW1wb3J0IHsgTGlzdGVuZXIgfSBmcm9tICcuL2xpc3RlbmVyLmpzJztcblxuY29uc3QgQ09OVEVYVF9TVEFURV9SVU5OSU5HID0gJ3J1bm5pbmcnO1xuXG4vKipcbiAqIExpc3Qgb2YgV2luZG93IGV2ZW50cyB0byBsaXN0ZW4gd2hlbiBBdWRpb0NvbnRleHQgbmVlZHMgdG8gYmUgdW5sb2NrZWQuXG4gKi9cbmNvbnN0IFVTRVJfSU5QVVRfRVZFTlRTID0gW1xuICAgICdjbGljaycsICd0b3VjaHN0YXJ0JywgJ21vdXNlZG93bidcbl07XG5cbi8qKlxuICogVGhlIFNvdW5kTWFuYWdlciBpcyB1c2VkIHRvIGxvYWQgYW5kIHBsYXkgYXVkaW8uIEl0IGFsc28gYXBwbGllcyBzeXN0ZW0td2lkZSBzZXR0aW5ncyBsaWtlXG4gKiBnbG9iYWwgdm9sdW1lLCBzdXNwZW5kIGFuZCByZXN1bWUuXG4gKlxuICogQGF1Z21lbnRzIEV2ZW50SGFuZGxlclxuICovXG5jbGFzcyBTb3VuZE1hbmFnZXIgZXh0ZW5kcyBFdmVudEhhbmRsZXIge1xuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBTb3VuZE1hbmFnZXIgaW5zdGFuY2UuXG4gICAgICpcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogVGhlIHVuZGVybHlpbmcgQXVkaW9Db250ZXh0LCBsYXp5IGxvYWRlZCBpbiB0aGUgJ2NvbnRleHQnIHByb3BlcnR5LlxuICAgICAgICAgKlxuICAgICAgICAgKiBAdHlwZSB7QXVkaW9Db250ZXh0fVxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fY29udGV4dCA9IG51bGw7XG5cbiAgICAgICAgdGhpcy5BdWRpb0NvbnRleHQgPSAodHlwZW9mIEF1ZGlvQ29udGV4dCAhPT0gJ3VuZGVmaW5lZCcgJiYgQXVkaW9Db250ZXh0KSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlb2Ygd2Via2l0QXVkaW9Db250ZXh0ICE9PSAndW5kZWZpbmVkJyAmJiB3ZWJraXRBdWRpb0NvbnRleHQpO1xuXG4gICAgICAgIGlmICghdGhpcy5BdWRpb0NvbnRleHQpIHtcbiAgICAgICAgICAgIERlYnVnLndhcm4oJ05vIHN1cHBvcnQgZm9yIDNEIGF1ZGlvIGZvdW5kJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl91bmxvY2tIYW5kbGVyRnVuYyA9IHRoaXMuX3VubG9ja0hhbmRsZXIuYmluZCh0aGlzKTtcblxuICAgICAgICAvLyB1c2VyIHN1c3BlbmRlZCBhdWRpb1xuICAgICAgICB0aGlzLl91c2VyU3VzcGVuZGVkID0gZmFsc2U7XG5cbiAgICAgICAgdGhpcy5saXN0ZW5lciA9IG5ldyBMaXN0ZW5lcih0aGlzKTtcblxuICAgICAgICB0aGlzLl92b2x1bWUgPSAxO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdsb2JhbCB2b2x1bWUgZm9yIHRoZSBtYW5hZ2VyLiBBbGwge0BsaW5rIFNvdW5kSW5zdGFuY2V9cyB3aWxsIHNjYWxlIHRoZWlyIHZvbHVtZSB3aXRoIHRoaXNcbiAgICAgKiB2b2x1bWUuIFZhbGlkIGJldHdlZW4gWzAsIDFdLlxuICAgICAqXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICBzZXQgdm9sdW1lKHZvbHVtZSkge1xuICAgICAgICB2b2x1bWUgPSBtYXRoLmNsYW1wKHZvbHVtZSwgMCwgMSk7XG4gICAgICAgIHRoaXMuX3ZvbHVtZSA9IHZvbHVtZTtcbiAgICAgICAgdGhpcy5maXJlKCd2b2x1bWVjaGFuZ2UnLCB2b2x1bWUpO1xuICAgIH1cblxuICAgIGdldCB2b2x1bWUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl92b2x1bWU7XG4gICAgfVxuXG4gICAgZ2V0IHN1c3BlbmRlZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3VzZXJTdXNwZW5kZWQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBXZWIgQXVkaW8gQVBJIGNvbnRleHQuXG4gICAgICpcbiAgICAgKiBAdHlwZSB7QXVkaW9Db250ZXh0fVxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICBnZXQgY29udGV4dCgpIHtcbiAgICAgICAgLy8gbGF6eSBjcmVhdGUgdGhlIEF1ZGlvQ29udGV4dFxuICAgICAgICBpZiAoIXRoaXMuX2NvbnRleHQgJiYgdGhpcy5BdWRpb0NvbnRleHQpIHtcbiAgICAgICAgICAgIHRoaXMuX2NvbnRleHQgPSBuZXcgdGhpcy5BdWRpb0NvbnRleHQoKTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRleHQuc3RhdGUgIT09IENPTlRFWFRfU1RBVEVfUlVOTklORykge1xuICAgICAgICAgICAgICAgIHRoaXMuX3JlZ2lzdGVyVW5sb2NrTGlzdGVuZXJzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fY29udGV4dDtcbiAgICB9XG5cbiAgICBzdXNwZW5kKCkge1xuICAgICAgICBpZiAoIXRoaXMuX3VzZXJTdXNwZW5kZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX3VzZXJTdXNwZW5kZWQgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRleHQgJiYgdGhpcy5fY29udGV4dC5zdGF0ZSA9PT0gQ09OVEVYVF9TVEFURV9SVU5OSU5HKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc3VzcGVuZCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVzdW1lKCkge1xuICAgICAgICBpZiAodGhpcy5fdXNlclN1c3BlbmRlZCkge1xuICAgICAgICAgICAgdGhpcy5fdXNlclN1c3BlbmRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRleHQgJiYgdGhpcy5fY29udGV4dC5zdGF0ZSAhPT0gQ09OVEVYVF9TVEFURV9SVU5OSU5HKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcmVzdW1lKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkZXN0cm95KCkge1xuICAgICAgICB0aGlzLmZpcmUoJ2Rlc3Ryb3knKTtcblxuICAgICAgICBpZiAodGhpcy5fY29udGV4dCkge1xuICAgICAgICAgICAgdGhpcy5fcmVtb3ZlVW5sb2NrTGlzdGVuZXJzKCk7XG4gICAgICAgICAgICB0aGlzLl9jb250ZXh0Py5jbG9zZSgpO1xuICAgICAgICAgICAgdGhpcy5fY29udGV4dCA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcge0BsaW5rIENoYW5uZWx9IGFuZCBiZWdpbiBwbGF5YmFjayBvZiB0aGUgc291bmQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge1NvdW5kfSBzb3VuZCAtIFRoZSBTb3VuZCBvYmplY3QgdG8gcGxheS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyAtIE9wdGlvbmFsIG9wdGlvbnMgb2JqZWN0LlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3B0aW9ucy52b2x1bWVdIC0gVGhlIHZvbHVtZSB0byBwbGF5YmFjayBhdCwgYmV0d2VlbiAwIGFuZCAxLlxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMubG9vcF0gLSBXaGV0aGVyIHRvIGxvb3AgdGhlIHNvdW5kIHdoZW4gaXQgcmVhY2hlcyB0aGUgZW5kLlxuICAgICAqIEByZXR1cm5zIHtDaGFubmVsfSBUaGUgY2hhbm5lbCBwbGF5aW5nIHRoZSBzb3VuZC5cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHBsYXlTb3VuZChzb3VuZCwgb3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIGxldCBjaGFubmVsID0gbnVsbDtcbiAgICAgICAgaWYgKENoYW5uZWwpIHtcbiAgICAgICAgICAgIGNoYW5uZWwgPSBuZXcgQ2hhbm5lbCh0aGlzLCBzb3VuZCwgb3B0aW9ucyk7XG4gICAgICAgICAgICBjaGFubmVsLnBsYXkoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY2hhbm5lbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcge0BsaW5rIENoYW5uZWwzZH0gYW5kIGJlZ2luIHBsYXliYWNrIG9mIHRoZSBzb3VuZCBhdCB0aGUgcG9zaXRpb24gc3BlY2lmaWVkLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtTb3VuZH0gc291bmQgLSBUaGUgU291bmQgb2JqZWN0IHRvIHBsYXkuXG4gICAgICogQHBhcmFtIHtWZWMzfSBwb3NpdGlvbiAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgc291bmQgaW4gM0Qgc3BhY2UuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgLSBPcHRpb25hbCBvcHRpb25zIG9iamVjdC5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gW29wdGlvbnMudm9sdW1lXSAtIFRoZSB2b2x1bWUgdG8gcGxheWJhY2sgYXQsIGJldHdlZW4gMCBhbmQgMS5cbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLmxvb3BdIC0gV2hldGhlciB0byBsb29wIHRoZSBzb3VuZCB3aGVuIGl0IHJlYWNoZXMgdGhlIGVuZC5cbiAgICAgKiBAcmV0dXJucyB7Q2hhbm5lbDNkfSBUaGUgM0QgY2hhbm5lbCBwbGF5aW5nIHRoZSBzb3VuZC5cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHBsYXlTb3VuZDNkKHNvdW5kLCBwb3NpdGlvbiwgb3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIGxldCBjaGFubmVsID0gbnVsbDtcbiAgICAgICAgaWYgKENoYW5uZWwzZCkge1xuICAgICAgICAgICAgY2hhbm5lbCA9IG5ldyBDaGFubmVsM2QodGhpcywgc291bmQsIG9wdGlvbnMpO1xuICAgICAgICAgICAgY2hhbm5lbC5zZXRQb3NpdGlvbihwb3NpdGlvbik7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy52b2x1bWUpIHtcbiAgICAgICAgICAgICAgICBjaGFubmVsLnNldFZvbHVtZShvcHRpb25zLnZvbHVtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5sb29wKSB7XG4gICAgICAgICAgICAgICAgY2hhbm5lbC5zZXRMb29wKG9wdGlvbnMubG9vcCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5tYXhEaXN0YW5jZSkge1xuICAgICAgICAgICAgICAgIGNoYW5uZWwuc2V0TWF4RGlzdGFuY2Uob3B0aW9ucy5tYXhEaXN0YW5jZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5taW5EaXN0YW5jZSkge1xuICAgICAgICAgICAgICAgIGNoYW5uZWwuc2V0TWluRGlzdGFuY2Uob3B0aW9ucy5taW5EaXN0YW5jZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5yb2xsT2ZmRmFjdG9yKSB7XG4gICAgICAgICAgICAgICAgY2hhbm5lbC5zZXRSb2xsT2ZmRmFjdG9yKG9wdGlvbnMucm9sbE9mZkZhY3Rvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5kaXN0YW5jZU1vZGVsKSB7XG4gICAgICAgICAgICAgICAgY2hhbm5lbC5zZXREaXN0YW5jZU1vZGVsKG9wdGlvbnMuZGlzdGFuY2VNb2RlbCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNoYW5uZWwucGxheSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNoYW5uZWw7XG4gICAgfVxuXG4gICAgLy8gcmVzdW1lIHRoZSBzb3VuZCBjb250ZXh0XG4gICAgX3Jlc3VtZSgpIHtcbiAgICAgICAgdGhpcy5fY29udGV4dC5yZXN1bWUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIC8vIFNvbWUgcGxhdGZvcm1zIChtb3N0bHkgaU9TKSByZXF1aXJlIGFuIGFkZGl0aW9uYWwgc291bmQgdG8gYmUgcGxheWVkLlxuICAgICAgICAgICAgLy8gVGhpcyBhbHNvIHBlcmZvcm1zIGEgc2FuaXR5IGNoZWNrIGFuZCB2ZXJpZmllcyBzb3VuZHMgY2FuIGJlIHBsYXllZC5cbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IHRoaXMuX2NvbnRleHQuY3JlYXRlQnVmZmVyU291cmNlKCk7XG4gICAgICAgICAgICBzb3VyY2UuYnVmZmVyID0gdGhpcy5fY29udGV4dC5jcmVhdGVCdWZmZXIoMSwgMSwgdGhpcy5fY29udGV4dC5zYW1wbGVSYXRlKTtcbiAgICAgICAgICAgIHNvdXJjZS5jb25uZWN0KHRoaXMuX2NvbnRleHQuZGVzdGluYXRpb24pO1xuICAgICAgICAgICAgc291cmNlLnN0YXJ0KDApO1xuXG4gICAgICAgICAgICAvLyBvbmVuZGVkIGlzIG9ubHkgY2FsbGVkIGlmIGV2ZXJ5dGhpbmcgd29ya2VkIGFzIGV4cGVjdGVkIChjb250ZXh0IGlzIHJ1bm5pbmcpXG4gICAgICAgICAgICBzb3VyY2Uub25lbmRlZCA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHNvdXJjZS5kaXNjb25uZWN0KDApO1xuICAgICAgICAgICAgICAgIHRoaXMuZmlyZSgncmVzdW1lJyk7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9LCAoZSkgPT4ge1xuICAgICAgICAgICAgRGVidWcuZXJyb3IoYEF0dGVtcHRlZCB0byByZXN1bWUgdGhlIEF1ZGlvQ29udGV4dCBvbiBTb3VuZE1hbmFnZXIucmVzdW1lKCksIGJ1dCBpdCB3YXMgcmVqZWN0ZWQgJHtlfWApO1xuICAgICAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgRGVidWcuZXJyb3IoYEF0dGVtcHRlZCB0byByZXN1bWUgdGhlIEF1ZGlvQ29udGV4dCBvbiBTb3VuZE1hbmFnZXIucmVzdW1lKCksIGJ1dCB0aHJldyBhbiBleGNlcHRpb24gJHtlfWApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyByZXN1bWUgdGhlIHNvdW5kIGNvbnRleHQgYW5kIGZpcmUgc3VzcGVuZCBldmVudCBpZiBpdCBzdWNjZWVkc1xuICAgIF9zdXNwZW5kKCkge1xuICAgICAgICB0aGlzLl9jb250ZXh0LnN1c3BlbmQoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZmlyZSgnc3VzcGVuZCcpO1xuICAgICAgICB9LCAoZSkgPT4ge1xuICAgICAgICAgICAgRGVidWcuZXJyb3IoYEF0dGVtcHRlZCB0byBzdXNwZW5kIHRoZSBBdWRpb0NvbnRleHQgb24gU291bmRNYW5hZ2VyLnN1c3BlbmQoKSwgYnV0IGl0IHdhcyByZWplY3RlZCAke2V9YCk7XG4gICAgICAgIH0pLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgICBEZWJ1Zy5lcnJvcihgQXR0ZW1wdGVkIHRvIHN1c3BlbmQgdGhlIEF1ZGlvQ29udGV4dCBvbiBTb3VuZE1hbmFnZXIuc3VzcGVuZCgpLCBidXQgdGhyZXcgYW4gZXhjZXB0aW9uICR7ZX1gKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX3VubG9ja0hhbmRsZXIoKSB7XG4gICAgICAgIHRoaXMuX3JlbW92ZVVubG9ja0xpc3RlbmVycygpO1xuXG4gICAgICAgIGlmICghdGhpcy5fdXNlclN1c3BlbmRlZCAmJiB0aGlzLl9jb250ZXh0LnN0YXRlICE9PSBDT05URVhUX1NUQVRFX1JVTk5JTkcpIHtcbiAgICAgICAgICAgIHRoaXMuX3Jlc3VtZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX3JlZ2lzdGVyVW5sb2NrTGlzdGVuZXJzKCkge1xuICAgICAgICAvLyBhdHRhY2ggdG8gYWxsIHVzZXIgaW5wdXQgZXZlbnRzXG4gICAgICAgIFVTRVJfSU5QVVRfRVZFTlRTLmZvckVhY2goKGV2ZW50TmFtZSkgPT4ge1xuICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCB0aGlzLl91bmxvY2tIYW5kbGVyRnVuYywgZmFsc2UpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfcmVtb3ZlVW5sb2NrTGlzdGVuZXJzKCkge1xuICAgICAgICBVU0VSX0lOUFVUX0VWRU5UUy5mb3JFYWNoKChldmVudE5hbWUpID0+IHtcbiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgdGhpcy5fdW5sb2NrSGFuZGxlckZ1bmMsIGZhbHNlKTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5leHBvcnQgeyBTb3VuZE1hbmFnZXIgfTtcbiJdLCJuYW1lcyI6WyJDT05URVhUX1NUQVRFX1JVTk5JTkciLCJVU0VSX0lOUFVUX0VWRU5UUyIsIlNvdW5kTWFuYWdlciIsIkV2ZW50SGFuZGxlciIsImNvbnN0cnVjdG9yIiwiX2NvbnRleHQiLCJBdWRpb0NvbnRleHQiLCJ3ZWJraXRBdWRpb0NvbnRleHQiLCJEZWJ1ZyIsIndhcm4iLCJfdW5sb2NrSGFuZGxlckZ1bmMiLCJfdW5sb2NrSGFuZGxlciIsImJpbmQiLCJfdXNlclN1c3BlbmRlZCIsImxpc3RlbmVyIiwiTGlzdGVuZXIiLCJfdm9sdW1lIiwidm9sdW1lIiwibWF0aCIsImNsYW1wIiwiZmlyZSIsInN1c3BlbmRlZCIsImNvbnRleHQiLCJzdGF0ZSIsIl9yZWdpc3RlclVubG9ja0xpc3RlbmVycyIsInN1c3BlbmQiLCJfc3VzcGVuZCIsInJlc3VtZSIsIl9yZXN1bWUiLCJkZXN0cm95IiwiX3RoaXMkX2NvbnRleHQiLCJfcmVtb3ZlVW5sb2NrTGlzdGVuZXJzIiwiY2xvc2UiLCJwbGF5U291bmQiLCJzb3VuZCIsIm9wdGlvbnMiLCJjaGFubmVsIiwiQ2hhbm5lbCIsInBsYXkiLCJwbGF5U291bmQzZCIsInBvc2l0aW9uIiwiQ2hhbm5lbDNkIiwic2V0UG9zaXRpb24iLCJzZXRWb2x1bWUiLCJsb29wIiwic2V0TG9vcCIsIm1heERpc3RhbmNlIiwic2V0TWF4RGlzdGFuY2UiLCJtaW5EaXN0YW5jZSIsInNldE1pbkRpc3RhbmNlIiwicm9sbE9mZkZhY3RvciIsInNldFJvbGxPZmZGYWN0b3IiLCJkaXN0YW5jZU1vZGVsIiwic2V0RGlzdGFuY2VNb2RlbCIsInRoZW4iLCJzb3VyY2UiLCJjcmVhdGVCdWZmZXJTb3VyY2UiLCJidWZmZXIiLCJjcmVhdGVCdWZmZXIiLCJzYW1wbGVSYXRlIiwiY29ubmVjdCIsImRlc3RpbmF0aW9uIiwic3RhcnQiLCJvbmVuZGVkIiwiZXZlbnQiLCJkaXNjb25uZWN0IiwiZSIsImVycm9yIiwiY2F0Y2giLCJmb3JFYWNoIiwiZXZlbnROYW1lIiwid2luZG93IiwiYWRkRXZlbnRMaXN0ZW5lciIsInJlbW92ZUV2ZW50TGlzdGVuZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFXQSxNQUFNQSxxQkFBcUIsR0FBRyxTQUFTLENBQUE7O0FBRXZDO0FBQ0E7QUFDQTtBQUNBLE1BQU1DLGlCQUFpQixHQUFHLENBQ3RCLE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxDQUNyQyxDQUFBOztBQUVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1DLFlBQVksU0FBU0MsWUFBWSxDQUFDO0FBQ3BDO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFdBQVdBLEdBQUc7QUFDVixJQUFBLEtBQUssRUFBRSxDQUFBOztBQUVQO0FBQ1I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtJQUNRLElBQUksQ0FBQ0MsUUFBUSxHQUFHLElBQUksQ0FBQTtBQUVwQixJ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
