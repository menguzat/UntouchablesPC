import { FloatPacking } from '../core/math/float-packing.js';
import { Texture } from '../platform/graphics/texture.js';
import { DeviceCache } from '../platform/graphics/device-cache.js';
import { ADDRESS_CLAMP_TO_EDGE, TEXTURETYPE_DEFAULT, FILTER_LINEAR, FILTER_NEAREST, PIXELFORMAT_RGBA32F, PIXELFORMAT_RGBA16F } from '../platform/graphics/constants.js';

// class used to hold LUT textures in the device cache
class AreaLightCacheEntry {
  constructor(texture0, texture1) {
    this.texture0 = texture0;
    this.texture1 = texture1;
  }
  destroy() {
    var _this$texture, _this$texture2;
    (_this$texture = this.texture0) == null ? void 0 : _this$texture.destroy();
    (_this$texture2 = this.texture1) == null ? void 0 : _this$texture2.destroy();
  }
}

// device cache storing LUT textures, taking care of their removal when the device is destroyed
const deviceCache = new DeviceCache();

// static class managing LUT tables for the area lights
class AreaLightLuts {
  static createTexture(device, format, size, postfix = '') {
    const tex = new Texture(device, {
      name: `AreaLightLUT${postfix}`,
      width: size,
      height: size,
      format: format,
      addressU: ADDRESS_CLAMP_TO_EDGE,
      addressV: ADDRESS_CLAMP_TO_EDGE,
      type: TEXTURETYPE_DEFAULT,
      magFilter: FILTER_LINEAR,
      minFilter: FILTER_NEAREST,
      anisotropy: 1,
      mipmaps: false
    });
    return tex;
  }
  static applyTextures(device, texture1, texture2) {
    // remove previous textures from cache
    deviceCache.remove(device);

    // add new textures to cache
    deviceCache.get(device, () => {
      return new AreaLightCacheEntry(texture1, texture1 === texture2 ? null : texture2);
    });

    // set them as uniforms
    device.scope.resolve('areaLightsLutTex1').setValue(texture1);
    device.scope.resolve('areaLightsLutTex2').setValue(texture2);
  }

  // placeholder LUT textures for area light
  static createPlaceholder(device) {
    const texture = AreaLightLuts.createTexture(device, device.areaLightLutFormat, 2, 'placeholder');
    const pixels = texture.lock();
    pixels.fill(0);
    texture.unlock();
    AreaLightLuts.applyTextures(device, texture, texture);
  }

  // creates LUT texture used by area lights
  static set(device, ltcMat1, ltcMat2) {
    function buildTexture(device, data, format) {
      const texture = AreaLightLuts.createTexture(device, format, 64);
      texture.lock().set(data);
      texture.unlock();
      return texture;
    }
    function offsetScale(data, offset, scale) {
      const count = data.length;
      const ret = new Float32Array(count);
      for (let i = 0; i < count; i++) {
        const n = i % 4;
        ret[i] = (data[i] + offset[n]) * scale[n];
      }
      return ret;
    }
    function convertToHalfFloat(data) {
      const count = data.length;
      const ret = new Uint16Array(count);
      const float2Half = FloatPacking.float2Half;
      for (let i = 0; i < count; i++) {
        ret[i] = float2Half(data[i]);
      }
      return ret;
    }
    function convertToUint(data) {
      const count = data.length;
      const ret = new Uint8ClampedArray(count);
      for (let i = 0; i < count; i++) {
        ret[i] = data[i] * 255;
      }
      return ret;
    }
    const srcData1 = ltcMat1;
    const srcData2 = ltcMat2;

    // pick format for lut texture
    let data1, data2;
    const format = device.areaLightLutFormat;
    if (format === PIXELFORMAT_RGBA32F) {
      // float
      data1 = srcData1;
      data2 = srcData2;
    } else if (format === PIXELFORMAT_RGBA16F) {
      // half float
      data1 = convertToHalfFloat(srcData1);
      data2 = convertToHalfFloat(srcData2);
    } else {
      // low precision format
      // offset and scale to avoid clipping and increase precision - this is undone in the shader
      const o1 = [0.0, 0.2976, 0.01381, 0.0];
      const s1 = [0.999, 3.08737, 1.6546, 0.603249];
      const o2 = [-0.306897, 0.0, 0.0, 0.0];
      const s2 = [1.442787, 1.0, 1.0, 1.0];
      data1 = convertToUint(offsetScale(srcData1, o1, s1));
      data2 = convertToUint(offsetScale(srcData2, o2, s2));
    }

    // create lut textures
    const tex1 = buildTexture(device, data1, format);
    const tex2 = buildTexture(device, data2, format);

    // assign to uniforms
    AreaLightLuts.applyTextures(device, tex1, tex2);
  }
}

export { AreaLightLuts };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJlYS1saWdodC1sdXRzLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2NlbmUvYXJlYS1saWdodC1sdXRzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZsb2F0UGFja2luZyB9IGZyb20gJy4uL2NvcmUvbWF0aC9mbG9hdC1wYWNraW5nLmpzJztcbmltcG9ydCB7IFRleHR1cmUgfSBmcm9tICcuLi9wbGF0Zm9ybS9ncmFwaGljcy90ZXh0dXJlLmpzJztcbmltcG9ydCB7IERldmljZUNhY2hlIH0gZnJvbSAnLi4vcGxhdGZvcm0vZ3JhcGhpY3MvZGV2aWNlLWNhY2hlLmpzJztcblxuaW1wb3J0IHtcbiAgICBBRERSRVNTX0NMQU1QX1RPX0VER0UsXG4gICAgRklMVEVSX0xJTkVBUiwgRklMVEVSX05FQVJFU1QsXG4gICAgUElYRUxGT1JNQVRfUkdCQTE2RiwgUElYRUxGT1JNQVRfUkdCQTMyRixcbiAgICBURVhUVVJFVFlQRV9ERUZBVUxUXG59IGZyb20gJy4uL3BsYXRmb3JtL2dyYXBoaWNzL2NvbnN0YW50cy5qcyc7XG5cbi8vIGNsYXNzIHVzZWQgdG8gaG9sZCBMVVQgdGV4dHVyZXMgaW4gdGhlIGRldmljZSBjYWNoZVxuY2xhc3MgQXJlYUxpZ2h0Q2FjaGVFbnRyeSB7XG4gICAgY29uc3RydWN0b3IodGV4dHVyZTAsIHRleHR1cmUxKSB7XG4gICAgICAgIHRoaXMudGV4dHVyZTAgPSB0ZXh0dXJlMDtcbiAgICAgICAgdGhpcy50ZXh0dXJlMSA9IHRleHR1cmUxO1xuICAgIH1cblxuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMudGV4dHVyZTA/LmRlc3Ryb3koKTtcbiAgICAgICAgdGhpcy50ZXh0dXJlMT8uZGVzdHJveSgpO1xuICAgIH1cbn1cblxuLy8gZGV2aWNlIGNhY2hlIHN0b3JpbmcgTFVUIHRleHR1cmVzLCB0YWtpbmcgY2FyZSBvZiB0aGVpciByZW1vdmFsIHdoZW4gdGhlIGRldmljZSBpcyBkZXN0cm95ZWRcbmNvbnN0IGRldmljZUNhY2hlID0gbmV3IERldmljZUNhY2hlKCk7XG5cbi8vIHN0YXRpYyBjbGFzcyBtYW5hZ2luZyBMVVQgdGFibGVzIGZvciB0aGUgYXJlYSBsaWdodHNcbmNsYXNzIEFyZWFMaWdodEx1dHMge1xuICAgIHN0YXRpYyBjcmVhdGVUZXh0dXJlKGRldmljZSwgZm9ybWF0LCBzaXplLCBwb3N0Zml4ID0gJycpIHtcbiAgICAgICAgY29uc3QgdGV4ID0gbmV3IFRleHR1cmUoZGV2aWNlLCB7XG4gICAgICAgICAgICBuYW1lOiBgQXJlYUxpZ2h0TFVUJHtwb3N0Zml4fWAsXG4gICAgICAgICAgICB3aWR0aDogc2l6ZSxcbiAgICAgICAgICAgIGhlaWdodDogc2l6ZSxcbiAgICAgICAgICAgIGZvcm1hdDogZm9ybWF0LFxuICAgICAgICAgICAgYWRkcmVzc1U6IEFERFJFU1NfQ0xBTVBfVE9fRURHRSxcbiAgICAgICAgICAgIGFkZHJlc3NWOiBBRERSRVNTX0NMQU1QX1RPX0VER0UsXG4gICAgICAgICAgICB0eXBlOiBURVhUVVJFVFlQRV9ERUZBVUxULFxuICAgICAgICAgICAgbWFnRmlsdGVyOiBGSUxURVJfTElORUFSLFxuICAgICAgICAgICAgbWluRmlsdGVyOiBGSUxURVJfTkVBUkVTVCxcbiAgICAgICAgICAgIGFuaXNvdHJvcHk6IDEsXG4gICAgICAgICAgICBtaXBtYXBzOiBmYWxzZVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRleDtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXBwbHlUZXh0dXJlcyhkZXZpY2UsIHRleHR1cmUxLCB0ZXh0dXJlMikge1xuICAgICAgICAvLyByZW1vdmUgcHJldmlvdXMgdGV4dHVyZXMgZnJvbSBjYWNoZVxuICAgICAgICBkZXZpY2VDYWNoZS5yZW1vdmUoZGV2aWNlKTtcblxuICAgICAgICAvLyBhZGQgbmV3IHRleHR1cmVzIHRvIGNhY2hlXG4gICAgICAgIGRldmljZUNhY2hlLmdldChkZXZpY2UsICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQXJlYUxpZ2h0Q2FjaGVFbnRyeSh0ZXh0dXJlMSwgdGV4dHVyZTEgPT09IHRleHR1cmUyID8gbnVsbCA6IHRleHR1cmUyKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gc2V0IHRoZW0gYXMgdW5pZm9ybXNcbiAgICAgICAgZGV2aWNlLnNjb3BlLnJlc29sdmUoJ2FyZWFMaWdodHNMdXRUZXgxJykuc2V0VmFsdWUodGV4dHVyZTEpO1xuICAgICAgICBkZXZpY2Uuc2NvcGUucmVzb2x2ZSgnYXJlYUxpZ2h0c0x1dFRleDInKS5zZXRWYWx1ZSh0ZXh0dXJlMik7XG4gICAgfVxuXG4gICAgLy8gcGxhY2Vob2xkZXIgTFVUIHRleHR1cmVzIGZvciBhcmVhIGxpZ2h0XG4gICAgc3RhdGljIGNyZWF0ZVBsYWNlaG9sZGVyKGRldmljZSkge1xuICAgICAgICBjb25zdCB0ZXh0dXJlID0gQXJlYUxpZ2h0THV0cy5jcmVhdGVUZXh0dXJlKGRldmljZSwgZGV2aWNlLmFyZWFMaWdodEx1dEZvcm1hdCwgMiwgJ3BsYWNlaG9sZGVyJyk7XG5cbiAgICAgICAgY29uc3QgcGl4ZWxzID0gdGV4dHVyZS5sb2NrKCk7XG4gICAgICAgIHBpeGVscy5maWxsKDApO1xuICAgICAgICB0ZXh0dXJlLnVubG9jaygpO1xuXG4gICAgICAgIEFyZWFMaWdodEx1dHMuYXBwbHlUZXh0dXJlcyhkZXZpY2UsIHRleHR1cmUsIHRleHR1cmUpO1xuICAgIH1cblxuICAgIC8vIGNyZWF0ZXMgTFVUIHRleHR1cmUgdXNlZCBieSBhcmVhIGxpZ2h0c1xuICAgIHN0YXRpYyBzZXQoZGV2aWNlLCBsdGNNYXQxLCBsdGNNYXQyKSB7XG5cbiAgICAgICAgZnVuY3Rpb24gYnVpbGRUZXh0dXJlKGRldmljZSwgZGF0YSwgZm9ybWF0KSB7XG4gICAgICAgICAgICBjb25zdCB0ZXh0dXJlID0gQXJlYUxpZ2h0THV0cy5jcmVhdGVUZXh0dXJlKGRldmljZSwgZm9ybWF0LCA2NCk7XG5cbiAgICAgICAgICAgIHRleHR1cmUubG9jaygpLnNldChkYXRhKTtcbiAgICAgICAgICAgIHRleHR1cmUudW5sb2NrKCk7XG5cbiAgICAgICAgICAgIHJldHVybiB0ZXh0dXJlO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gb2Zmc2V0U2NhbGUoZGF0YSwgb2Zmc2V0LCBzY2FsZSkge1xuXG4gICAgICAgICAgICBjb25zdCBjb3VudCA9IGRhdGEubGVuZ3RoO1xuICAgICAgICAgICAgY29uc3QgcmV0ID0gbmV3IEZsb2F0MzJBcnJheShjb3VudCk7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuID0gaSAlIDQ7XG4gICAgICAgICAgICAgICAgcmV0W2ldID0gKGRhdGFbaV0gKyBvZmZzZXRbbl0pICogc2NhbGVbbl07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gY29udmVydFRvSGFsZkZsb2F0KGRhdGEpIHtcblxuICAgICAgICAgICAgY29uc3QgY291bnQgPSBkYXRhLmxlbmd0aDtcbiAgICAgICAgICAgIGNvbnN0IHJldCA9IG5ldyBVaW50MTZBcnJheShjb3VudCk7XG4gICAgICAgICAgICBjb25zdCBmbG9hdDJIYWxmID0gRmxvYXRQYWNraW5nLmZsb2F0MkhhbGY7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcbiAgICAgICAgICAgICAgICByZXRbaV0gPSBmbG9hdDJIYWxmKGRhdGFbaV0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gY29udmVydFRvVWludChkYXRhKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGF0YS5sZW5ndGg7XG4gICAgICAgICAgICBjb25zdCByZXQgPSBuZXcgVWludDhDbGFtcGVkQXJyYXkoY291bnQpO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgcmV0W2ldID0gZGF0YVtpXSAqIDI1NTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNyY0RhdGExID0gbHRjTWF0MTtcbiAgICAgICAgY29uc3Qgc3JjRGF0YTIgPSBsdGNNYXQyO1xuXG4gICAgICAgIC8vIHBpY2sgZm9ybWF0IGZvciBsdXQgdGV4dHVyZVxuICAgICAgICBsZXQgZGF0YTEsIGRhdGEyO1xuICAgICAgICBjb25zdCBmb3JtYXQgPSBkZXZpY2UuYXJlYUxpZ2h0THV0Rm9ybWF0O1xuICAgICAgICBpZiAoZm9ybWF0ID09PSBQSVhFTEZPUk1BVF9SR0JBMzJGKSB7XG5cbiAgICAgICAgICAgIC8vIGZsb2F0XG4gICAgICAgICAgICBkYXRhMSA9IHNyY0RhdGExO1xuICAgICAgICAgICAgZGF0YTIgPSBzcmNEYXRhMjtcblxuICAgICAgICB9IGVsc2UgaWYgKGZvcm1hdCA9PT0gUElYRUxGT1JNQVRfUkdCQTE2Rikge1xuXG4gICAgICAgICAgICAvLyBoYWxmIGZsb2F0XG4gICAgICAgICAgICBkYXRhMSA9IGNvbnZlcnRUb0hhbGZGbG9hdChzcmNEYXRhMSk7XG4gICAgICAgICAgICBkYXRhMiA9IGNvbnZlcnRUb0hhbGZGbG9hdChzcmNEYXRhMik7XG5cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgLy8gbG93IHByZWNpc2lvbiBmb3JtYXRcbiAgICAgICAgICAgIC8vIG9mZnNldCBhbmQgc2NhbGUgdG8gYXZvaWQgY2xpcHBpbmcgYW5kIGluY3JlYXNlIHByZWNpc2lvbiAtIHRoaXMgaXMgdW5kb25lIGluIHRoZSBzaGFkZXJcbiAgICAgICAgICAgIGNvbnN0IG8xID0gWzAuMCwgMC4yOTc2LCAwLjAxMzgxLCAwLjBdO1xuICAgICAgICAgICAgY29uc3QgczEgPSBbMC45OTksIDMuMDg3MzcsIDEuNjU0NiwgMC42MDMyNDldO1xuXG4gICAgICAgICAgICBjb25zdCBvMiA9IFstMC4zMDY4OTcsIDAuMCwgMC4wLCAwLjBdO1xuICAgICAgICAgICAgY29uc3QgczIgPSBbMS40NDI3ODcsIDEuMCwgMS4wLCAxLjBdO1xuXG4gICAgICAgICAgICBkYXRhMSA9IGNvbnZlcnRUb1VpbnQob2Zmc2V0U2NhbGUoc3JjRGF0YTEsIG8xLCBzMSkpO1xuICAgICAgICAgICAgZGF0YTIgPSBjb252ZXJ0VG9VaW50KG9mZnNldFNjYWxlKHNyY0RhdGEyLCBvMiwgczIpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGNyZWF0ZSBsdXQgdGV4dHVyZXNcbiAgICAgICAgY29uc3QgdGV4MSA9IGJ1aWxkVGV4dHVyZShkZXZpY2UsIGRhdGExLCBmb3JtYXQpO1xuICAgICAgICBjb25zdCB0ZXgyID0gYnVpbGRUZXh0dXJlKGRldmljZSwgZGF0YTIsIGZvcm1hdCk7XG5cbiAgICAgICAgLy8gYXNzaWduIHRvIHVuaWZvcm1zXG4gICAgICAgIEFyZWFMaWdodEx1dHMuYXBwbHlUZXh0dXJlcyhkZXZpY2UsIHRleDEsIHRleDIpO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgQXJlYUxpZ2h0THV0cyB9O1xuIl0sIm5hbWVzIjpbIkFyZWFMaWdodENhY2hlRW50cnkiLCJjb25zdHJ1Y3RvciIsInRleHR1cmUwIiwidGV4dHVyZTEiLCJkZXN0cm95IiwiX3RoaXMkdGV4dHVyZSIsIl90aGlzJHRleHR1cmUyIiwiZGV2aWNlQ2FjaGUiLCJEZXZpY2VDYWNoZSIsIkFyZWFMaWdodEx1dHMiLCJjcmVhdGVUZXh0dXJlIiwiZGV2aWNlIiwiZm9ybWF0Iiwic2l6ZSIsInBvc3RmaXgiLCJ0ZXgiLCJUZXh0dXJlIiwibmFtZSIsIndpZHRoIiwiaGVpZ2h0IiwiYWRkcmVzc1UiLCJBRERSRVNTX0NMQU1QX1RPX0VER0UiLCJhZGRyZXNzViIsInR5cGUiLCJURVhUVVJFVFlQRV9ERUZBVUxUIiwibWFnRmlsdGVyIiwiRklMVEVSX0xJTkVBUiIsIm1pbkZpbHRlciIsIkZJTFRFUl9ORUFSRVNUIiwiYW5pc290cm9weSIsIm1pcG1hcHMiLCJhcHBseVRleHR1cmVzIiwidGV4dHVyZTIiLCJyZW1vdmUiLCJnZXQiLCJzY29wZSIsInJlc29sdmUiLCJzZXRWYWx1ZSIsImNyZWF0ZVBsYWNlaG9sZGVyIiwidGV4dHVyZSIsImFyZWFMaWdodEx1dEZvcm1hdCIsInBpeGVscyIsImxvY2siLCJmaWxsIiwidW5sb2NrIiwic2V0IiwibHRjTWF0MSIsImx0Y01hdDIiLCJidWlsZFRleHR1cmUiLCJkYXRhIiwib2Zmc2V0U2NhbGUiLCJvZmZzZXQiLCJzY2FsZSIsImNvdW50IiwibGVuZ3RoIiwicmV0IiwiRmxvYXQzMkFycmF5IiwiaSIsIm4iLCJjb252ZXJ0VG9IYWxmRmxvYXQiLCJVaW50MTZBcnJheSIsImZsb2F0MkhhbGYiLCJGbG9hdFBhY2tpbmciLCJjb252ZXJ0VG9VaW50IiwiVWludDhDbGFtcGVkQXJyYXkiLCJzcmNEYXRhMSIsInNyY0RhdGEyIiwiZGF0YTEiLCJkYXRhMiIsIlBJWEVMRk9STUFUX1JHQkEzMkYiLCJQSVhFTEZPUk1BVF9SR0JBMTZGIiwibzEiLCJzMSIsIm8yIiwiczIiLCJ0ZXgxIiwidGV4MiJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFXQTtBQUNBLE1BQU1BLG1CQUFtQixDQUFDO0FBQ3RCQyxFQUFBQSxXQUFXQSxDQUFDQyxRQUFRLEVBQUVDLFFBQVEsRUFBRTtJQUM1QixJQUFJLENBQUNELFFBQVEsR0FBR0EsUUFBUSxDQUFBO0lBQ3hCLElBQUksQ0FBQ0MsUUFBUSxHQUFHQSxRQUFRLENBQUE7QUFDNUIsR0FBQTtBQUVBQyxFQUFBQSxPQUFPQSxHQUFHO0lBQUEsSUFBQUMsYUFBQSxFQUFBQyxjQUFBLENBQUE7SUFDTixDQUFBRCxhQUFBLE9BQUksQ0FBQ0gsUUFBUSxxQkFBYkcsYUFBQSxDQUFlRCxPQUFPLEVBQUUsQ0FBQTtJQUN4QixDQUFBRSxjQUFBLE9BQUksQ0FBQ0gsUUFBUSxx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
