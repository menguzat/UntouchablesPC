import{Quat as t}from"../../core/math/quat.js";import{PIXELFORMAT_DXT5 as i,TEXTURETYPE_SWIZZLEGGGR as e,PIXELFORMAT_RGBA8 as n}from"../../platform/graphics/constants.js";import{SHADER_FORWARDHDR as s,GAMMA_SRGBHDR as o,TONEMAP_LINEAR as l,SHADERDEF_TANGENTS as a,SHADERDEF_SCREENSPACE as p,SHADERDEF_SKIN as r,SHADERDEF_INSTANCING as c,SHADERDEF_MORPH_POSITION as u,SHADERDEF_MORPH_NORMAL as d,SHADERDEF_MORPH_TEXTURE_BASED as g,BLEND_NONE as h,SPECULAR_PHONG as O,GAMMA_NONE as f,SHADERDEF_NOSHADOW as M,SHADERDEF_LM as m,SHADERDEF_DIRLM as b,SHADERDEF_LMAMBIENT as S,MASK_AFFECT_DYNAMIC as v,LIGHTTYPE_DIRECTIONAL as T,LIGHTTYPE_OMNI as y,LIGHTTYPE_SPOT as E,SHADERDEF_UV0 as C,SHADERDEF_UV1 as x,SHADERDEF_VCOLOR as L}from"../constants.js";import{_matTex2D as _}from"../shader-lib/programs/standard.js";const A=(t,i)=>{if(t.length!==i.length)return!1;for(let e=0;e<t.length;++e)if(t[e]!==i[e])return!1;return!0},k=t=>1!==t.r||1!==t.g||1!==t.b;class F{constructor(){this._mapXForms=null}updateMinRef(t,i,e,n,s,o,l){this._updateSharedOptions(t,i,e,n,o),this._updateMinOptions(t,e),this._updateUVOptions(t,e,n,!0),t.litOptions.chunks=t.chunks}updateRef(t,i,e,n,p,r,c){this._updateSharedOptions(t,i,e,n,r),this._updateEnvOptions(t,e,i),this._updateMaterialOptions(t,e),r===s&&(t.litOptions.gamma&&(t.litOptions.gamma=o),t.litOptions.toneMap=l),t.litOptions.hasTangents=n&&0!=(n&a),this._updateLightOptions(t,i,e,n,c,p),this._updateUVOptions(t,e,n,!1),t.litOptions.chunks=t.chunks}_updateSharedOptions(t,i,e,n,s){t.forceUv1=e.forceUv1,t.chunks=e.chunks||"",t.pass=s,t.litOptions.alphaTest=e.alphaTest>0,t.litOptions.forceFragmentPrecision=e.forceFragmentPrecision||"",t.litOptions.blendType=e.blendType,t.litOptions.separateAmbient=!1,t.litOptions.screenSpace=n&&0!=(n&p),t.litOptions.skin=n&&0!=(n&r),t.litOptions.useInstancing=n&&0!=(n&c),t.litOptions.useMorphPosition=n&&0!=(n&u),t.litOptions.useMorphNormal=n&&0!=(n&d),t.litOptions.useMorphTextureBased=n&&0!=(n&g),t.litOptions.nineSlicedMode=e.nineSlicedMode||0,i.clusteredLightingEnabled&&e.useLighting?(t.litOptions.clusteredLightingEnabled=!0,t.litOptions.clusteredLightingCookiesEnabled=i.lighting.cookiesEnabled,t.litOptions.clusteredLightingShadowsEnabled=i.lighting.shadowsEnabled,t.litOptions.clusteredLightingShadowType=i.lighting.shadowType,t.litOptions.clusteredLightingAreaLightsEnabled=i.lighting.areaLightsEnabled):(t.litOptions.clusteredLightingEnabled=!1,t.litOptions.clusteredLightingCookiesEnabled=!1,t.litOptions.clusteredLightingShadowsEnabled=!1,t.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(t,i,e,n){let s=!1,o=!1,l=!1;e&&(s=0!=(e&C),o=0!=(e&x),l=0!=(e&L)),t.litOptions.vertexColors=!1,this._mapXForms=[];const a={};for(const e in _)this._updateTexOptions(t,i,e,s,o,l,n,a);this._mapXForms=null,t.litOptions.lightMapEnabled=t.lightMap,t.litOptions.useLightMapVertexColors=t.lightVertexColor,t.litOptions.dirLightMapEnabled=t.dirLightMap,t.litOptions.heightMapEnabled=t.heightMap,t.litOptions.normalMapEnabled=t.normalMap,t.litOptions.clearCoatNormalMapEnabled=t.clearCoatNormalMap,t.litOptions.aoMapEnabled=t.aoMap,t.litOptions.useAoVertexColors=t.aoVertexColor,t.litOptions.diffuseMapEnabled=t.diffuseMap}_updateTexOptions(t,i,e,n,s,o,l,a){const p=e+"Map",r=e+"VertexColor",c=e+"VertexColorChannel",u=p+"Channel",d=p+"Transform",g=p+"Uv",O=p+"Identifier";"light"!==e&&(t[p]=!1,t[O]=void 0,t[u]="",t[d]=0,t[g]=0),t[r]=!1,t[c]="";const f="opacity"===e;if((!f||i.blendType!==h||0!==i.alphaTest||i.alphaToCoverage)&&(!l||f)&&("height"!==e&&i[r]&&o&&(t[r]=i[r],t[c]=i[c],t.litOptions.vertexColors=!0),i[p])){let o=!0;if(0!==i[g]||n||(o=!1),1!==i[g]||s||(o=!1),o){const n=i[p].id;let s=a[n];void 0===s&&(a[n]=e,s=e),t[p]=!!i[p],t[O]=s,t[d]=this._getMapTransformID(i.getUniform(d),i[g]),t[u]=i[u],t[g]=i[g]}}}_updateMinOptions(t,i){t.opacityTint=1!==i.opacity&&i.blendType!==h,t.litOptions.lights=[]}_updateMaterialOptions(t,n){var s,o,l,a;const p=(n.diffuseTint||!n.diffuseMap&&!n.diffuseVertexColor)&&k(n.diffuse),r=!!(n.useMetalness||n.specularMap||n.sphereMap||n.cubeMap||(c=n.specular,0!==c.r||0!==c.g||0!==c.b)||n.specularityFactor>0&&n.useMetalness||n.enableGGXSpecular||n.clearCoat>0);var c;const u=!n.useMetalness||n.useMetalnessSpecularColor,d=r&&(n.specularTint||!n.specularMap&&!n.specularVertexColor)&&k(n.specular),g=r&&n.useMetalnessSpecularColor&&(n.specularityFactorTint||n.specularityFactor<1&&!n.specularityFactorMap),f=!n.emissiveMap||k(n.emissive)&&n.emissiveTint,M=1!==n.emissiveIntensity,m=!!n.normalMap&&(n.normalMap.format===i||n.normalMap.type===e);t.opacityTint=1!==n.opacity&&n.blendType!==h?1:0,t.ambientTint=n.ambientTint,t.diffuseTint=p?2:0,t.specularTint=d?2:0,t.specularityFactorTint=g?1:0,t.metalnessTint=n.useMetalness&&n.metalness<1?1:0,t.glossTint=1,t.emissiveTint=(f?2:0)+(M?1:0),t.diffuseEncoding=null==(s=n.diffuseMap)?void 0:s.encoding,t.diffuseDetailEncoding=null==(o=n.diffuseDetailMap)?void 0:o.encoding,t.emissiveEncoding=null==(l=n.emissiveMap)?void 0:l.encoding,t.lightMapEncoding=null==(a=n.lightMap)?void 0:a.encoding,t.packedNormal=m,t.refractionTint=1!==n.refraction?1:0,t.refractionIndexTint=n.refractionIndex!==1/1.5?1:0,t.thicknessTint=n.useDynamicRefraction&&1!==n.thickness?1:0,t.specularEncoding=n.specularEncoding||"linear",t.sheenEncoding=n.sheenEncoding||"linear",t.aoMapUv=n.aoUvSet,t.diffuseDetail=!!n.diffuseMap,t.normalDetail=!!n.normalMap,t.diffuseDetailMode=n.diffuseDetailMode,t.clearCoatTint=1!==n.clearCoat?1:0,t.clearCoatGloss=!!n.clearCoatGloss,t.clearCoatGlossTint=1!==n.clearCoatGloss?1:0,t.iridescenceTint=1!==n.iridescence?1:0,t.sheenTint=n.useSheen&&k(n.sheen)?2:0,t.sheenGlossTint=1,t.glossInvert=n.glossInvert,t.sheenGlossInvert=n.sheenGlossInvert,t.clearCoatGlossInvert=n.clearCoatGlossInvert,t.litOptions.useAmbientTint=t.ambientTint,t.litOptions.customFragmentShader=n.customFragmentShader,t.litOptions.pixelSnap=n.pixelSnap,t.litOptions.useClearCoatNormalMap=!!n.clearCoatNormalMap,t.litOptions.useDiffuseMap=!!n.diffuseMap,t.litOptions.useAoMap=!!n.aoMap,t.litOptions.detailModes=!!t.diffuseDetail,t.litOptions.shadingModel=n.shadingModel,t.litOptions.ambientSH=!!n.ambientSH,t.litOptions.fastTbn=n.fastTbn,t.litOptions.twoSidedLighting=n.twoSidedLighting,t.litOptions.occludeSpecular=n.occludeSpecular,t.litOptions.occludeSpecularFloat=1!==n.occludeSpecularIntensity,t.litOptions.useMsdf=!!n.msdfMap,t.litOptions.msdfTextAttribute=!!n.msdfTextAttribute,t.litOptions.alphaToCoverage=n.alphaToCoverage,t.litOptions.opacityFadesSpecular=n.opacityFadesSpecular,t.litOptions.cubeMapProjection=n.cubeMapProjection,t.litOptions.occludeDirect=n.occludeDirect,t.litOptions.conserveEnergy=n.conserveEnergy&&n.shadingModel!==O,t.litOptions.useSpecular=r,t.litOptions.useSpecularityFactor=(g||!!n.specularityFactorMap)&&n.useMetalnessSpecularColor,t.litOptions.useSpecularColor=u,t.litOptions.enableGGXSpecular=n.enableGGXSpecular,t.litOptions.fresnelModel=n.fresnelModel,t.litOptions.useRefraction=(n.refraction||!!n.refractionMap)&&(n.useDynamicRefraction||!!t.litOptions.reflectionSource),t.litOptions.useClearCoat=!!n.clearCoat,t.litOptions.useSheen=n.useSheen,t.litOptions.useIridescence=n.useIridescence&&0!==n.iridescence,t.litOptions.useMetalness=n.useMetalness,t.litOptions.useDynamicRefraction=n.useDynamicRefraction}_updateEnvOptions(i,e,n){i.litOptions.fog=e.useFog?n.fog:"none",i.litOptions.gamma=e.useGammaTonemap?n.gammaCorrection:f,i.litOptions.toneMap=e.useGammaTonemap?n.toneMapping:-1,i.litOptions.fixSeams=!!e.cubeMap&&e.cubeMap.fixCubemapSeams;const s=e.shadingModel===O;let o=!1;if(e.envAtlas&&e.cubeMap&&!s?(i.litOptions.reflectionSource="envAtlasHQ",i.litOptions.reflectionEncoding=e.envAtlas.encoding):e.envAtlas&&!s?(i.litOptions.reflectionSource="envAtlas",i.litOptions.reflectionEncoding=e.envAtlas.encoding):e.cubeMap?(i.litOptions.reflectionSource="cubeMap",i.litOptions.reflectionEncoding=e.cubeMap.encoding):e.sphereMap?(i.litOptions.reflectionSource="sphereMap",i.litOptions.reflectionEncoding=e.sphereMap.encoding):e.useSkybox&&n.envAtlas&&n.skybox&&!s?(i.litOptions.reflectionSource="envAtlasHQ",i.litOptions.reflectionEncoding=n.envAtlas.encoding,o=!0):e.useSkybox&&n.envAtlas&&!s?(i.litOptions.reflectionSource="envAtlas",i.litOptions.reflectionEncoding=n.envAtlas.encoding,o=!0):e.useSkybox&&n.skybox?(i.litOptions.reflectionSource="cubeMap",i.litOptions.reflectionEncoding=n.skybox.encoding,o=!0):(i.litOptions.reflectionSource=null,i.litOptions.reflectionEncoding=null),e.ambientSH&&!s)i.litOptions.ambientSource="ambientSH",i.litOptions.ambientEncoding=null;else{const t=e.envAtlas||(e.useSkybox&&n.envAtlas?n.envAtlas:null);t&&!s?(i.litOptions.ambientSource="envAtlas",i.litOptions.ambientEncoding=t.encoding):(i.litOptions.ambientSource="constant",i.litOptions.ambientEncoding=null)}i.litOptions.skyboxIntensity=o&&(1!==n.skyboxIntensity||n.physicalUnits),i.litOptions.useCubeMapRotation=o&&n.skyboxRotation&&!n.skyboxRotation.equals(t.IDENTITY)}_updateLightOptions(t,i,e,s,o,l){if(t.lightMap=!1,t.lightMapChannel="",t.lightMapUv=0,t.lightMapTransform=0,t.litOptions.lightMapWithoutAmbient=!1,t.dirLightMap=!1,s&&(t.litOptions.noShadow=0!=(s&M),0!=(s&m)&&(t.lightMapEncoding=i.lightmapPixelFormat===n?"rgbm":"linear",t.lightMap=!0,t.lightMapChannel="rgb",t.lightMapUv=1,t.lightMapTransform=0,t.litOptions.lightMapWithoutAmbient=!e.lightMap,0!=(s&b)&&(t.dirLightMap=!0),0!=(s&S)&&(t.litOptions.lightMapWithoutAmbient=!1))),e.useLighting){const i=[],e=s?s>>16:v;t.litOptions.lightMaskDynamic=!!(e&v),o&&(this._collectLights(T,o[T],i,e),this._collectLights(y,o[y],i,e,l),this._collectLights(E,o[E],i,e,l)),t.litOptions.lights=i}else t.litOptions.lights=[];0===t.litOptions.lights.length&&(t.litOptions.noShadow=!0)}_collectLights(t,i,e,n,s){for(let s=0;s<i.length;s++){const o=i[s];if(o.enabled&&o.mask&n){if(t!==T&&o.isStatic)continue;e.push(o)}}if(s)for(let i=0;i<s.length;i++){const n=s[i];n._type===t&&e.push(n)}}_getMapTransformID(t,i){if(!t)return 0;let e=this._mapXForms[i];e||(e=[],this._mapXForms[i]=e);for(let i=0;i<e.length;i++)if(A(e[i][0].value,t[0].value)&&A(e[i][1].value,t[1].value))return i+1;return e.push(t)}}export{F as StandardMaterialOptionsBuilder};
