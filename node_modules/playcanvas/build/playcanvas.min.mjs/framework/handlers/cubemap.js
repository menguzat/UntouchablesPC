import{ADDRESS_CLAMP_TO_EDGE as e,PIXELFORMAT_RGB8 as l,PIXELFORMAT_RGBA8 as t,TEXTURETYPE_RGBM as s,TEXTURETYPE_DEFAULT as n}from"../../platform/graphics/constants.js";import{Texture as r}from"../../platform/graphics/texture.js";import{Asset as a}from"../asset/asset.js";class i{constructor(e){this.handlerType="cubemap",this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader}load(e,l,t){this.loadAssets(t,l)}open(e,l,t){return t?t.resource:null}patch(e,l){this.loadAssets(e,(function(t,s){t&&(l.fire("error",e),l.fire("error:"+e.id,t,e),e.fire("error",e))}))}getAssetIds(e){const l=[];if(l[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(let t=0;t<6;++t)l[t+1]=e.data.textures[t];else l[1]=l[2]=l[3]=l[4]=l[5]=l[6]=null;return l}compareAssetIds(e,l){return e&&l?parseInt(e,10)===e||"string"==typeof e?e===l:e.url===l.url:null!==e==(null!==l)}update(a,i,o){const u=a.data||{},d=a._handlerState.assets,p=a._resources;let c,f,m;const h=[null,null,null,null,null,null,null],g=function(){return u.hasOwnProperty("type")?u.type:u.hasOwnProperty("rgbm")?u.rgbm?s:n:null};if(a.loaded&&o[0]===d[0])h[1]=p[1]||null,h[2]=p[2]||null,h[3]=p[3]||null,h[4]=p[4]||null,h[5]=p[5]||null,h[6]=p[6]||null;else if(o[0])for(c=o[0].resource,m=0;m<6;++m)h[m+1]=new r(this._device,{name:a.name+"_prelitCubemap"+(c.width>>m),cubemap:!0,type:g()||c.type,width:c.width>>m,height:c.height>>m,format:c.format,levels:[c._levels[m]],fixCubemapSeams:!0,addressU:e,addressV:e,mipmaps:0===m});const y=o.slice(1);if(a.loaded&&this.cmpArrays(y,d.slice(1)))h[0]=p[0]||null;else if(-1===y.indexOf(null)){var _;const s=y.map((function(e){return e.resource})),n=[];for(f=0;f<s[0]._levels.length;++f)n.push(s.map((function(e){return e._levels[f]})));const i=s[0].format,d=new r(this._device,{name:a.name+"_faces",cubemap:!0,type:g()||s[0].type,width:s[0].width,height:s[0].height,format:i===l?t:i,mipmaps:null==(_=u.mipmaps)||_,levels:n,minFilter:u.hasOwnProperty("minFilter")?u.minFilter:s[0].minFilter,magFilter:u.hasOwnProperty("magFilter")?u.magFilter:s[0].magFilter,anisotropy:u.hasOwnProperty("anisotropy")?u.anisotropy:1,addressU:e,addressV:e,fixCubemapSeams:!!o[0]});h[0]=d}if(!this.cmpArrays(h,p))for(a.resources=h,a._handlerState.assetIds=i,a._handlerState.assets=o,m=0;m<p.length;++m)null!==p[m]&&-1===h.indexOf(p[m])&&p[m].destroy();for(m=0;m<d.length;++m)null!==d[m]&&-1===o.indexOf(d[m])&&d[m].unload()}cmpArrays(e,l){if(e.length!==l.length)return!1;for(let t=0;t<e.length;++t)if(e[t]!==l[t])return!1;return!0}resolveId(e){const l=parseInt(e,10);return l===e||l.toString()===e?l:e}loadAssets(e,l){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const t=this,s=t.getAssetIds(e),n=[null,null,null,null,null,null,null],r=e._handlerState.assetIds,i=e._handlerState.assets,o=t._registry;let u=7;const d=function(r,a){n[r]=a,u--,0===u&&(t.update(e,s,n),l(null,e.resources))},p=function(e,t,s){l(t)},c=function(e,l){l.loaded?d(e,l):(o.once("load:"+l.id,d.bind(t,e)),o.once("error:"+l.id,p.bind(t,e)),l.loading||o.load(l))};let f;for(let l=0;l<7;++l){const n=this.resolveId(s[l]);if(n)if(t.compareAssetIds(n,r[l]))d(l,i[l]);else if(parseInt(n,10)===n)f=o.get(n),f?c(l,f):setTimeout(function(e,l){const t=o.get(l);t?c(e,t):p(0,"failed to find dependent cubemap asset="+l)}.bind(null,l,n));else{const s="string"==typeof n?{url:n,filename:n}:n;f=new a(e.name+"_part_"+l,"texture",s),o.add(f),o.once("load:"+f.id,d.bind(t,l)),o.once("error:"+f.id,p.bind(t,l)),o.load(f)}else d(l,null)}}}export{i as CubemapHandler};
