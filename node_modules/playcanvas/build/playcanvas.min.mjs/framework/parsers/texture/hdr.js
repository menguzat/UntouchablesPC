import{extends as r}from"../../../_virtual/_rollupPluginBabelHelpers.js";import"../../../core/debug.js";import{ReadStream as e}from"../../../core/read-stream.js";import{ADDRESS_REPEAT as t,ADDRESS_CLAMP_TO_EDGE as s,FILTER_NEAREST as n,PIXELFORMAT_RGBA8 as a,TEXTURETYPE_RGBE as i}from"../../../platform/graphics/constants.js";import{Texture as l}from"../../../platform/graphics/texture.js";import{Asset as o}from"../../asset/asset.js";class f{constructor(r){this.maxRetries=0}load(r,e,t){o.fetchArrayBuffer(r.load,e,t,this.maxRetries)}open(e,o,f,u={}){const d=this.parse(o);if(!d)return null;const p=new l(f,r({name:e,addressU:t,addressV:s,minFilter:n,magFilter:n,width:d.width,height:d.height,levels:d.levels,format:a,type:i,mipmaps:!1},u));return p.upload(),p}parse(r){const t=new e(r);if(!t.readLine().startsWith("#?RADIANCE"))return null;const s={};for(;;){const r=t.readLine();if(0===r.length)break;{const e=r.split("=");2===e.length&&(s[e[0]]=e[1])}}if(!s.hasOwnProperty("FORMAT"))return null;const n=t.readLine().split(" ");if(4!==n.length)return null;const a=parseInt(n[1],10),i=parseInt(n[3],10),l=this._readPixels(t,i,a,"-Y"===n[0]);return l?{width:i,height:a,levels:[l]}:null}_readPixels(r,e,t,s){if(e<8||e>32767)return this._readPixelsFlat(r,e,t);const n=[0,0,0,0];if(r.readArray(n),2!==n[0]||2!==n[1]||0!=(128&n[2]))return r.skip(-4),this._readPixelsFlat(r,e,t);const a=new ArrayBuffer(e*t*4),i=new Uint8Array(a);let l,o,f,u,d,p,h=s?0:4*e*(t-1);for(o=0;o<t;++o){if(o&&r.readArray(n),(n[2]<<8)+n[3]!==e)return null;for(u=0;u<4;++u)for(l=0;l<e;)if(d=r.readU8(),d>128){if(d-=128,l+d>e)return null;for(p=r.readU8(),f=0;f<d;++f)i[h+u+4*l++]=p}else{if(0===d||l+d>e)return null;for(f=0;f<d;++f)i[h+u+4*l++]=r.readU8()}h+=4*e*(s?1:-1)}return i}_readPixelsFlat(r,e,t){return r.remainingBytes===e*t*4?new Uint8Array(r.arraybuffer,r.offset):null}}export{f as HdrParser};
