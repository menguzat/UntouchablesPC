import"../../core/debug.js";import{math as e}from"../../core/math/math.js";import{PIXELFORMAT_RGBA8 as t,isCompressedPixelFormat as s,FILTER_LINEAR_MIPMAP_LINEAR as i,FILTER_LINEAR as h,ADDRESS_REPEAT as l,FUNC_LESS as r,TEXTURETYPE_DEFAULT as a,TEXTURETYPE_RGBM as n,TEXTURETYPE_SWIZZLEGGGR as _,TEXTUREPROJECTION_NONE as p,TEXTUREPROJECTION_CUBE as o,PIXELFORMAT_RGB16F as d,PIXELFORMAT_RGB32F as m,PIXELFORMAT_RGBA16F as u,PIXELFORMAT_RGBA32F as c,TEXTURETYPE_RGBP as g,TEXTURETYPE_RGBE as v,PIXELFORMAT_ETC1 as f,PIXELFORMAT_ETC2_RGB as w,PIXELFORMAT_PVRTC_2BPP_RGB_1 as y,PIXELFORMAT_PVRTC_2BPP_RGBA_1 as b,PIXELFORMAT_PVRTC_4BPP_RGB_1 as U,PIXELFORMAT_PVRTC_4BPP_RGBA_1 as F,PIXELFORMAT_DXT1 as A,PIXELFORMAT_ATC_RGB as M,PIXELFORMAT_ETC2_RGBA as k,PIXELFORMAT_DXT3 as x,PIXELFORMAT_DXT5 as O,PIXELFORMAT_ASTC_4x4 as j,PIXELFORMAT_ATC_RGBA as z,pixelFormatByteSizes as S,TEXTURELOCK_WRITE as R,PIXELFORMAT_RGB8 as V,PIXELFORMAT_RGBA4 as G,PIXELFORMAT_RGBA5551 as W,PIXELFORMAT_RGB565 as Y,PIXELFORMAT_LA8 as T,PIXELFORMAT_L8 as L,PIXELFORMAT_A8 as P}from"./constants.js";let C=null,I=0;class B{constructor(e,d={}){var m,u,c,g,v,f,w,y,b,U,F,A,M,k,x,O,j,z,S,R;(this.name=void 0,this._isRenderTarget=!1,this._gpuSize=0,this.id=I++,this._invalid=!1,this._lockedLevel=-1,this.device=e,this.name=null!=(m=d.name)?m:null,this._width=null!=(u=d.width)?u:4,this._height=null!=(c=d.height)?c:4,this._format=null!=(g=d.format)?g:t,this._compressed=s(this._format),e.webgl2)?(this._volume=null!=(S=d.volume)&&S,this._depth=null!=(R=d.depth)?R:1):(this._volume=!1,this._depth=1);this._cubemap=null!=(v=d.cubemap)&&v,this.fixCubemapSeams=null!=(f=d.fixCubemapSeams)&&f,this._flipY=null!=(w=d.flipY)&&w,this._premultiplyAlpha=null!=(y=d.premultiplyAlpha)&&y,this._mipmaps=null==(b=null!=(U=d.mipmaps)?U:d.autoMipmap)||b,this._minFilter=null!=(F=d.minFilter)?F:i,this._magFilter=null!=(A=d.magFilter)?A:h,this._anisotropy=null!=(M=d.anisotropy)?M:1,this._addressU=null!=(k=d.addressU)?k:l,this._addressV=null!=(x=d.addressV)?x:l,this._addressW=null!=(O=d.addressW)?O:l,this._compareOnRead=null!=(j=d.compareOnRead)&&j,this._compareFunc=null!=(z=d.compareFunc)?z:r,this.type=a,d.hasOwnProperty("type")?this.type=d.type:d.hasOwnProperty("rgbm")?this.type=d.rgbm?n:a:d.hasOwnProperty("swizzleGGGR")&&(this.type=d.swizzleGGGR?_:a),this.projection=p,this._cubemap?this.projection=o:d.projection&&d.projection!==o&&(this.projection=d.projection),this._levels=d.levels,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this.impl=e.createTextureImpl(this),e.textures.push(this)}destroy(){if(this.device){const e=this.device,t=e.textures.indexOf(this);-1!==t&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null}}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(e,t){e.tex+=t}get requiredMipLevels(){return this.mipmaps?Math.floor(Math.log2(Math.max(this.width,this.height)))+1:1}set minFilter(e){this._minFilter!==e&&(this._minFilter=e,this._parameterFlags|=1)}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&(this._magFilter=e,this._parameterFlags|=2)}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this._parameterFlags|=4)}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this._parameterFlags|=8)}get addressV(){return this._addressV}set addressW(e){this.device.webgl2&&this._volume&&e!==this._addressW&&(this._addressW=e,this._parameterFlags|=16)}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this._parameterFlags|=32)}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this._parameterFlags|=64)}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this._parameterFlags|=128)}get anisotropy(){return this._anisotropy}set mipmaps(e){this._mipmaps!==e&&(this._mipmaps=e,this.device.isWebGPU,e&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const e=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return B.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get volume(){return this._volume}set flipY(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return e.powerOfTwo(this._width)&&e.powerOfTwo(this._height)}get encoding(){switch(this.type){case n:return"rgbm";case v:return"rgbe";case g:return"rgbp";default:return this.format===d||this.format===m||this.format===u||this.format===c?"linear":"srgb"}}static calcGpuSize(e,t,s,i,h,l){var r;C||(C=[],C[f]=8,C[w]=8,C[y]=8,C[b]=8,C[U]=8,C[F]=8,C[A]=8,C[M]=8,C[k]=16,C[x]=16,C[O]=16,C[j]=16,C[z]=16);const a=null!=(r=S[i])?r:0,n=C.hasOwnProperty(i)?C[i]:0;let _=0;for(;;){if(a>0)_+=e*t*s*a;else{let h=Math.floor((e+3)/4);const l=Math.floor((t+3)/4),r=Math.floor((s+3)/4);i!==y&&i!==b||(h=Math.max(Math.floor(h/2),1)),_+=h*l*r*n}if(!h||1===e&&1===t&&1===s)break;e=Math.max(Math.floor(e/2),1),t=Math.max(Math.floor(t/2),1),s=Math.max(Math.floor(s/2),1)}return _*(l?6:1)}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255}lock(e={}){if(void 0===e.level&&(e.level=0),void 0===e.face&&(e.face=0),void 0===e.mode&&(e.mode=R),this._lockedLevel=e.level,null===this._levels[e.level])switch(this._format){case P:case L:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth);break;case T:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case Y:case W:case G:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth);break;case V:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case t:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case A:this._levels[e.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case x:case O:this._levels[e.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case d:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case m:this._levels[e.level]=new Float32Array(this._width*this._height*this._depth*3);break;case u:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case c:this._levels[e.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[e.level]}setSource(e,t=0){let s,i,h=!1;if(this._cubemap){if(e[0]){s=e[0].width||0,i=e[0].height||0;for(let t=0;t<6;t++){const l=e[t];if(!l||l.width!==s||l.height!==i||!this.device._isBrowserInterface(l)){h=!0;break}}}else h=!0;if(!h)for(let s=0;s<6;s++)this._levels[t][s]!==e[s]&&(this._levelsUpdated[t][s]=!0)}else this.device._isBrowserInterface(e)||(h=!0),h||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),s=e.width,i=e.height);if(h)if(this._width=4,this._height=4,this._cubemap)for(let e=0;e<6;e++)this._levels[t][e]=null,this._levelsUpdated[t][e]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else 0===t&&(this._width=s,this._height=i),this._levels[t]=e;this._invalid===h&&h||(this._invalid=h,this.upload())}getSource(e=0){return this._levels[e]}unlock(){this._lockedLevel,this.upload(),this._lockedLevel=-1}upload(){var e,t;this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,null==(e=(t=this.impl).uploadImmediate)||e.call(t,this.device,this)}getDds(){let e=128,t=0;for(;this._levels[t];){if(this.cubemap)for(let s=0;s<6;s++){if(!this._levels[t][s])return;const i=this._levels[t][s].length;if(!i)return;e+=i}else{const s=this._levels[t].length;if(!s)return;e+=s}e+=this._levels[t].length,t++}const s=new ArrayBuffer(e),i=new Uint32Array(s,0,32);let h=528391;this._levels.length>1&&(h|=131072);let l=4096;this._levels.length>1&&(l|=4194304),(this._levels.length>1||this.cubemap)&&(l|=8);const r=this.cubemap?65024:0;i[0]=542327876,i[1]=124,i[2]=h,i[3]=this.height,i[4]=this.width,i[5]=this.width*this.height*4,i[6]=0,i[7]=this._levels.length;for(let e=0;e<11;e++)i[8+e]=0;i[19]=32,i[20]=65,i[21]=0,i[22]=32,i[23]=16711680,i[24]=65280,i[25]=255,i[26]=4278190080,i[27]=l,i[28]=r,i[29]=0,i[30]=0,i[31]=0;let a=128;if(this.cubemap)for(let e=0;e<6;e++)for(let t=0;t<this._levels.length;t++){const i=this._levels[t][e],h=new Uint8Array(s,a,i.length);for(let e=0;e<i.length;e++)h[e]=i[e];a+=i.length}else for(let e=0;e<this._levels.length;e++){const t=this._levels[e],i=new Uint8Array(s,a,t.length);for(let e=0;e<t.length;e++)i[e]=t[e];a+=t.length}return s}}export{B as Texture};
